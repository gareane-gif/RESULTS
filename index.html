<!DOCTYPE html>
<html lang="ar" dir="rtl">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Ù…Ù†Ø¸ÙˆÙ…Ø© Ø§Ø³ØªØ¹Ù„Ø§Ù… Ù†ØªØ§Ø¦Ø¬ Ø§Ù„Ø·Ù„Ø§Ø¨ Ø§Ù„Ù…ØªÙƒØ§Ù…Ù„Ø©</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore-compat.js"></script>
    <!-- Temporarily disabled to fix login issue -->
    <!-- <script src="db-helper.js?v=2.5"></script> -->
    <meta http-equiv="Cache-Control" content="no-cache, no-store, must-revalidate">
    <meta http-equiv="Pragma" content="no-cache">
    <meta http-equiv="Expires" content="0">
    <style>
        :root {
            --bg-color: #0f172a;
            --card-bg: rgba(30, 41, 59, 0.7);
            --border-color: rgba(255, 255, 255, 0.1);
            --primary-color: #6366f1;
            --secondary-color: #a855f7;
            --text-color: #f8fafc;
            --text-muted: #94a3b8;
            --accent-color: #10b981;
            --danger-color: #ef4444;
            --warning-color: #f59e0b;
            --glass: blur(12px);
        }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Outfit', 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background-color: var(--bg-color);
            background-image:
                radial-gradient(at 0% 0%, rgba(99, 102, 241, 0.15) 0px, transparent 50%),
                radial-gradient(at 100% 100%, rgba(168, 85, 247, 0.15) 0px, transparent 50%);
            background-attachment: fixed;
            color: var(--text-color);
            line-height: 1.6;
            min-height: 100vh;
            direction: rtl;
        }

        .container {
            max-width: 1400px;
            margin: 0 auto;
            padding: 20px;
        }

        /* Login Styles */
        .login-container {
            height: 100vh;
            display: flex;
            align-items: center;
            justify-content: center;
            padding: 20px;
        }

        .login-box {
            width: 100%;
            max-width: 450px;
            text-align: center;
            background: var(--card-bg);
            backdrop-filter: var(--glass);
            border: 1px solid var(--border-color);
            border-radius: 24px;
            padding: 40px;
            box-shadow: 0 8px 32px rgba(0, 0, 0, 0.3);
        }

        .login-box h2 {
            color: var(--text-color);
            margin-bottom: 30px;
            font-size: 2rem;
            font-weight: 700;
        }

        .login-box input {
            width: 100%;
            padding: 14px 18px;
            margin: 10px 0;
            background: rgba(15, 23, 42, 0.6);
            border: 1px solid var(--border-color);
            border-radius: 12px;
            color: var(--text-color);
            font-size: 16px;
            outline: none;
            transition: all 0.3s ease;
        }

        .login-box input:focus {
            border-color: var(--primary-color);
            box-shadow: 0 0 0 3px rgba(99, 102, 241, 0.2);
        }

        .login-box button {
            width: 100%;
            padding: 14px;
            background: linear-gradient(135deg, var(--primary-color) 0%, #4f46e5 100%);
            color: white;
            border: none;
            border-radius: 12px;
            font-size: 1.1rem;
            font-weight: 700;
            cursor: pointer;
            margin-top: 25px;
            transition: all 0.3s;
        }

        .login-box button:hover {
            transform: translateY(-2px);
            filter: brightness(1.1);
            box-shadow: 0 4px 12px rgba(99, 102, 241, 0.3);
        }

        /* Main App Styles */
        .main-app {
            background: transparent;
        }

        .header {
            text-align: right;
            margin-bottom: 40px;
            padding-bottom: 25px;
            border-bottom: 1px solid var(--border-color);
        }

        .header-content {
            display: flex;
            align-items: center;
            justify-content: space-between;
            gap: 20px;
            margin-bottom: 20px;
        }

        .logo {
            width: 70px;
            height: 70px;
            border-radius: 15px;
            box-shadow: 0 8px 16px rgba(0, 0, 0, 0.2);
        }

        .header-text h1 {
            color: var(--text-color);
            font-size: 2rem;
            margin-bottom: 5px;
            font-weight: 800;
        }

        .header-text p {
            color: var(--text-muted);
            font-size: 1rem;
            margin: 0;
        }

        .header h1 {
            color: var(--text-color);
            font-size: 2.2rem;
            margin-bottom: 10px;
        }

        .tabs {
            display: flex;
            gap: 12px;
            margin-bottom: 30px;
            overflow-x: auto;
            padding-bottom: 10px;
            border-bottom: 1px solid var(--border-color);
        }

        .tab {
            padding: 12px 24px;
            background: var(--card-bg);
            border: 1px solid var(--border-color);
            border-radius: 14px;
            cursor: pointer;
            font-size: 1rem;
            color: var(--text-muted);
            transition: all 0.3s;
            white-space: nowrap;
            backdrop-filter: var(--glass);
        }

        .tab.active {
            background: var(--primary-color);
            color: white;
            border-color: var(--primary-color);
            box-shadow: 0 4px 12px rgba(99, 102, 241, 0.3);
        }

        .tab-content {
            display: none;
        }

        .tab-content.active {
            display: block;
            animation: fadeIn 0.4s ease;
        }

        @keyframes fadeIn {
            from {
                opacity: 0;
                transform: translateY(10px);
            }

            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        .form-section {
            background: var(--card-bg);
            backdrop-filter: var(--glass);
            border: 1px solid var(--border-color);
            padding: 25px;
            border-radius: 20px;
            margin-bottom: 30px;
        }

        .form-group {
            margin-bottom: 20px;
        }

        .form-group label {
            display: block;
            margin-bottom: 10px;
            font-weight: 600;
            color: var(--text-muted);
            font-size: 0.9rem;
        }

        .form-group input,
        .form-group select {
            width: 100%;
            padding: 12px 16px;
            background: rgba(15, 23, 42, 0.4);
            border: 1px solid var(--border-color);
            border-radius: 12px;
            color: var(--text-color);
            font-size: 15px;
            transition: all 0.3s;
        }

        .form-group input:focus,
        .form-group select:focus {
            outline: none;
            border-color: var(--primary-color);
            background: rgba(15, 23, 42, 0.6);
        }

        .form-row {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 20px;
        }

        button {
            padding: 12px 24px;
            border-radius: 12px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
            border: none;
            display: inline-flex;
            align-items: center;
            justify-content: center;
            gap: 10px;
            font-size: 0.95rem;
        }

        button.primary {
            background: linear-gradient(135deg, var(--primary-color) 0%, #4f46e5 100%);
            color: white;
        }

        button.secondary {
            background: linear-gradient(135deg, var(--secondary-color) 0%, #9333ea 100%);
            color: white;
        }

        button.warning {
            background: linear-gradient(135deg, var(--warning-color) 0%, #d97706 100%);
            color: white;
        }

        button.danger {
            background: linear-gradient(135deg, var(--danger-color) 0%, #dc2626 100%);
            color: white;
        }

        button:hover {
            transform: translateY(-2px);
            filter: brightness(1.1);
            box-shadow: 0 4px 15px rgba(0, 0, 0, 0.3);
        }

        button:active {
            transform: translateY(0);
        }

        .student-list {
            display: grid;
            gap: 20px;
            margin: 20px 0;
        }

        .students-grid {
            display: grid;
            gap: 20px;
            margin: 20px 0;
        }

        .student-card {
            background: var(--card-bg);
            backdrop-filter: var(--glass);
            border: 1px solid var(--border-color);
            border-radius: 20px;
            padding: 25px;
            transition: all 0.3s ease;
        }

        .student-card:hover {
            transform: translateY(-5px);
            border-color: rgba(99, 102, 241, 0.4);
            box-shadow: 0 8px 24px rgba(0, 0, 0, 0.2);
        }

        .student-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
            padding-bottom: 15px;
            border-bottom: 1px solid var(--border-color);
        }

        .student-info {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(180px, 1fr));
            gap: 15px;
            margin-bottom: 20px;
        }

        .student-info div {
            padding: 12px;
            background: rgba(15, 23, 42, 0.4);
            border-radius: 12px;
            font-size: 0.9rem;
            color: var(--text-color);
            border: 1px solid var(--border-color);
        }

        .grades-table-container {
            overflow-x: auto;
            border-radius: 16px;
            border: 1px solid var(--border-color);
            background: rgba(15, 23, 42, 0.2);
        }

        .grades-table {
            width: 100%;
            border-collapse: collapse;
        }

        .grades-table th {
            background: rgba(99, 102, 241, 0.1);
            color: var(--primary-color);
            padding: 12px;
            text-align: center;
            font-weight: 600;
            border-bottom: 1px solid var(--border-color);
        }

        .grades-table td {
            padding: 12px;
            text-align: center;
            border-bottom: 1px solid var(--border-color);
            color: var(--text-color);
        }

        .search-section {
            background: var(--card-bg);
            backdrop-filter: var(--glass);
            border: 1px solid var(--border-color);
            padding: 30px;
            border-radius: 20px;
            margin-bottom: 30px;
            text-align: center;
        }

        .search-input {
            display: flex;
            gap: 15px;
            max-width: 600px;
            margin: 20px auto;
        }

        .search-input input {
            flex: 1;
            padding: 14px 20px;
            background: rgba(15, 23, 42, 0.4);
            border: 1px solid var(--border-color);
            border-radius: 12px;
            color: var(--text-color);
            font-size: 16px;
            outline: none;
            transition: all 0.3s;
        }

        .search-input input:focus {
            border-color: var(--primary-color);
            background: rgba(15, 23, 42, 0.6);
            box-shadow: 0 0 0 3px rgba(99, 102, 241, 0.2);
        }

        .search-input button {
            padding: 14px 28px;
            background: linear-gradient(135deg, var(--primary-color) 0%, #4f46e5 100%);
            color: white;
            border-radius: 12px;
            font-weight: 700;
            box-shadow: 0 4px 12px rgba(99, 102, 241, 0.2);
        }

        .search-input button:hover {
            transform: translateY(-2px);
            filter: brightness(1.1);
            box-shadow: 0 6px 16px rgba(99, 102, 241, 0.3);
        }

        /* Mobile Responsive Search Styles */
        .search-input-mobile {
            max-width: 100%;
            margin: 20px 0;
        }

        .search-input-group {
            display: flex;
            gap: 10px;
            margin-bottom: 15px;
            flex-wrap: wrap;
        }

        .search-input-field {
            flex: 1;
            min-width: 200px;
            padding: 15px;
            border: 2px solid #e1e5e9;
            border-radius: 10px;
            font-size: 16px;
            box-shadow: 0 2px 10px rgba(0, 0, 0, 0.1);
            transition: border-color 0.3s;
        }

        .search-input-field:focus {
            outline: none;
            border-color: #667eea;
        }

        .search-button {
            display: flex;
            align-items: center;
            gap: 8px;
            padding: 15px 20px;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            border: none;
            border-radius: 10px;
            cursor: pointer;
            font-weight: bold;
            transition: all 0.3s;
            white-space: nowrap;
        }

        .search-button:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(102, 126, 234, 0.4);
        }

        .search-icon {
            font-size: 18px;
        }

        .search-text {
            font-size: 16px;
        }

        .quick-search-buttons {
            display: flex;
            gap: 10px;
            flex-wrap: wrap;
            justify-content: center;
            margin-top: 10px;
        }

        .quick-btn {
            padding: 10px 20px;
            background: rgba(15, 23, 42, 0.4);
            border: 1px solid var(--border-color);
            border-radius: 10px;
            color: var(--text-color);
            font-weight: 600;
        }

        .quick-btn:hover {
            background: rgba(99, 102, 241, 0.1);
            border-color: var(--primary-color);
        }

        .clear-btn {
            background: rgba(239, 68, 68, 0.1) !important;
            border-color: var(--danger-color) !important;
            color: var(--danger-color) !important;
        }

        .clear-btn:hover {
            background: var(--danger-color) !important;
            color: white !important;
        }

        .search-results {
            margin-top: 20px;
            min-height: 50px;
        }

        .student-result-display {
            margin-top: 25px;
            background: var(--card-bg);
            backdrop-filter: var(--glass);
            border: 1px solid var(--border-color);
            border-radius: 20px;
            padding: 25px;
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.2);
        }

        /* Mobile Responsive Design */
        @media (max-width: 768px) {
            .search-input-group {
                flex-direction: column;
                gap: 10px;
            }

            .search-input-field {
                min-width: 100%;
                font-size: 16px;
                /* Prevent zoom on iOS */
            }

            .search-button {
                width: 100%;
                justify-content: center;
                padding: 15px;
            }

            .quick-search-buttons {
                justify-content: stretch;
            }

            .quick-btn {
                flex: 1;
                min-width: 80px;
                padding: 12px 8px;
                font-size: 12px;
            }

            .search-results {
                margin-top: 15px;
            }

            .student-result-display {
                margin-top: 15px;
                border-radius: 10px;
            }

            .students-grid {
                gap: 15px;
                margin: 15px 0;
            }

            .student-card {
                background: var(--card-bg);
                backdrop-filter: var(--glass);
                border: 1px solid var(--border-color);
                border-radius: 20px;
                padding: 25px;
                transition: all 0.3s ease;
            }

            .student-card:hover {
                transform: translateY(-5px);
                border-color: rgba(99, 102, 241, 0.4);
                box-shadow: 0 8px 24px rgba(0, 0, 0, 0.2);
            }
        }

        @media (max-width: 480px) {
            .search-input-mobile {
                margin: 15px 0;
            }

            .search-input-field {
                padding: 12px;
                font-size: 16px;
            }

            .search-button {
                padding: 12px;
                font-size: 14px;
            }

            .quick-btn {
                padding: 10px 6px;
                font-size: 11px;
            }

            .quick-search-buttons {
                gap: 8px;
            }

            .students-grid {
                gap: 15px;
                margin: 15px 0;
            }

            .student-card {
                background: var(--card-bg);
                backdrop-filter: var(--glass);
                border: 1px solid var(--border-color);
                border-radius: 20px;
                padding: 25px;
                transition: all 0.3s ease;
            }

            .student-card:hover {
                transform: translateY(-5px);
                border-color: rgba(99, 102, 241, 0.4);
                box-shadow: 0 8px 24px rgba(0, 0, 0, 0.2);
            }
        }

        .no-results {
            text-align: center;
            padding: 40px;
            background: var(--card-bg);
            backdrop-filter: var(--glass);
            border: 1px solid var(--border-color);
            border-radius: 20px;
            color: var(--text-muted);
        }

        .status-message {
            padding: 12px 20px;
            margin: 15px 0;
            border-radius: 12px;
            text-align: center;
            font-weight: 600;
        }

        .status-message.info {
            background: rgba(99, 102, 241, 0.2);
            border: 1px solid var(--primary-color);
            color: var(--primary-color);
        }

        .status-message.success {
            background: rgba(16, 185, 129, 0.1);
            color: var(--accent-color);
            border: 1px solid var(--accent-color);
        }

        .status-message.error {
            background: rgba(239, 68, 68, 0.1);
            color: var(--danger-color);
            border: 1px solid var(--danger-color);
        }

        .subject-input {
            display: grid;
            grid-template-columns: 2fr 1fr 1fr 1fr 1fr 1fr auto;
            gap: 10px;
            align-items: center;
            margin-bottom: 10px;
        }

        .subject-input input,
        .subject-input select {
            padding: 8px;
        }

        .subject-input select {
            padding: 8px;
            border: 1px solid var(--border-color);
            border-radius: 5px;
            background: rgba(15, 23, 42, 0.4);
            color: var(--text-color);
        }

        .remove-subject {
            background: linear-gradient(135deg, var(--danger-color) 0%, #dc2626 100%);
            color: white;
            border: none;
            padding: 8px 15px;
            border-radius: 8px;
            cursor: pointer;
            font-weight: 600;
        }

        .admin-settings {
            background: rgba(245, 158, 11, 0.1);
            backdrop-filter: var(--glass);
            padding: 25px;
            border-radius: 20px;
            margin: 20px 0;
            border: 1px solid var(--warning-color);
        }

        .admin-settings h3 {
            color: var(--warning-color);
            margin-bottom: 20px;
            font-weight: 700;
        }

        .toggle-switch {
            display: flex;
            align-items: center;
            gap: 10px;
            margin: 10px 0;
        }

        .toggle-switch input[type="checkbox"] {
            width: 50px;
            height: 25px;
            appearance: none;
            background: #ccc;
            border-radius: 25px;
            position: relative;
            cursor: pointer;
            transition: background 0.3s;
        }

        .toggle-switch input[type="checkbox"]:checked {
            background: #28a745;
        }

        .toggle-switch input[type="checkbox"]::before {
            content: '';
            position: absolute;
            width: 21px;
            height: 21px;
            border-radius: 50%;
            background: white;
            top: 2px;
            left: 2px;
            transition: transform 0.3s;
        }

        .toggle-switch input[type="checkbox"]:checked::before {
            transform: translateX(25px);
        }

        .warning-text {
            color: #dc3545;
            font-size: 14px;
            margin-top: 5px;
        }

        /* Grade colors - REMOVED DUPLICATE */

        .subject-selector {
            background: rgba(15, 23, 42, 0.4);
            padding: 20px;
            border-radius: 16px;
            margin-bottom: 20px;
            border: 1px solid var(--border-color);
        }

        .subject-selector h4 {
            margin-top: 0;
            color: var(--primary-color);
            margin-bottom: 15px;
            font-weight: 700;
        }

        .semester-selector {
            display: flex;
            gap: 10px;
            margin-bottom: 15px;
        }

        .semester-selector button {
            padding: 10px 18px;
            border: 1px solid var(--border-color);
            background: rgba(15, 23, 42, 0.4);
            color: var(--text-color);
            border-radius: 10px;
            cursor: pointer;
            transition: all 0.3s;
        }

        .semester-selector button.active {
            background: #007bff;
            color: white;
        }

        .subjects-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(200px, 1fr));
            gap: 10px;
            max-height: 300px;
            overflow-y: auto;
        }

        .subject-item {
            padding: 12px;
            border: 1px solid var(--border-color);
            border-radius: 10px;
            background: rgba(15, 23, 42, 0.4);
            cursor: pointer;
            transition: all 0.3s;
            color: var(--text-color);
        }

        .subject-item:hover {
            background: rgba(99, 102, 241, 0.1);
            border-color: var(--primary-color);
        }

        .subject-item.selected {
            background: linear-gradient(135deg, var(--primary-color) 0%, #4f46e5 100%);
            color: white;
            border-color: var(--primary-color);
        }

        .subject-item.failed {
            background: linear-gradient(135deg, var(--danger-color) 0%, #dc2626 100%);
            color: white;
            border-color: var(--danger-color);
        }

        .subject-item.failed::after {
            content: " (Ù…Ø·Ø§Ù„Ø¨)";
            font-size: 0.9em;
        }

        .edit-subjects-btn {
            background: linear-gradient(135deg, var(--accent-color) 0%, #059669 100%);
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 10px;
            cursor: pointer;
            margin-top: 15px;
            font-size: 0.9rem;
            font-weight: 700;
        }

        .edit-subjects-btn:hover {
            filter: brightness(1.1);
            transform: translateY(-2px);
        }

        .subject-editor {
            background: rgba(15, 23, 42, 0.4);
            padding: 20px;
            border-radius: 16px;
            margin-top: 20px;
            border: 1px solid var(--border-color);
            display: none;
        }

        .subject-editor.active {
            display: block;
        }

        .subject-editor h4 {
            margin-top: 0;
            color: var(--primary-color);
            margin-bottom: 15px;
            font-weight: 700;
        }

        .subject-list-editor {
            max-height: 300px;
            overflow-y: auto;
        }

        .subject-editor-item {
            display: flex;
            align-items: center;
            gap: 15px;
            margin-bottom: 12px;
            padding: 15px;
            background: rgba(15, 23, 42, 0.4);
            border-radius: 12px;
            border: 1px solid var(--border-color);
        }

        .subject-editor-item input {
            flex: 1;
            padding: 10px;
            background: rgba(15, 23, 42, 0.6);
            border: 1px solid var(--border-color);
            border-radius: 8px;
            color: var(--text-color);
        }

        .subject-editor-item input[type="number"] {
            width: 80px;
        }

        .subject-editor-item button {
            background: #dc3545;
            color: white;
            border: none;
            padding: 5px 10px;
            border-radius: 3px;
            cursor: pointer;
        }

        .add-subject-btn {
            background: #007bff;
            color: white;
            border: none;
            padding: 8px 16px;
            border-radius: 5px;
            cursor: pointer;
            margin-top: 10px;
        }

        .add-subject-btn:hover {
            background: #0056b3;
        }

        .modal-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.5);
            display: flex;
            justify-content: center;
            align-items: center;
            z-index: 1000;
        }

        .modal-content {
            background: #1e293b;
            backdrop-filter: var(--glass);
            padding: 35px;
            border-radius: 24px;
            border: 1px solid var(--border-color);
            max-width: 550px;
            width: 90%;
            max-height: 85vh;
            overflow-y: auto;
            box-shadow: 0 20px 50px rgba(0, 0, 0, 0.5);
            color: var(--text-color);
        }

        .modal-content h3 {
            margin-top: 0;
            color: var(--text-color);
            text-align: center;
            font-size: 1.5rem;
            margin-bottom: 25px;
            font-weight: 700;
        }

        .failed-subjects-list {
            max-height: 300px;
            overflow-y: auto;
            margin: 20px 0;
            padding: 10px;
            background: rgba(15, 23, 42, 0.4);
            border-radius: 5px;
            border: 1px solid var(--border-color);
        }

        .failed-subject-item {
            display: flex;
            align-items: center;
            padding: 12px;
            margin-bottom: 10px;
            background: rgba(15, 23, 42, 0.4);
            border-radius: 10px;
            border: 1px solid var(--border-color);
            transition: all 0.3s;
        }

        .failed-subject-item:hover {
            background: rgba(99, 102, 241, 0.1);
            border-color: var(--primary-color);
        }

        .failed-subject-item input[type="checkbox"] {
            margin-left: 10px;
            width: 18px;
            height: 18px;
        }

        .failed-subject-item label {
            flex: 1;
            cursor: pointer;
            font-size: 14px;
        }

        .modal-buttons {
            display: flex;
            gap: 10px;
            justify-content: center;
            margin-top: 20px;
        }

        .status-message {
            position: fixed;
            top: 20px;
            right: 20px;
            padding: 15px 20px;
            border-radius: 5px;
            color: white;
            font-weight: bold;
            z-index: 1001;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.3);
            opacity: 0;
            transform: translateX(100%);
            transition: all 0.3s ease;
        }

        .status-message.show {
            opacity: 1;
            transform: translateX(0);
        }

        .status-message.success {
            background: #28a745;
        }

        .status-message.error {
            background: #dc3545;
        }

        .status-message.warning {
            background: #ffc107;
            color: #333;
        }

        .student-result {
            background: var(--card-bg);
            backdrop-filter: var(--glass);
            border: 1px solid var(--primary-color);
            padding: 30px;
            border-radius: 24px;
            margin: 25px 0;
            box-shadow: 0 15px 40px rgba(0, 0, 0, 0.4);
        }

        .student-result h3 {
            margin-top: 0;
            color: var(--primary-color);
            text-align: center;
            font-size: 1.8rem;
            font-weight: 800;
            margin-bottom: 25px;
        }

        .result-info {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 15px;
            margin-bottom: 20px;
        }

        .result-item {
            background: rgba(15, 23, 42, 0.4);
            padding: 18px;
            border-radius: 14px;
            border: 1px solid var(--border-color);
            text-align: center;
            transition: all 0.3s ease;
        }

        .result-item:hover {
            transform: translateY(-3px);
            background: rgba(15, 23, 42, 0.6);
            border-color: var(--primary-color);
        }

        .result-item label {
            display: block;
            font-weight: 600;
            color: var(--text-muted);
            margin-bottom: 8px;
            font-size: 0.85rem;
        }

        .result-item span {
            display: block;
            font-size: 1.1rem;
            color: var(--text-color);
            font-weight: 700;
        }

        .grades-table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 25px;
            background: rgba(15, 23, 42, 0.2);
            border-radius: 16px;
            overflow: hidden;
            border: 1px solid var(--border-color);
        }

        .grades-table th {
            background: rgba(99, 102, 241, 0.1);
            color: var(--primary-color);
            padding: 15px 12px;
            text-align: center;
            font-weight: 700;
            font-size: 0.9rem;
            border-bottom: 1px solid var(--border-color);
        }

        .grades-table td {
            padding: 14px 10px;
            text-align: center;
            border-bottom: 1px solid var(--border-color);
            font-size: 0.9rem;
            color: var(--text-color);
        }

        .grades-table tr:nth-child(even) {
            background: rgba(255, 255, 255, 0.02);
        }

        .grades-table tr:hover {
            background: rgba(99, 102, 241, 0.05);
        }

        .grades-table .subject-name {
            font-weight: 700;
            color: var(--text-color);
            text-align: right;
        }

        .grades-table .units-cell {
            color: var(--primary-color);
            font-weight: 700;
        }

        .grades-table .classwork-cell {
            color: var(--secondary-color);
        }

        .grades-table .final-cell {
            color: var(--accent-color);
        }

        .grades-table .total-cell {
            font-weight: 800;
            color: var(--primary-color);
        }

        .grades-table .evaluation-cell {
            font-weight: 700;
            color: var(--warning-color);
        }

        .grades-table .status-cell {
            font-weight: bold;
            border-radius: 20px;
            padding: 8px 12px;
            display: inline-block;
            margin: 2px;
        }

        .grades-table .status-pass {
            background: linear-gradient(135deg, #4caf50, #66bb6a);
            color: white;
            text-shadow: 0 1px 2px rgba(0, 0, 0, 0.3);
        }

        .grades-table .status-fail {
            background: linear-gradient(135deg, #f44336, #ef5350);
            color: white;
            text-shadow: 0 1px 2px rgba(0, 0, 0, 0.3);
        }

        .grade-excellent {
            background: linear-gradient(135deg, #28a745, #20c997) !important;
            color: white !important;
            font-weight: bold;
            text-shadow: 0 1px 2px rgba(0, 0, 0, 0.3);
            border: 2px solid #1e7e34;
        }

        .grade-very-good {
            background: linear-gradient(135deg, #007bff, #6610f2) !important;
            color: white !important;
            font-weight: bold;
            text-shadow: 0 1px 2px rgba(0, 0, 0, 0.3);
            border: 2px solid #0056b3;
        }

        .grade-good {
            background: linear-gradient(135deg, #ffc107, #fd7e14) !important;
            color: #212529 !important;
            font-weight: bold;
            text-shadow: 0 1px 2px rgba(255, 255, 255, 0.5);
            border: 2px solid #e0a800;
        }

        .grade-acceptable {
            background: linear-gradient(135deg, #fd7e14, #dc3545) !important;
            color: white !important;
            font-weight: bold;
            text-shadow: 0 1px 2px rgba(0, 0, 0, 0.3);
            border: 2px solid #dc3545;
        }

        .grade-weak {
            background: linear-gradient(135deg, #dc3545, #6f42c1) !important;
            color: white !important;
            font-weight: bold;
            text-shadow: 0 1px 2px rgba(0, 0, 0, 0.3);
            border: 2px solid #c82333;
        }

        .total-row {
            background: linear-gradient(135deg, #007bff, #0056b3) !important;
            color: white !important;
            font-weight: bold;
            font-size: 14px;
            text-shadow: 0 1px 2px rgba(0, 0, 0, 0.3);
            border: 2px solid #0056b3;
        }

        .total-row td {
            border: 1px solid #0056b3;
            padding: 15px 8px;
        }

        .failed-subject {
            background: linear-gradient(135deg, #dc3545, #c82333) !important;
            color: white !important;
            font-weight: bold;
            text-shadow: 0 1px 2px rgba(0, 0, 0, 0.3);
            border: 2px solid #bd2130;
        }

        .failed-subject td {
            border-color: #c82333 !important;
        }

        .print-btn {
            background: #28a745;
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 5px;
            cursor: pointer;
            margin-top: 15px;
            font-size: 16px;
        }

        .status-passed {
            background: linear-gradient(135deg, #28a745, #20c997) !important;
            color: white !important;
            font-weight: bold;
            text-shadow: 0 1px 2px rgba(0, 0, 0, 0.3);
            border: 2px solid #1e7e34;
            padding: 8px 12px;
            border-radius: 20px;
            display: inline-block;
            font-size: 14px;
        }

        .status-failed {
            background: linear-gradient(135deg, #dc3545, #c82333) !important;
            color: white !important;
            font-weight: bold;
            text-shadow: 0 1px 2px rgba(0, 0, 0, 0.3);
            border: 2px solid #bd2130;
            padding: 8px 12px;
            border-radius: 20px;
            display: inline-block;
            font-size: 14px;
        }

        .print-btn:hover {
            background: #218838;
        }

        .excel-section {
            background: rgba(99, 102, 241, 0.05);
            padding: 25px;
            border-radius: 20px;
            margin: 25px 0;
            border: 1px solid var(--border-color);
        }

        .excel-buttons {
            display: flex;
            gap: 10px;
            flex-wrap: wrap;
        }

        .file-upload {
            background: rgba(16, 185, 129, 0.05);
            padding: 30px;
            border-radius: 20px;
            margin: 25px 0;
            text-align: center;
            border: 2px dashed var(--accent-color);
        }

        .file-upload input {
            margin: 10px;
        }

        /* Modern Student Portal Styles (Dark Theme) */
        .student-portal {
            --portal-bg: #0f172a;
            --portal-card: rgba(30, 41, 59, 0.7);
            --portal-border: rgba(255, 255, 255, 0.1);
            --portal-primary: #6366f1;
            --portal-secondary: #a855f7;
            --portal-text: #f8fafc;
            --portal-text-muted: #94a3b8;
            --portal-accent: #10b981;
            --portal-danger: #ef4444;

            background-color: var(--portal-bg);
            background-image:
                radial-gradient(at 0% 0%, rgba(99, 102, 241, 0.15) 0px, transparent 50%),
                radial-gradient(at 100% 100%, rgba(168, 85, 247, 0.15) 0px, transparent 50%);
            min-height: 100vh;
            color: var(--portal-text);
            padding: 2rem 1rem;
            font-family: 'Outfit', 'Segoe UI', Tahoma, sans-serif;
        }

        .portal-container {
            max-width: 1000px;
            margin: 0 auto;
        }

        .portal-header {
            text-align: center;
            padding: 3rem 2rem;
            background: var(--portal-card);
            backdrop-filter: blur(12px);
            border: 1px solid var(--portal-border);
            border-radius: 24px;
            margin-bottom: 2rem;
            box-shadow: 0 8px 32px rgba(0, 0, 0, 0.3);
        }

        .portal-header h1 {
            font-size: 2.5rem;
            background: linear-gradient(135deg, #fff 0%, #818cf8 100%);
            -webkit-background-clip: text;
            background-clip: text;
            -webkit-text-fill-color: transparent;
            margin-bottom: 0.5rem;
        }

        .portal-info-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 1.5rem;
            margin-bottom: 2rem;
        }

        .portal-info-card {
            background: var(--portal-card);
            backdrop-filter: blur(8px);
            padding: 1.5rem;
            border-radius: 20px;
            border: 1px solid var(--portal-border);
            border-right: 4px solid var(--portal-primary);
            transition: transform 0.3s ease;
        }

        .portal-info-card:hover {
            transform: translateY(-5px);
        }

        .portal-info-card strong {
            display: block;
            color: var(--portal-text-muted);
            font-size: 0.85rem;
            margin-bottom: 0.5rem;
        }

        .portal-info-card p {
            font-size: 1.25rem;
            font-weight: 700;
            margin: 0;
        }

        .portal-table-container {
            background: var(--portal-card);
            backdrop-filter: blur(12px);
            border-radius: 24px;
            border: 1px solid var(--portal-border);
            overflow-x: auto;
            box-shadow: 0 4px 24px rgba(0, 0, 0, 0.2);
        }

        .portal-table {
            width: 100%;
            border-collapse: collapse;
            min-width: 600px;
        }

        .portal-table th {
            background: rgba(99, 102, 241, 0.1);
            color: #818cf8;
            padding: 1.2rem;
            font-weight: 600;
            border-bottom: 2px solid var(--portal-border);
            text-align: center;
        }

        .portal-table td {
            padding: 1.2rem;
            border-bottom: 1px solid var(--portal-border);
            text-align: center;
        }

        .portal-table tr:hover td {
            background: rgba(255, 255, 255, 0.03);
        }

        .portal-badge {
            padding: 0.4rem 1rem;
            border-radius: 12px;
            font-weight: 700;
            font-size: 0.9rem;
        }

        .portal-badge-passed {
            background: rgba(16, 185, 129, 0.2);
            color: #34d399;
        }

        .portal-badge-failed {
            background: rgba(239, 68, 68, 0.2);
            color: #f87171;
        }

        .logout-btn-portal {
            background: linear-gradient(135deg, #ef4444 0%, #dc2626 100%);
            color: white;
            border: none;
            padding: 0.8rem 2rem;
            border-radius: 12px;
            font-weight: 700;
            cursor: pointer;
            margin-top: 1rem;
            transition: all 0.3s ease;
        }

        .logout-btn-portal:hover {
            transform: scale(1.05);
            filter: brightness(1.1);
        }
    </style>
</head>

<body>
    <!-- Login Screen -->
    <div id="loginScreen" class="login-container">
        <div class="glass-card login-box">
            <h1>ğŸ“ ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¯Ø®ÙˆÙ„ <span
                    style="font-size: 0.8rem; background: var(--primary-color); padding: 2px 8px; border-radius: 12px; vertical-align: middle;">v2.5
                    (Ù…Ø­Ø¯Ø«)</span></h1>
            <p style="color: var(--text-muted); margin-bottom: 30px;">Ø§Ù„Ù…Ø¹Ù‡Ø¯ Ø§Ù„Ø¹Ø§Ù„ÙŠ Ù„Ù„Ø¹Ù„ÙˆÙ… ÙˆØ§Ù„ØªÙ‚Ù†ÙŠØ© Ø§Ù„Ø¬ÙØ±Ø© Ø¨Ø³ÙˆÙƒÙ†Ø©</p>
            <div style="text-align: right; margin-bottom: 20px;">
                <label style="display: block; margin-bottom: 8px; color: var(--text-muted);">Ø§Ø³Ù… Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…</label>
                <input type="text" id="username" placeholder="Ù…Ø«Ø§Ù„: student Ø£Ùˆ Ø§Ù„Ø¨Ø±ÙŠØ¯ Ø§Ù„Ø¥Ù„ÙƒØªØ±ÙˆÙ†ÙŠ">
                <small style="color: var(--primary-light); display: none;" id="defaultLoginHint">
                    Ù„Ø£ÙˆÙ„ Ù…Ø±Ø©ØŸ Ø¬Ø±Ø¨: admin@institute.edu
                </small>
            </div>
            <div style="text-align: right; margin-bottom: 30px;">
                <label style="display: block; margin-bottom: 8px; color: var(--text-muted);">ÙƒÙ„Ù…Ø© Ø§Ù„Ù…Ø±ÙˆØ±</label>
                <input type="password" id="password" placeholder="Ø£Ø¯Ø®Ù„ ÙƒÙ„Ù…Ø© Ø§Ù„Ù…Ø±ÙˆØ±">
            </div>
            <button onclick="login()" class="primary" style="width: 100%; padding: 16px;">Ø¯Ø®ÙˆÙ„ Ù„Ù„Ù…Ù†Ø¸ÙˆÙ…Ø©</button>

            <div style="margin-top: 20px; border-top: 1px solid rgba(255,255,255,0.1); padding-top: 15px;">
                <p style="margin-bottom: 10px; font-size: 0.9rem; color: var(--text-muted);">Ù‡Ù„ Ø£Ù†Øª Ø·Ø§Ù„Ø¨ ÙˆØªØ±ÙŠØ¯ Ù…Ø¹Ø±ÙØ©
                    Ù†ØªÙŠØ¬ØªÙƒØŸ</p>
                <a href="student_search.html" style="display: block; text-decoration: none;">
                    <button class="secondary"
                        style="width: 100%; padding: 14px; background: linear-gradient(135deg, #10b981, #059669);">
                        ğŸ” Ø§Ù„Ø§Ù†ØªÙ‚Ø§Ù„ Ø¥Ù„Ù‰ ØµÙØ­Ø© Ø§Ù„Ø¨Ø­Ø« Ø¹Ù† Ø§Ù„Ù†ØªØ§Ø¦Ø¬
                    </button>
                </a>
            </div>
        </div>
    </div>

    <!-- Modern Student Portal View -->
    <div id="studentView" style="display: none;">
        <div class="student-portal">
            <div class="portal-container">
                <header class="portal-header">
                    <h1>ğŸ“ Ø¨ÙˆØ§Ø¨Ø© Ù†ØªØ§Ø¦Ø¬ Ø§Ù„Ø·Ù„Ø§Ø¨</h1>
                    <p style="color: var(--portal-text-muted);">Ø§Ù„Ù…Ø¹Ù‡Ø¯ Ø§Ù„Ø¹Ø§Ù„ÙŠ Ù„Ù„Ø¹Ù„ÙˆÙ… ÙˆØ§Ù„ØªÙ‚Ù†ÙŠØ© Ø§Ù„Ø¬ÙØ±Ø© Ø¨Ø³ÙˆÙƒÙ†Ø©</p>
                    <button onclick="logout()" class="logout-btn-portal">ØªØ³Ø¬ÙŠÙ„ Ø®Ø±ÙˆØ¬</button>
                </header>

                <div id="studentResultContainer">
                    <!-- Dynamic content injected here -->
                </div>
            </div>
        </div>
    </div>

    <!-- Main App -->
    <div id="mainApp" class="container" style="display: none;">
        <div class="main-app">
            <div class="header">
                <div class="header-content">
                    <div class="header-text">
                        <h1>ğŸ“ Ù…Ù†Ø¸ÙˆÙ…Ø© Ø§Ø³ØªØ¹Ù„Ø§Ù… Ù†ØªØ§Ø¦Ø¬ Ø§Ù„Ø·Ù„Ø§Ø¨ Ø§Ù„Ù…ØªÙƒØ§Ù…Ù„Ø©</h1>
                        <p>Ø§Ù„Ù…Ø¹Ù‡Ø¯ Ø§Ù„Ø¹Ø§Ù„ÙŠ Ù„Ù„Ø¹Ù„ÙˆÙ… ÙˆØ§Ù„ØªÙ‚Ù†ÙŠØ© Ø§Ù„Ø¬ÙØ±Ø© Ø¨Ø³ÙˆÙƒÙ†Ø©</p>
                    </div>
                </div>
                <div style="float: left; display: flex; gap: 10px; align-items: center;">
                    <button onclick="logout()" class="danger">ØªØ³Ø¬ÙŠÙ„ Ø®Ø±ÙˆØ¬</button>
                </div>
            </div>

            <div class="tabs">
                <button class="tab active" onclick="showTab('add-student')">Ø¥Ø¶Ø§ÙØ© Ø·Ø§Ù„Ø¨</button>
                <button class="tab" onclick="showTab('list')">ğŸ“‹ Ù‚Ø§Ø¦Ù…Ø© Ø§Ù„Ø·Ù„Ø§Ø¨</button>
                <button class="tab" onclick="showTab('search-student')">ğŸ” Ø¨Ø­Ø« Ø·Ø§Ù„Ø¨</button>
                <button class="tab" onclick="showTab('block-student')">ğŸš« Ø­Ø¬Ø¨ Ù†ØªÙŠØ¬Ø©</button>
                <button class="tab" onclick="showTab('print-all')">ğŸ–¨ï¸ Ø·Ø¨Ø§Ø¹Ø© Ø§Ù„ÙƒÙ„</button>
                <button class="tab" onclick="showTab('excel')">Ø§Ø³ØªÙŠØ±Ø§Ø¯ ÙˆØªØµØ¯ÙŠØ± Excel</button>
                <button class="tab" onclick="showTab('settings')">âš™ï¸ Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª Ø§Ù„Ù…Ø¯ÙŠØ±</button>
            </div>

            <!-- Add Student Tab -->
            <div id="add-student" class="tab-content active">
                <div class="form-section">
                    <h3>Ù…Ø¹Ù„ÙˆÙ…Ø§Øª Ø§Ù„Ø·Ø§Ù„Ø¨ Ø§Ù„Ø£Ø³Ø§Ø³ÙŠØ©</h3>
                    <div class="form-row">
                        <div class="form-group">
                            <label>Ø§Ù„Ø±Ù‚Ù… Ø§Ù„Ø¯Ø±Ø§Ø³ÙŠ</label>
                            <input type="text" id="studentId" placeholder="Ù…Ø«Ø§Ù„: SE242001"
                                onchange="autoLoadSubjectsFromId()">
                            <small style="color: #666; font-size: 12px;">
                                SE=Ù…Ø³Ø§Ø­Ø©, AC=ØªÙ…ÙˆÙŠÙ„, CO=Ø­Ø§Ø³ÙˆØ¨, RE=Ø·Ø§Ù‚Ø©, EL=ÙƒÙ‡Ø±Ø¨Ø§Ø¡, ME=Ù…ÙŠÙƒØ§Ù†ÙŠÙƒØ§<br>
                                Ø§Ù„Ø±Ù‚Ù…ÙŠÙ† Ø§Ù„ØªØ§Ù„ÙŠÙŠÙ†: Ø³Ù†Ø© Ø§Ù„ØªØ³Ø¬ÙŠÙ„ | Ø§Ù„Ø±Ù‚Ù… Ø§Ù„Ø«Ø§Ù„Ø«: 2=Ø®Ø±ÙŠÙ, 1=Ø±Ø¨ÙŠØ¹ | Ø¢Ø®Ø± 3 Ø£Ø±Ù‚Ø§Ù…: Ø§Ù„ØªØ³Ù„Ø³Ù„
                            </small>
                        </div>
                        <div class="form-group">
                            <label>Ø§Ø³Ù… Ø§Ù„Ø·Ø§Ù„Ø¨</label>
                            <input type="text" id="studentName" placeholder="Ø£Ø¯Ø®Ù„ Ø§Ø³Ù… Ø§Ù„Ø·Ø§Ù„Ø¨ Ø§Ù„ÙƒØ§Ù…Ù„">
                        </div>
                        <div class="form-group">
                            <label>Ø§Ù„Ù‚Ø³Ù…</label>
                            <select id="department" onchange="updateStudentIdPrefix(); loadDepartmentSubjects()">
                                <option value="">Ø§Ø®ØªØ± Ø§Ù„Ù‚Ø³Ù…</option>
                                <option value="Ø§Ù„ØªÙ…ÙˆÙŠÙ„ ÙˆØ§Ù„Ù…ØµØ§Ø±Ù">Ø§Ù„ØªÙ…ÙˆÙŠÙ„ ÙˆØ§Ù„Ù…ØµØ§Ø±Ù (AC)</option>
                                <option value="Ø§Ù„Ù…Ø³Ø§Ø­Ø©">Ø§Ù„Ù…Ø³Ø§Ø­Ø© (SE)</option>
                                <option value="Ø§Ù„Ø­Ø§Ø³ÙˆØ¨">Ø§Ù„Ø­Ø§Ø³ÙˆØ¨ (CO)</option>
                                <option value="Ø§Ù„Ø·Ø§Ù‚Ø©">Ø§Ù„Ø·Ø§Ù‚Ø© (RE)</option>
                                <option value="Ø§Ù„ÙƒÙ‡Ø±Ø¨Ø§Ø¡">Ø§Ù„ÙƒÙ‡Ø±Ø¨Ø§Ø¡ (EL)</option>
                                <option value="Ø§Ù„Ù…ÙŠÙƒØ§Ù†ÙŠÙƒØ§">Ø§Ù„Ù…ÙŠÙƒØ§Ù†ÙŠÙƒØ§ (ME)</option>
                            </select>
                        </div>
                        <div class="form-group">
                            <label>Ø§Ù„ÙØµÙ„ Ø§Ù„Ø¯Ø±Ø§Ø³ÙŠ</label>
                            <select id="userSemesterSelect" onchange="updateSemesterFromUserSelection()">
                                <option value="">Ø§Ø®ØªØ± Ø§Ù„ÙØµÙ„</option>
                                <option value="1">Ø§Ù„ÙØµÙ„ Ø§Ù„Ø£ÙˆÙ„</option>
                                <option value="2">Ø§Ù„ÙØµÙ„ Ø§Ù„Ø«Ø§Ù†ÙŠ</option>
                                <option value="3">Ø§Ù„ÙØµÙ„ Ø§Ù„Ø«Ø§Ù„Ø«</option>
                                <option value="4">Ø§Ù„ÙØµÙ„ Ø§Ù„Ø±Ø§Ø¨Ø¹</option>
                                <option value="5">Ø§Ù„ÙØµÙ„ Ø§Ù„Ø®Ø§Ù…Ø³</option>
                                <option value="6">Ø§Ù„ÙØµÙ„ Ø§Ù„Ø³Ø§Ø¯Ø³</option>
                            </select>
                            <small style="color: #666; font-size: 12px;">
                                <strong>ğŸ’¡ Ù…Ù„Ø§Ø­Ø¸Ø©:</strong> ÙŠÙ…ÙƒÙ†Ùƒ ØªØ­Ø¯ÙŠØ¯ Ø§Ù„ÙØµÙ„ ÙŠØ¯ÙˆÙŠØ§Ù‹ Ø¨ØºØ¶ Ø§Ù„Ù†Ø¸Ø± Ø¹Ù† Ø§Ù„Ø±Ù‚Ù… Ø§Ù„Ø¯Ø±Ø§Ø³ÙŠ
                            </small>
                        </div>
                    </div>
                </div>

                <div class="form-section">
                    <h3>Ø§Ø®ØªÙŠØ§Ø± Ø§Ù„Ù…ÙˆØ§Ø¯</h3>
                    <div class="subject-selector">
                        <h4>ğŸ“š Ø§Ù„Ù…ÙˆØ§Ø¯ Ø§Ù„Ù…Ø¹ØªÙ…Ø¯Ø© Ù„Ù„Ù‚Ø³Ù… ÙˆØ§Ù„ÙØµÙ„:</h4>
                        <div class="semester-selector">
                            <button onclick="selectSemester(1)" class="active">Ø§Ù„ÙØµÙ„ Ø§Ù„Ø£ÙˆÙ„</button>
                            <button onclick="selectSemester(2)">Ø§Ù„ÙØµÙ„ Ø§Ù„Ø«Ø§Ù†ÙŠ</button>
                            <button onclick="selectSemester(3)">Ø§Ù„ÙØµÙ„ Ø§Ù„Ø«Ø§Ù„Ø«</button>
                            <button onclick="selectSemester(4)">Ø§Ù„ÙØµÙ„ Ø§Ù„Ø±Ø§Ø¨Ø¹</button>
                            <button onclick="selectSemester(5)">Ø§Ù„ÙØµÙ„ Ø§Ù„Ø®Ø§Ù…Ø³</button>
                            <button onclick="selectSemester(6)">Ø§Ù„ÙØµÙ„ Ø§Ù„Ø³Ø§Ø¯Ø³</button>
                        </div>
                        <div id="subjectsGrid" class="subjects-grid">
                            <p style="color: #666; text-align: center; padding: 20px;">Ø£Ø¯Ø®Ù„ Ø§Ù„Ø±Ù‚Ù… Ø§Ù„Ø¯Ø±Ø§Ø³ÙŠ Ù„ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ù…ÙˆØ§Ø¯
                                ØªÙ„Ù‚Ø§Ø¦ÙŠØ§Ù‹</p>
                        </div>
                        <p style="color: #666; font-size: 14px; margin-top: 10px;">
                            <strong>ğŸ’¡ Ù…Ù„Ø§Ø­Ø¸Ø©:</strong> ÙŠØªÙ… Ø¥Ø¶Ø§ÙØ© Ø¬Ù…ÙŠØ¹ Ø§Ù„Ù…ÙˆØ§Ø¯ ØªÙ„Ù‚Ø§Ø¦ÙŠØ§Ù‹ Ø¨Ù†Ø§Ø¡Ù‹ Ø¹Ù„Ù‰ Ø§Ù„Ù‚Ø³Ù… ÙˆØ§Ù„ÙØµÙ„ Ù…Ù† Ø§Ù„Ø±Ù‚Ù…
                            Ø§Ù„Ø¯Ø±Ø§Ø³ÙŠ<br>
                            ÙŠÙ…ÙƒÙ†Ùƒ Ø¥Ø¶Ø§ÙØ© Ù…ÙˆØ§Ø¯ Ù…Ø·Ø§Ù„Ø¨Ø© Ù„Ù„Ø·Ù„Ø§Ø¨ Ø§Ù„Ø±Ø§Ø³Ø¨ÙŠÙ† Ù…Ù† Ø§Ù„ÙØµÙ„ Ø§Ù„Ø³Ø§Ø¨Ù‚ Ø¨Ø§Ø³ØªØ®Ø¯Ø§Ù… Ø§Ù„Ø²Ø± Ø£Ø¯Ù†Ø§Ù‡<br>
                            <strong>ğŸ“ Ù…Ø·Ù„ÙˆØ¨ ÙÙ‚Ø·:</strong> Ø£Ø¯Ø®Ù„ Ø¯Ø±Ø¬Ø§Øª Ø£Ø¹Ù…Ø§Ù„ Ø§Ù„ÙØµÙ„ ÙˆØ§Ù„Ø§Ø®ØªØ¨Ø§Ø± Ø§Ù„Ù†Ù‡Ø§Ø¦ÙŠØŒ Ø³ÙŠØªÙ… Ø­Ø³Ø§Ø¨ Ø§Ù„Ù…Ø¬Ù…ÙˆØ¹
                            ÙˆØ§Ù„ØªÙ‚Ø¯ÙŠØ± ØªÙ„Ù‚Ø§Ø¦ÙŠØ§Ù‹
                        </p>
                        <button class="edit-subjects-btn" onclick="toggleSubjectEditor()">ğŸ“ ØªØ¹Ø¯ÙŠÙ„ Ø§Ù„Ù…ÙˆØ§Ø¯</button>
                        <div id="subjectEditor" class="subject-editor">
                            <h4>ğŸ“ ØªØ¹Ø¯ÙŠÙ„ Ù…ÙˆØ§Ø¯ Ø§Ù„Ù‚Ø³Ù… ÙˆØ§Ù„ÙØµÙ„ Ø§Ù„Ø­Ø§Ù„ÙŠ</h4>
                            <div id="subjectListEditor" class="subject-list-editor">
                                <!-- Ø³ÙŠØªÙ… ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ù…ÙˆØ§Ø¯ Ù‡Ù†Ø§ -->
                            </div>
                            <button class="add-subject-btn" onclick="addNewSubject()">+ Ø¥Ø¶Ø§ÙØ© Ù…Ø§Ø¯Ø© Ø¬Ø¯ÙŠØ¯Ø©</button>
                            <button class="primary" onclick="saveSubjectsChanges()" style="margin-top: 10px;">ğŸ’¾ Ø­ÙØ¸
                                Ø§Ù„ØªØºÙŠÙŠØ±Ø§Øª</button>
                            <button class="danger" onclick="toggleSubjectEditor()"
                                style="margin-top: 10px;">Ø¥Ù„ØºØ§Ø¡</button>
                        </div>
                    </div>
                </div>

                <div class="form-section">
                    <h3>Ø§Ù„Ù…ÙˆØ§Ø¯ ÙˆØ§Ù„Ø¯Ø±Ø¬Ø§Øª</h3>
                    <div id="subjectsContainer">
                        <div class="subject-input">
                            <input type="text" placeholder="Ø§Ø³Ù… Ø§Ù„Ù…Ø§Ø¯Ø©" class="subject-name">
                            <input type="number" placeholder="Ø§Ù„ÙˆØ­Ø¯Ø§Øª" class="subject-units" min="1" max="6">
                            <input type="number" placeholder="Ø£Ø¹Ù…Ø§Ù„ Ø§Ù„ÙØµÙ„" class="subject-classwork" min="0" max="40"
                                onchange="autoCalculate(this)">
                            <input type="number" placeholder="Ø§Ù„Ø§Ø®ØªØ¨Ø§Ø± Ø§Ù„Ù†Ù‡Ø§Ø¦ÙŠ" class="subject-final" min="0" max="60"
                                onchange="autoCalculate(this)">
                            <input type="number" placeholder="Ø§Ù„Ù…Ø¬Ù…ÙˆØ¹" class="subject-total" min="0" max="100" readonly
                                style="background: rgba(15, 23, 42, 0.4); color: var(--text-color);">
                            <select class="subject-evaluation" readonly
                                style="background: rgba(15, 23, 42, 0.4); color: var(--text-color);">
                                <option value="">ÙŠØªÙ… Ø­Ø³Ø§Ø¨ ØªÙ„Ù‚Ø§Ø¦ÙŠØ§Ù‹</option>
                                <option value="Ù…Ù…ØªØ§Ø²">Ù…Ù…ØªØ§Ø²</option>
                                <option value="Ø¬ÙŠØ¯ Ø¬Ø¯Ø§">Ø¬ÙŠØ¯ Ø¬Ø¯Ø§</option>
                                <option value="Ø¬ÙŠØ¯">Ø¬ÙŠØ¯</option>
                                <option value="Ù…Ù‚Ø¨ÙˆÙ„">Ù…Ù‚Ø¨ÙˆÙ„</option>
                                <option value="Ø¶Ø¹ÙŠÙ">Ø¶Ø¹ÙŠÙ</option>
                                <option value="Ø±Ø§Ø³Ø¨">Ø±Ø§Ø³Ø¨</option>
                            </select>
                            <button type="button" class="remove-subject" onclick="removeSubject(this)">Ø­Ø°Ù</button>
                        </div>
                    </div>
                    <button type="button" onclick="addSubject()" class="primary" style="margin-top: 10px;">+ Ø¥Ø¶Ø§ÙØ©
                        Ù…Ø§Ø¯Ø©</button>
                    <button type="button" onclick="addFailedSubject()" class="warning" style="margin-top: 10px;">+ Ø¥Ø¶Ø§ÙØ©
                        Ù…Ø§Ø¯Ø© Ù…Ø·Ø§Ù„Ø¨Ø©</button>
                </div>

                <button type="button" onclick="addStudent()" class="primary">ğŸ’¾ Ø­ÙØ¸ Ø§Ù„Ø·Ø§Ù„Ø¨</button>
            </div>

            <!-- Search Tab -->
            <div id="search-student" class="tab-content">
                <div class="search-section">
                    <h2>ğŸ” Ø§Ù„Ø¨Ø­Ø« Ø¹Ù† Ø·Ø§Ù„Ø¨</h2>

                    <!-- Mobile-Responsive Search Input -->
                    <div class="search-input-mobile">
                        <div class="search-input-group">
                            <input type="text" id="searchId" placeholder="Ø£Ø¯Ø®Ù„ Ø§Ù„Ø±Ù‚Ù… Ø§Ù„Ø¯Ø±Ø§Ø³ÙŠ"
                                class="search-input-field">
                            <button onclick="searchStudent()" class="search-button">
                                <span class="search-icon">ğŸ”</span>
                                <span class="search-text">Ø¨Ø­Ø«</span>
                            </button>
                        </div>

                        <!-- Quick Search Buttons -->
                        <div class="quick-search-buttons">
                            <button onclick="clearSearch()" class="quick-btn clear-btn">Ù…Ø³Ø­</button>
                        </div>
                    </div>

                    <!-- Search Results -->
                    <div id="searchResults" class="search-results"></div>
                </div>

                <!-- Student Result Display -->
                <div id="studentResultDisplay" class="student-result-display" style="display: none;">
                    <!-- Ø³ÙŠØªÙ… Ø¹Ø±Ø¶ Ù†ØªÙŠØ¬Ø© Ø§Ù„Ø·Ø§Ù„Ø¨ Ù‡Ù†Ø§ -->
                </div>
            </div>

            <!-- List Tab -->
            <div id="list" class="tab-content">
                <h3>Ù‚Ø§Ø¦Ù…Ø© Ø¬Ù…ÙŠØ¹ Ø§Ù„Ø·Ù„Ø§Ø¨</h3>
                <div style="display: flex; gap: 10px; margin-bottom: 20px; flex-wrap: wrap;">
                    <button onclick="loadAllStudents()" class="primary">ğŸ”„ ØªØ­Ø¯ÙŠØ« Ø§Ù„Ù‚Ø§Ø¦Ù…Ø©</button>
                    <button onclick="forceLoadFromStatic()" class="warning">ğŸ“‚ Ø§Ø³ØªØ¹Ø§Ø¯Ø© Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ù…Ù† Ø§Ù„Ù…Ù„Ù</button>
                    <button onclick="addTestStudents()" class="success">ğŸ“ Ø¥Ø¶Ø§ÙØ© Ø¨ÙŠØ§Ù†Ø§Øª ØªØ¬Ø±ÙŠØ¨ÙŠØ©</button>
                    <button onclick="syncWithFile()" class="info">ğŸ”„ Ù…Ø²Ø§Ù…Ù†Ø© Ù…Ø¹ Ø§Ù„Ù…Ù„Ù</button>
                    <button onclick="syncWithFirebase()" class="warning">ğŸ”¥ Ù…Ø²Ø§Ù…Ù†Ø© Ù…Ù† Firebase</button>
                    <button onclick="pushToFirebase()" class="warning">ğŸ“¤ Ø¯ÙØ¹ Ø¥Ù„Ù‰ Firebase</button>
                    <button onclick="syncWithOfflineData()" class="info">ğŸ“± Ù…Ø²Ø§Ù…Ù†Ø© Ø¨Ø¯ÙˆÙ† Ø¥Ù†ØªØ±Ù†Øª</button>
                    <button onclick="checkConnectionStatus()" class="info">ğŸŒ ÙØ­Øµ Ø§Ù„Ø§ØªØµØ§Ù„</button>
                </div>
                <div id="allStudentsList"></div>
            </div>

            <!-- Block Student Tab -->
            <div id="block-student" class="tab-content">
                <div class="form-section">
                    <h3>ğŸš« Ø­Ø¬Ø¨ Ù†ØªÙŠØ¬Ø© Ø·Ø§Ù„Ø¨</h3>
                    <div class="form-row">
                        <div class="form-group">
                            <label>Ø§Ù„Ø±Ù‚Ù… Ø§Ù„Ø¯Ø±Ø§Ø³ÙŠ</label>
                            <input type="text" id="blockStudentId" placeholder="Ø£Ø¯Ø®Ù„ Ø§Ù„Ø±Ù‚Ù… Ø§Ù„Ø¯Ø±Ø§Ø³ÙŠ">
                        </div>
                        <div class="form-group">
                            <label>Ø³Ø¨Ø¨ Ø§Ù„Ø­Ø¬Ø¨</label>
                            <input type="text" id="blockReason" placeholder="Ø£Ø¯Ø®Ù„ Ø³Ø¨Ø¨ Ø­Ø¬Ø¨ Ø§Ù„Ù†ØªÙŠØ¬Ø©">
                        </div>
                    </div>
                    <div style="display: flex; gap: 10px; margin-top: 15px;">
                        <button onclick="blockStudent()" class="danger">ğŸš« Ø­Ø¬Ø¨ Ø§Ù„Ù†ØªÙŠØ¬Ø©</button>
                        <button onclick="unblockStudent()" class="success">âœ… Ø¥Ù„ØºØ§Ø¡ Ø§Ù„Ø­Ø¬Ø¨</button>
                        <button onclick="checkBlockedStatus()" class="primary">ğŸ” ÙØ­Øµ Ø§Ù„Ø­Ø§Ù„Ø©</button>
                    </div>
                    <div id="blockStatus" style="margin-top: 15px;"></div>
                </div>

                <div class="form-section" style="margin-top: 20px;">
                    <h3>ğŸ“‹ Ù‚Ø§Ø¦Ù…Ø© Ø§Ù„Ø·Ù„Ø§Ø¨ Ø§Ù„Ù…Ø­Ø¬ÙˆØ¨ÙŠÙ†</h3>
                    <button onclick="loadBlockedStudents()" class="primary">ØªØ­Ø¯ÙŠØ« Ø§Ù„Ù‚Ø§Ø¦Ù…Ø©</button>
                    <div id="blockedStudentsList" class="student-list"></div>
                </div>
            </div>

            <!-- Print All Tab -->
            <div id="print-all" class="tab-content">
                <div class="form-section">
                    <h3>ğŸ–¨ï¸ Ø·Ø¨Ø§Ø¹Ø© Ø¬Ù…ÙŠØ¹ Ø§Ù„Ù†ØªØ§Ø¦Ø¬</h3>
                    <div class="form-row">
                        <div class="form-group">
                            <label>Ø®ÙŠØ§Ø±Ø§Øª Ø§Ù„Ø·Ø¨Ø§Ø¹Ø©</label>
                            <div style="display: flex; flex-direction: column; gap: 10px; margin-top: 10px;">
                                <label style="display: flex; align-items: center; gap: 10px;">
                                    <input type="checkbox" id="includeBlocked" checked>
                                    <span>ØªØ¶Ù…ÙŠÙ† Ø§Ù„Ø·Ù„Ø§Ø¨ Ø§Ù„Ù…Ø­Ø¬ÙˆØ¨ÙŠÙ†</span>
                                </label>
                                <label style="display: flex; align-items: center; gap: 10px;">
                                    <input type="checkbox" id="sortByDepartment" checked>
                                    <span>ØªØ±ØªÙŠØ¨ Ø­Ø³Ø¨ Ø§Ù„Ù‚Ø³Ù…</span>
                                </label>
                                <label style="display: flex; align-items: center; gap: 10px;">
                                    <input type="checkbox" id="sortBySemester" checked>
                                    <span>ØªØ±ØªÙŠØ¨ Ø­Ø³Ø¨ Ø§Ù„ÙØµÙ„</span>
                                </label>
                            </div>
                        </div>
                        <div class="form-group">
                            <label>ÙÙ„ØªØ± Ø§Ù„Ù‚Ø³Ù…</label>
                            <select id="departmentFilter"
                                style="width: 100%; padding: 8px; border: 1px solid #ddd; border-radius: 4px;">
                                <option value="">Ø¬Ù…ÙŠØ¹ Ø§Ù„Ø£Ù‚Ø³Ø§Ù…</option>
                                <option value="Ù‡Ù†Ø¯Ø³Ø© Ø§Ù„Ù…Ø³Ø§Ø­Ø©">Ù‡Ù†Ø¯Ø³Ø© Ø§Ù„Ù…Ø³Ø§Ø­Ø©</option>
                                <option value="Ù‡Ù†Ø¯Ø³Ø© Ø§Ù„Ø­Ø§Ø³ÙˆØ¨">Ù‡Ù†Ø¯Ø³Ø© Ø§Ù„Ø­Ø§Ø³ÙˆØ¨</option>
                                <option value="Ù‡Ù†Ø¯Ø³Ø© Ø§Ù„ØªÙ…ÙˆÙŠÙ„">Ù‡Ù†Ø¯Ø³Ø© Ø§Ù„ØªÙ…ÙˆÙŠÙ„</option>
                                <option value="Ù‡Ù†Ø¯Ø³Ø© Ø§Ù„Ø·Ø§Ù‚Ø©">Ù‡Ù†Ø¯Ø³Ø© Ø§Ù„Ø·Ø§Ù‚Ø©</option>
                                <option value="Ø§Ù„Ù‡Ù†Ø¯Ø³Ø© Ø§Ù„ÙƒÙ‡Ø±Ø¨Ø§Ø¦ÙŠØ©">Ø§Ù„Ù‡Ù†Ø¯Ø³Ø© Ø§Ù„ÙƒÙ‡Ø±Ø¨Ø§Ø¦ÙŠØ©</option>
                                <option value="Ø§Ù„Ù‡Ù†Ø¯Ø³Ø© Ø§Ù„Ù…ÙŠÙƒØ§Ù†ÙŠÙƒÙŠØ©">Ø§Ù„Ù‡Ù†Ø¯Ø³Ø© Ø§Ù„Ù…ÙŠÙƒØ§Ù†ÙŠÙƒÙŠØ©</option>
                            </select>
                        </div>
                    </div>
                    <div style="display: flex; gap: 10px; margin-top: 15px;">
                        <button onclick="printAllStudents()" class="primary"
                            style="padding: 10px 20px; font-size: 14px;">ğŸ–¨ï¸ Ø·Ø¨Ø§Ø¹Ø© Ø§Ù„ÙƒÙ„</button>
                        <button onclick="previewPrintAll()" class="secondary"
                            style="padding: 10px 20px; font-size: 14px;">ğŸ‘ï¸ Ù…Ø¹Ø§ÙŠÙ†Ø©</button>
                        <button onclick="exportToPDF()" class="success" style="padding: 10px 20px; font-size: 14px;">ğŸ“„
                            ØªØµØ¯ÙŠØ± PDF</button>
                    </div>
                    <div id="printPreview" style="margin-top: 15px;"></div>
                </div>
            </div>

            <!-- Excel Tab -->
            <div id="excel" class="tab-content">
                <div class="excel-section">
                    <h3>ğŸ“Š Ø§Ø³ØªÙŠØ±Ø§Ø¯ ÙˆØªØµØ¯ÙŠØ± Excel</h3>

                    <div class="excel-buttons">
                        <button onclick="exportToExcel()" class="primary">ğŸ“¤ ØªØµØ¯ÙŠØ± Ø¥Ù„Ù‰ Excel (Ø´Ø§Ù…Ù„)</button>
                        <button onclick="downloadTemplate()" class="warning">ğŸ“¥ ØªØ­Ù…ÙŠÙ„ Ù‚Ø§Ù„Ø¨ Excel (Ù…Ø­Ø¯Ø«)</button>
                        <button onclick="window.open('create_excel_template_v2.html', '_blank')" class="primary">ğŸ“„
                            Ø¥Ù†Ø´Ø§Ø¡ Ù‚Ø§Ù„Ø¨ Excel Ø§Ø­ØªØ±Ø§ÙÙŠ</button>
                        <button onclick="exportStatisticsToExcel()" class="secondary">ğŸ“Š ØªØµØ¯ÙŠØ± Ø§Ù„Ø¥Ø­ØµØ§Ø¦ÙŠØ§Øª</button>
                    </div>

                    <div class="form-section" style="margin: 15px 0;">
                        <h4>ğŸ” Ø´Ø±Ø­ Ù†Ø¸Ø§Ù… ØªØ±Ù…ÙŠØ² Ø§Ù„Ø·Ù„Ø§Ø¨:</h4>
                        <ul style="text-align: right; margin-right: 20px; color: var(--text-muted);">
                            <li><strong>SE</strong> = Ø§Ù„Ù…Ø³Ø§Ø­Ø© | <strong>AC</strong> = Ø§Ù„ØªÙ…ÙˆÙŠÙ„ ÙˆØ§Ù„Ù…ØµØ§Ø±Ù |
                                <strong>CO</strong> = Ø§Ù„Ø­Ø§Ø³ÙˆØ¨
                            </li>
                            <li><strong>RE</strong> = Ø§Ù„Ø·Ø§Ù‚Ø© | <strong>EL</strong> = Ø§Ù„ÙƒÙ‡Ø±Ø¨Ø§Ø¡ | <strong>ME</strong> =
                                Ø§Ù„Ù…ÙŠÙƒØ§Ù†ÙŠÙƒØ§</li>
                            <li><strong>Ø§Ù„Ø±Ù‚Ù…ÙŠÙ† Ø§Ù„ØªØ§Ù„ÙŠÙŠÙ†</strong> = Ø³Ù†Ø© Ø§Ù„ØªØ³Ø¬ÙŠÙ„ (Ù…Ø«Ø§Ù„: 24 = 2024)</li>
                            <li><strong>Ø§Ù„Ø±Ù‚Ù… Ø§Ù„Ø«Ø§Ù„Ø«</strong> = 2 = Ø®Ø±ÙŠÙ | 1 = Ø±Ø¨ÙŠØ¹</li>
                            <li><strong>Ø¢Ø®Ø± 3 Ø£Ø±Ù‚Ø§Ù…</strong> = ØªØ³Ù„Ø³Ù„ Ø§Ù„Ø·Ø§Ù„Ø¨ (1-999)</li>
                            <li><strong>Ù…Ø«Ø§Ù„: SE242001</strong> = Ø·Ø§Ù„Ø¨ Ù…Ø³Ø§Ø­Ø©ØŒ Ø³Ø¬Ù„ 2024ØŒ ÙØµÙ„ Ø®Ø±ÙŠÙØŒ ØªØ³Ù„Ø³Ù„ 001</li>
                        </ul>
                    </div>

                    <div class="form-section"
                        style="border-color: var(--primary-color); background: rgba(99, 102, 241, 0.05); margin: 15px 0;">
                        <h4>ğŸ“Š Ù…ÙŠØ²Ø§Øª Ø§Ù„Ù†Ø¸Ø§Ù… Ø§Ù„Ù…Ø­Ø¯Ø«:</h4>
                        <ul style="text-align: right; margin-right: 20px; color: var(--text-muted);">
                            <li>âœ… Ø§Ù„ØªÙˆØ§ÙÙ‚ Ù…Ø¹ Ø§Ù„Ø£Ù‚Ø³Ø§Ù… Ø§Ù„Ø¬Ø¯ÙŠØ¯Ø© ÙˆØ§Ù„Ù…ÙˆØ§Ø¯ Ø§Ù„Ù…Ø®ØµØµØ©</li>
                            <li>âœ… Ø­Ø³Ø§Ø¨ Ø§Ù„Ù†ØªØ§Ø¦Ø¬ Ø­Ø³Ø¨ Ø§Ù„Ù…Ù†Ø·Ù‚ Ø§Ù„Ø£ÙƒØ§Ø¯ÙŠÙ…ÙŠ Ø§Ù„Ø¬Ø¯ÙŠØ¯ (Ù…Ù†Ù‚ÙˆÙ„/Ø±Ø§Ø³Ø¨)</li>
                            <li>âœ… Ø¯Ø¹Ù… Ø§Ù„ÙØµÙˆÙ„ Ø§Ù„Ø¯Ø±Ø§Ø³ÙŠØ© Ù…Ù† 1 Ø¥Ù„Ù‰ 6</li>
                            <li>âœ… Ø§Ù„ØªØ­Ù‚Ù‚ Ù…Ù† ØµØ­Ø© Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ø£Ø«Ù†Ø§Ø¡ Ø§Ù„Ø§Ø³ØªÙŠØ±Ø§Ø¯</li>
                            <li>âœ… ØªØµØ¯ÙŠØ± Ø¥Ø­ØµØ§Ø¦ÙŠØ§Øª Ø´Ø§Ù…Ù„Ø© ÙˆØªÙØ§ØµÙŠÙ„ Ø§Ù„Ø·Ù„Ø§Ø¨</li>
                        </ul>
                    </div>
                </div>

                <div class="file-upload">
                    <h3>ğŸ“ Ø§Ø³ØªÙŠØ±Ø§Ø¯ Ù…Ù† Excel</h3>
                    <p>Ø§Ø±ÙØ¹ Ù…Ù„Ù Excel Ù„Ø§Ø³ØªÙŠØ±Ø§Ø¯ Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ø·Ù„Ø§Ø¨</p>
                    <p style="color: #666; font-size: 14px; margin-top: 10px;">ÙŠØ¯Ø¹Ù… Ù…Ù„ÙØ§Øª .xlsx Ùˆ .xls Ù…Ø¹ Ø§Ù„ØªØ­Ù‚Ù‚ Ù…Ù† ØµØ­Ø©
                        Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª</p>
                    <input type="file" id="excelFileInput" accept=".xlsx,.xls">
                    <button onclick="importFromExcel()">ğŸ“¥ Ø§Ø³ØªÙŠØ±Ø§Ø¯ Ù…Ù† Excel</button>
                    <div id="importResults" class="status-message" style="display: none; margin-top: 15px;"></div>
                </div>

            </div>

            <!-- Settings Tab -->
            <div id="settings" class="tab-content">
                <div class="admin-settings">
                    <h3>âš™ï¸ Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª Ø§Ù„Ù…Ø¯ÙŠØ±</h3>

                    <div
                        style="margin-bottom: 25px; border-bottom: 1px solid rgba(255,255,255,0.1); padding-bottom: 20px; background: rgba(16, 185, 129, 0.05); padding: 15px; border-radius: 12px; border: 1px solid rgba(16, 185, 129, 0.2);">
                        <h3 style="margin-bottom: 10px; color: var(--accent-color);">ğŸš€ Ù†Ø´Ø± Ø§Ù„Ù†ØªØ§Ø¦Ø¬ Ù„Ù„Ø·Ù„Ø§Ø¨</h3>
                        <p style="margin-bottom: 10px; color: var(--text-muted); font-size: 0.9rem;">
                            1. Ø§Ø¶ØºØ· Ø§Ù„Ø²Ø± Ø¨Ø§Ù„Ø£Ø³ÙÙ„ Ù„ØªØ­Ù…ÙŠÙ„ Ù…Ù„Ù Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª.<br>
                            2. Ø§Ø³ØªØ¨Ø¯Ù„ Ø§Ù„Ù…Ù„Ù Ø§Ù„Ù‚Ø¯ÙŠÙ… ÙÙŠ Ù…Ø¬Ù„Ø¯ Ù…Ø´Ø±ÙˆØ¹Ùƒ Ø¨Ù‡Ø°Ø§ Ø§Ù„Ù…Ù„Ù.<br>
                            3. Ø§Ø±ÙØ¹ Ø§Ù„Ù…ÙˆÙ‚Ø¹ Ù„ÙƒÙŠ ØªØ¸Ù‡Ø± Ø§Ù„Ù†ØªØ§Ø¦Ø¬ Ø¹Ù†Ø¯ Ø§Ù„Ø·Ù„Ø§Ø¨.
                        </p>
                        <button onclick="downloadStudentsDataJS()" class="success"
                            style="background: linear-gradient(135deg, #10b981, #059669); width: 100%; padding: 15px; font-size: 1.1rem; box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1), 0 2px 4px -1px rgba(0, 0, 0, 0.06);">
                            ğŸŒ ØªØ­Ù…ÙŠÙ„ Ù…Ù„Ù Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ù…ÙˆÙ‚Ø¹ (students-data.js)
                        </button>
                    </div>

                    <!-- User Management Section -->
                    <div class="form-section" style="margin-bottom: 20px;">
                        <h4>ğŸ‘¥ Ø¥Ø¯Ø§Ø±Ø© Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…ÙŠÙ† ÙˆØ§Ù„ØµÙ„Ø§Ø­ÙŠØ§Øª</h4>

                        <div style="margin-bottom: 20px; display: flex; gap: 15px;">
                            <button onclick="showAddUserModal()" class="primary">
                                â• Ø¥Ø¶Ø§ÙØ© Ù…Ø³ØªØ®Ø¯Ù… Ø¬Ø¯ÙŠØ¯
                            </button>
                            <button onclick="showUsersList()" class="secondary">
                                ğŸ“‹ Ø¹Ø±Ø¶ Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…ÙŠÙ†
                            </button>
                        </div>

                        <div id="usersList" style="display: none; margin-top: 15px;">
                            <!-- Users list will be populated here -->
                        </div>
                    </div>

                    <!-- New "Ù…Ø·Ø§Ù„Ø¨" Rule Setting -->
                    <div class="admin-settings" style="margin-bottom: 25px;">
                        <h4>âš ï¸ Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª Ø´Ø±Ø· Ø§Ù„Ø±Ø³ÙˆØ¨ Ù„Ù„Ù…ÙˆØ§Ø¯ Ø§Ù„Ù…Ø·Ø§Ù„Ø¨Ø©</h4>

                        <div class="toggle-switch">
                            <input type="checkbox" id="requiredSubjectRuleEnabled" checked
                                onchange="saveRequiredSubjectRule()">
                            <label for="requiredSubjectRuleEnabled">ØªÙØ¹ÙŠÙ„ Ø´Ø±Ø· Ø§Ù„Ø±Ø³ÙˆØ¨ Ù„Ù„Ù…ÙˆØ§Ø¯ Ø§Ù„Ù…Ø·Ø§Ù„Ø¨Ø©</label>
                        </div>
                        <p class="warning-text">
                            Ø¹Ù†Ø¯ Ø§Ù„ØªÙØ¹ÙŠÙ„: Ø¥Ø°Ø§ Ø±Ø³Ø¨ Ø§Ù„Ø·Ø§Ù„Ø¨ ÙÙŠ Ø£ÙŠ Ù…Ø§Ø¯Ø© Ù…Ù† Ù†ÙˆØ¹ "Ù…Ø·Ø§Ù„Ø¨"ØŒ ÙŠØ¹ØªØ¨Ø± Ø±Ø§Ø³Ø¨Ø§Ù‹ Ø¨ØºØ¶ Ø§Ù„Ù†Ø¸Ø± Ø¹Ù† Ø¹Ø¯Ø¯ Ø§Ù„Ù…ÙˆØ§Ø¯
                            Ø§Ù„Ø±Ø§Ø³Ø¨Ø© Ø§Ù„Ø£Ø®Ø±Ù‰ ÙˆØ§Ù„Ù…Ø¹Ø¯Ù„ Ø§Ù„ØªØ±Ø§ÙƒÙ…ÙŠ
                        </p>
                        <p style="color: var(--text-muted); font-size: 14px; margin-top: 10px;">
                            <strong>ğŸ’¡ Ù…Ù„Ø§Ø­Ø¸Ø©:</strong> Ù‡Ø°Ø§ Ø§Ù„Ø´Ø±Ø· Ù„Ù‡ Ø§Ù„Ø£ÙˆÙ„ÙˆÙŠØ© Ø§Ù„Ù‚ØµÙˆÙ‰ Ø¹Ù„Ù‰ Ø´Ø±ÙˆØ· Ø§Ù„Ø±Ø³ÙˆØ¨ Ø§Ù„Ø£Ø®Ø±Ù‰ (Ø¹Ø¯Ø¯ Ø§Ù„Ù…ÙˆØ§Ø¯
                            Ø§Ù„Ø±Ø§Ø³Ø¨Ø© ÙˆØ§Ù„Ù…Ø¹Ø¯Ù„ Ø§Ù„ØªØ±Ø§ÙƒÙ…ÙŠ)
                        </p>
                    </div>

                    <div class="toggle-switch">
                        <input type="checkbox" id="failRuleEnabled" checked onchange="saveSettings()">
                        <label for="failRuleEnabled">ØªÙØ¹ÙŠÙ„ Ø´Ø±Ø· Ø§Ù„Ø±Ø³ÙˆØ¨ ÙÙŠ Ø§Ù„Ø§Ø®ØªØ¨Ø§Ø± Ø§Ù„Ù†Ù‡Ø§Ø¦ÙŠ</label>
                    </div>
                    <p class="warning-text">
                        Ø¹Ù†Ø¯ Ø§Ù„ØªÙØ¹ÙŠÙ„: Ø¥Ø°Ø§ Ø­ØµÙ„ Ø§Ù„Ø·Ø§Ù„Ø¨ Ø¹Ù„Ù‰ Ø£Ù‚Ù„ Ù…Ù† 30 Ø¯Ø±Ø¬Ø© ÙÙŠ Ø§Ù„Ø§Ø®ØªØ¨Ø§Ø± Ø§Ù„Ù†Ù‡Ø§Ø¦ÙŠØŒ ÙŠØªÙ… Ø§Ø­ØªØ³Ø§Ø¨ Ø§Ù„Ø¯Ø±Ø¬Ø© ØµÙØ± ÙÙŠ
                        Ø§Ù„Ù…Ø¬Ù…ÙˆØ¹<br>
                        Ù…Ø¹ Ø¥Ø¨Ù‚Ø§Ø¡ Ø§Ù„Ø¯Ø±Ø¬Ø© Ø§Ù„Ø£ØµÙ„ÙŠØ© Ù…Ø³Ø¬Ù„Ø© ÙÙŠ Ø§Ù„Ø®Ù„ÙŠØ©
                    </p>

                    <div style="margin-top: 25px;">
                        <h4>ğŸ“… Ø§Ù„ÙØµÙ„ Ø§Ù„Ø¯Ø±Ø§Ø³ÙŠ Ø§Ù„Ø­Ø§Ù„ÙŠ:</h4>
                        <div class="form-group" style="margin-top: 15px;">
                            <input type="text" id="currentAcademicSemester"
                                placeholder="Ø§ÙƒØªØ¨ Ø§Ù„ÙØµÙ„ Ø§Ù„Ø¯Ø±Ø§Ø³ÙŠ (Ù…Ø«Ø§Ù„: Ø®Ø±ÙŠÙ 2030)" onchange="saveAcademicSemester()"
                                onblur="saveAcademicSemester()">
                            <small style="color: var(--text-muted); font-size: 12px; margin-top: 8px; display: block;">
                                <strong>ğŸ’¡ Ø£Ù…Ø«Ù„Ø©:</strong> Ø®Ø±ÙŠÙ 2030ØŒ Ø±Ø¨ÙŠØ¹ 2031ØŒ Ø®Ø±ÙŠÙ 2031-2032
                            </small>
                        </div>
                    </div>

                    <div style="margin-top: 20px;">
                        <h4>ğŸ“Š Ø§Ù„Ø¥Ø­ØµØ§Ø¦ÙŠØ§Øª Ø§Ù„Ø­Ø§Ù„ÙŠØ©:</h4>
                        <div id="statistics" class="form-section"
                            style="margin-top: 15px; background: rgba(99, 102, 241, 0.05);">
                            <p style="margin-bottom: 12px; font-size: 1.1rem;">Ø¹Ø¯Ø¯ Ø§Ù„Ø·Ù„Ø§Ø¨: <span id="totalStudents"
                                    style="color: var(--primary-color); font-weight: 800;">0</span></p>
                            <p style="margin-bottom: 12px; font-size: 1.1rem;">Ø¹Ø¯Ø¯ Ø§Ù„Ù…ÙˆØ§Ø¯: <span id="totalSubjects"
                                    style="color: var(--secondary-color); font-weight: 800;">0</span></p>
                            <p style="font-size: 1.1rem;">Ù…ØªÙˆØ³Ø· Ø§Ù„Ø¯Ø±Ø¬Ø§Øª: <span id="averageGrade"
                                    style="color: var(--accent-color); font-weight: 800;">0</span></p>
                        </div>

                        <div style="margin-top: 20px;">
                            <button onclick="showInstituteStatistics()" class="primary"
                                style="width: 100%; font-size: 1.1rem; padding: 15px;">
                                ğŸ“Š Ø¥Ø­ØµØ§Ø¦ÙŠØ§Øª Ø§Ù„Ù…Ø¹Ù‡Ø¯ Ø§Ù„Ø´Ø§Ù…Ù„Ø©
                            </button>
                        </div>

                        <div style="margin-top: 25px;">
                            <h4>ğŸ¢ Ø¥Ø¯Ø§Ø±Ø© Ø§Ù„Ø£Ù‚Ø³Ø§Ù…:</h4>
                            <div class="form-section" style="margin-top: 15px;">
                                <div style="margin-bottom: 20px;">
                                    <div class="form-group">
                                        <label>Ø§Ø³Ù… Ø§Ù„Ù‚Ø³Ù… Ø§Ù„Ø¬Ø¯ÙŠØ¯</label>
                                        <input type="text" id="newDepartmentName"
                                            placeholder="Ù…Ø«Ø§Ù„: Ù‡Ù†Ø¯Ø³Ø© Ø§Ù„Ù…Ø¹Ø¯Ø§Øª Ø§Ù„Ø·Ø¨ÙŠØ©">
                                    </div>
                                    <div class="form-group">
                                        <label>Ø±Ù…Ø² Ø§Ù„Ù‚Ø³Ù… (Ù…Ø«Ø§Ù„: BE)</label>
                                        <input type="text" id="newDepartmentCode" placeholder="Ø£Ø¯Ø®Ù„ Ø§Ù„Ø±Ù…Ø²" maxlength="5"
                                            style="text-transform: uppercase;">
                                    </div>
                                    <button onclick="addNewDepartment()" class="primary"
                                        style="width: 100%; margin-top: 10px;">
                                        â• Ø¥Ø¶Ø§ÙØ© Ù‚Ø³Ù… Ø¬Ø¯ÙŠØ¯
                                    </button>
                                </div>

                                <div id="departmentsList" style="margin-top: 20px;">
                                    <h5 style="margin-bottom: 12px; color: var(--text-color); font-size: 1.1rem;">ğŸ“‹
                                        Ø§Ù„Ø£Ù‚Ø³Ø§Ù… Ø§Ù„Ù…ØªØ§Ø­Ø©:</h5>
                                    <div id="departmentsContainer" class="student-list"
                                        style="max-height: 300px; overflow-y: auto;">
                                        <!-- Ø³ÙŠØªÙ… Ø¹Ø±Ø¶ Ø§Ù„Ø£Ù‚Ø³Ø§Ù… Ù‡Ù†Ø§ -->
                                    </div>
                                </div>
                            </div>
                        </div>

                        <h4 style="margin-top: 30px;">ğŸ¨ Ø´Ø±Ø­ Ø§Ù„ØªÙ‚Ø¯ÙŠØ±Ø§Øª ÙˆØ§Ù„Ø£Ù„ÙˆØ§Ù†:</h4>
                        <div class="form-section" style="margin-top: 15px;">
                            <div
                                style="display: grid; grid-template-columns: repeat(auto-fit, minmax(180px, 1fr)); gap: 15px;">
                                <div class="grade-excellent"
                                    style="padding: 12px; border-radius: 12px; text-align: center; border: 1px solid rgba(255,255,255,0.1);">
                                    <strong>85-100: Ù…Ù…ØªØ§Ø²</strong>
                                </div>
                                <div class="grade-very-good"
                                    style="padding: 12px; border-radius: 12px; text-align: center; border: 1px solid rgba(255,255,255,0.1);">
                                    <strong>75-84: Ø¬ÙŠØ¯ Ø¬Ø¯Ø§</strong>
                                </div>
                                <div class="grade-good"
                                    style="padding: 12px; border-radius: 12px; text-align: center; border: 1px solid rgba(255,255,255,0.1);">
                                    <strong>65-74: Ø¬ÙŠØ¯</strong>
                                </div>
                                <div class="grade-acceptable"
                                    style="padding: 12px; border-radius: 12px; text-align: center; border: 1px solid rgba(255,255,255,0.1);">
                                    <strong>50-64: Ù…Ù‚Ø¨ÙˆÙ„</strong>
                                </div>
                                <div class="grade-weak"
                                    style="padding: 12px; border-radius: 12px; text-align: center; border: 1px solid rgba(255,255,255,0.1);">
                                    <strong>0-49: Ø¶Ø¹ÙŠÙ</strong>
                                </div>
                            </div>
                        </div>
                    </div>

                    <div style="margin-top: 20px;">
                        <button onclick="clearAllData()" class="danger">ğŸ—‘ï¸ Ù…Ø³Ø­ Ø¬Ù…ÙŠØ¹ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª</button>
                        <button onclick="exportAllSettings()" class="primary">ğŸ“¤ ØªØµØ¯ÙŠØ± Ø¬Ù…ÙŠØ¹ Ø§Ù„Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª ÙˆØ§Ù„Ø¨ÙŠØ§Ù†Ø§Øª</button>


                        <button onclick="document.getElementById('excelInput').click()" class="secondary">
                            ğŸ“‚ Ø§Ø³ØªÙŠØ±Ø§Ø¯ Ù…Ù„Ù Excel
                        </button>
                        <div style="height: 20px;"></div>
                        <button onclick="downloadJSONDatabase()" class="primary"
                            style="background: #f59e0b; width: 100%;">
                            ğŸ’¾ ØªØ­Ù…ÙŠÙ„ Ù…Ù„Ù Ù‚Ø§Ø¹Ø¯Ø© Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª (students.json)
                        </button>
                        <p style="color: #ccc; font-size: 0.8rem; margin-top: 5px;">
                            * Ø§Ø±ÙØ¹ Ù‡Ø°Ø§ Ø§Ù„Ù…Ù„Ù Ù„Ù„Ù…ÙˆÙ‚Ø¹ Ù„ÙƒÙŠ ØªØ¸Ù‡Ø± Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ù„Ù„Ø·Ù„Ø§Ø¨ ÙÙŠ Ø§Ù„Ù‡ÙˆØ§ØªÙ.
                        </p>
                        <button onclick="document.getElementById('importFile').click()" class="warning"
                            style="margin-top: 20px;">ğŸ“¥ Ø§Ø³ØªÙŠØ±Ø§Ø¯ Ù†Ø³Ø®Ø© Ø§Ø­ØªÙŠØ§Ø·ÙŠØ©</button>
                        <button onclick="syncToFirebase()" class="success"
                            style="background: #10b981; margin-top: 10px; width: 100%;">â˜ï¸ Ù…Ø²Ø§Ù…Ù†Ø© Ø¬Ù…ÙŠØ¹ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ù…Ø¹
                            Ø§Ù„Ø³Ø­Ø§Ø¨Ø©</button>
                        <input type="file" id="importFile" accept=".json" style="display: none;"
                            onchange="importAllSettings(event)">
                    </div>

                    <div class="form-section" style="margin-top: 25px; border-color: var(--warning-color);">
                        <h4>ğŸ“‹ Ù…Ø¹Ù„ÙˆÙ…Ø§Øª Ø§Ù„Ù†Ø³Ø®Ø© Ø§Ù„Ø§Ø­ØªÙŠØ§Ø·ÙŠØ©:</h4>
                        <ul
                            style="text-align: right; margin-right: 20px; line-height: 2; color: var(--text-muted); margin-top: 15px;">
                            <li>ğŸ“¤ <strong>Ø§Ù„ØªØµØ¯ÙŠØ± Ø§Ù„Ø´Ø§Ù…Ù„:</strong> ÙŠØ­ØªÙˆÙŠ Ø¹Ù„Ù‰ Ø¬Ù…ÙŠØ¹ Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ù†Ø¸Ø§Ù…</li>
                            <li>ğŸ‘¥ <strong>Ø§Ù„Ø·Ù„Ø§Ø¨ ÙˆØ§Ù„Ø¯Ø±Ø¬Ø§Øª:</strong> Ø¬Ù…ÙŠØ¹ Ø§Ù„Ø·Ù„Ø§Ø¨ ÙˆÙ…ÙˆØ§Ø¯Ù‡Ù… ÙˆØ¯Ø±Ø¬Ø§ØªÙ‡Ù…</li>
                            <li>ğŸ¢ <strong>Ø§Ù„Ø£Ù‚Ø³Ø§Ù…:</strong> Ø§Ù„Ø£Ù‚Ø³Ø§Ù… Ø§Ù„Ø§ÙØªØ±Ø§Ø¶ÙŠØ© ÙˆØ§Ù„Ù…Ø¶Ø§ÙØ©</li>
                            <li>ğŸ“š <strong>Ø§Ù„Ù…ÙˆØ§Ø¯ Ø§Ù„Ù…Ø®ØµØµØ©:</strong> Ø§Ù„Ù…ÙˆØ§Ø¯ Ø§Ù„Ù…Ø¶Ø§ÙØ© Ù„ÙƒÙ„ Ù‚Ø³Ù… ÙˆÙØµÙ„</li>
                            <li>ğŸš« <strong>Ø§Ù„Ø·Ù„Ø§Ø¨ Ø§Ù„Ù…Ø­Ø¬ÙˆØ¨ÙŠÙ†:</strong> Ù‚Ø§Ø¦Ù…Ø© Ø§Ù„Ø·Ù„Ø§Ø¨ Ø§Ù„Ù…Ø­Ø¬ÙˆØ¨ÙŠÙ† ÙˆØ£Ø³Ø¨Ø§Ø¨ Ø§Ù„Ø­Ø¬Ø¨</li>
                            <li>âš™ï¸ <strong>Ø§Ù„Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª:</strong> Ø¬Ù…ÙŠØ¹ Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª Ø§Ù„Ù†Ø¸Ø§Ù…</li>
                            <li>ğŸ“Š <strong>Ø§Ù„Ø¥Ø­ØµØ§Ø¦ÙŠØ§Øª:</strong> Ù…Ø¹Ù„ÙˆÙ…Ø§Øª Ø¥Ø­ØµØ§Ø¦ÙŠØ© Ø¹Ù† Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª</li>
                        </ul>

                        <div class="admin-settings" style="margin-top: 15px; padding: 15px;">
                            <strong>âš ï¸ Ù…Ù„Ø§Ø­Ø¸Ø© Ù‡Ø§Ù…Ø©:</strong> Ø¹Ù†Ø¯ Ø§Ø³ØªÙŠØ±Ø§Ø¯ Ù†Ø³Ø®Ø© Ø§Ø­ØªÙŠØ§Ø·ÙŠØ©ØŒ Ø³ÙŠØªÙ… Ø§Ø³ØªØ¨Ø¯Ø§Ù„ Ø¬Ù…ÙŠØ¹ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª
                            Ø§Ù„Ø­Ø§Ù„ÙŠØ© Ø¨Ø§Ù„ÙƒØ§Ù…Ù„
                        </div>
                    </div>
                </div>
            </div>

            <div id="statusMessage" class="status-message" style="display: none;"></div>
        </div>
    </div>

    <!-- User Management Modal -->
    <div id="userModal" class="modal" style="display: none;">
        <div class="modal-content" style="max-width: 600px; width: 90%;">
            <div class="modal-header">
                <h3 id="userModalTitle">Ø¥Ø¶Ø§ÙØ© Ù…Ø³ØªØ®Ø¯Ù… Ø¬Ø¯ÙŠØ¯</h3>
                <span class="close" onclick="closeUserModal()">&times;</span>
            </div>
            <div class="modal-body">
                <form id="userForm">
                    <div class="form-group">
                        <label for="userName">Ø§Ø³Ù… Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…:</label>
                        <input type="text" id="userName" required
                            style="width: 100%; padding: 10px; border: 1px solid var(--border-color); border-radius: 5px; background: rgba(15, 23, 42, 0.4); color: var(--text-color);">
                    </div>

                    <div class="form-group">
                        <label for="userEmail">Ø§Ù„Ø¨Ø±ÙŠØ¯ Ø§Ù„Ø¥Ù„ÙƒØªØ±ÙˆÙ†ÙŠ:</label>
                        <input type="email" id="userEmail" required
                            style="width: 100%; padding: 10px; border: 1px solid var(--border-color); border-radius: 5px; background: rgba(15, 23, 42, 0.4); color: var(--text-color);">
                    </div>

                    <div class="form-group">
                        <label for="userPassword">ÙƒÙ„Ù…Ø© Ø§Ù„Ù…Ø±ÙˆØ±:</label>
                        <input type="password" id="userPassword" required
                            style="width: 100%; padding: 10px; border: 1px solid var(--border-color); border-radius: 5px; background: rgba(15, 23, 42, 0.4); color: var(--text-color);">
                        <button type="button" onclick="generatePassword()"
                            style="margin-top: 5px; padding: 5px 10px; background: #6c757d; color: white; border: none; border-radius: 3px; cursor: pointer;">
                            ğŸ”‘ Ø¥Ù†Ø´Ø§Ø¡ ÙƒÙ„Ù…Ø© Ù…Ø±ÙˆØ± Ø¹Ø´ÙˆØ§Ø¦ÙŠØ©
                        </button>
                    </div>

                    <div class="form-group">
                        <label for="userRole">Ø§Ù„Ø¯ÙˆØ±:</label>
                        <select id="userRole" onchange="updatePermissionsVisibility()"
                            style="width: 100%; padding: 10px; border: 1px solid var(--border-color); border-radius: 5px; background: rgba(15, 23, 42, 0.4); color: var(--text-color);">
                            <option value="admin">Ù…Ø¯ÙŠØ±</option>
                            <option value="data_entry">Ù…Ø¯Ø®Ù„ Ø¨ÙŠØ§Ù†Ø§Øª</option>
                            <option value="viewer">Ù…Ø´Ø§Ù‡Ø¯ ÙÙ‚Ø·</option>
                        </select>
                    </div>

                    <div class="form-group">
                        <label>ğŸ” Ø§Ù„ØµÙ„Ø§Ø­ÙŠØ§Øª:</label>
                        <div id="permissionsContainer" class="form-section" style="margin-top: 15px; padding: 20px;">
                            <div
                                style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 15px;">
                                <label style="display: flex; align-items: center; gap: 10px;">
                                    <input type="checkbox" id="perm_add_students">
                                    <span>Ø¥Ø¶Ø§ÙØ© Ø·Ù„Ø§Ø¨ Ø¬Ø¯Ø¯</span>
                                </label>
                                <label style="display: flex; align-items: center; gap: 10px;">
                                    <input type="checkbox" id="perm_edit_students">
                                    <span>ØªØ¹Ø¯ÙŠÙ„ Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ø·Ù„Ø§Ø¨</span>
                                </label>
                                <label style="display: flex; align-items: center; gap: 10px;">
                                    <input type="checkbox" id="perm_delete_students">
                                    <span>Ø­Ø°Ù Ø§Ù„Ø·Ù„Ø§Ø¨</span>
                                </label>
                                <label style="display: flex; align-items: center; gap: 10px;">
                                    <input type="checkbox" id="perm_export_excel">
                                    <span>ØªØµØ¯ÙŠØ± Excel</span>
                                </label>
                                <label style="display: flex; align-items: center; gap: 10px;">
                                    <input type="checkbox" id="perm_import_excel">
                                    <span>Ø§Ø³ØªÙŠØ±Ø§Ø¯ Excel</span>
                                </label>
                                <label style="display: flex; align-items: center; gap: 10px;">
                                    <input type="checkbox" id="perm_manage_departments">
                                    <span>Ø¥Ø¯Ø§Ø±Ø© Ø§Ù„Ø£Ù‚Ø³Ø§Ù…</span>
                                </label>
                                <label style="display: flex; align-items: center; gap: 10px;">
                                    <input type="checkbox" id="perm_manage_users">
                                    <span>Ø¥Ø¯Ø§Ø±Ø© Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…ÙŠÙ†</span>
                                </label>
                                <label style="display: flex; align-items: center; gap: 10px;">
                                    <input type="checkbox" id="perm_view_statistics">
                                    <span>Ø¹Ø±Ø¶ Ø§Ù„Ø¥Ø­ØµØ§Ø¦ÙŠØ§Øª</span>
                                </label>
                                <label style="display: flex; align-items: center; gap: 10px;">
                                    <input type="checkbox" id="perm_block_students">
                                    <span>Ø­Ø¬Ø¨ Ø§Ù„Ø·Ù„Ø§Ø¨</span>
                                </label>
                                <label style="display: flex; align-items: center; gap: 10px;">
                                    <input type="checkbox" id="perm_backup_restore">
                                    <span>Ø§Ù„Ù†Ø³Ø® Ø§Ù„Ø§Ø­ØªÙŠØ§Ø·ÙŠ ÙˆØ§Ù„Ø§Ø³ØªØ¹Ø§Ø¯Ø©</span>
                                </label>
                            </div>
                        </div>
                    </div>

                    <div class="form-group">
                        <label for="userStatus">Ø§Ù„Ø­Ø§Ù„Ø©:</label>
                        <select id="userStatus"
                            style="width: 100%; padding: 10px; border: 1px solid var(--border-color); border-radius: 5px; background: rgba(15, 23, 42, 0.4); color: var(--text-color);">
                            <option value="active">Ù†Ø´Ø·</option>
                            <option value="inactive">ØºÙŠØ± Ù†Ø´Ø·</option>
                        </select>
                    </div>

                    <div style="text-align: left; margin-top: 20px;">
                        <button type="button" onclick="saveUser()" class="primary"
                            style="background: linear-gradient(135deg, #28a745 0%, #20c997 100%); color: white; border: none; padding: 10px 20px; border-radius: 8px; cursor: pointer; font-weight: bold;">
                            ğŸ’¾ Ø­ÙØ¸ Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…
                        </button>
                        <button type="button" onclick="closeUserModal()" class="secondary"
                            style="background: #6c757d; color: white; border: none; padding: 10px 20px; border-radius: 8px; cursor: pointer; font-weight: bold; margin-right: 10px;">
                            Ø¥Ù„ØºØ§Ø¡
                        </button>
                    </div>
                </form>
            </div>
        </div>
    </div>
    <!-- Firebase SDKs -->
    <script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-firestore-compat.js"></script>

    <script>
        // Initialize students data
        let students = JSON.parse(localStorage.getItem('students')) || [];
        let currentUser = null;
        let users = JSON.parse(localStorage.getItem('users')) || [];
        let db = null;

        // Firebase Configuration
        const firebaseConfig = {
            apiKey: "YOUR_API_KEY",
            authDomain: "hist-js.firebaseapp.com",
            projectId: "hist-js",
            storageBucket: "hist-js.appspot.com",
            messagingSenderId: "YOUR_SENDER_ID",
            appId: "YOUR_APP_ID"
        };

        // Initialize Firebase
        try {
            if (firebaseConfig.apiKey !== "YOUR_API_KEY") {
                firebase.initializeApp(firebaseConfig);
                db = firebase.firestore();
                console.log('âœ… Firebase Initialized successfully');

                // Fetch blocked students from Cloud immediately
                fetchBlockedStudentsFromCloud();
            } else {
                console.warn('âš ï¸ Firebase credentials not set. Cloud sync disabled.');
            }
        } catch (error) {
            console.error('âŒ Firebase Error:', error);
        }

        // Fetch blocked students from Firebase
        async function fetchBlockedStudentsFromCloud() {
            if (!db) return;
            try {
                const snapshot = await db.collection('blockedStudents').get();
                const cloudBlocked = [];
                snapshot.forEach(doc => cloudBlocked.push(doc.data()));

                if (cloudBlocked.length > 0) {
                    localStorage.setItem('blockedStudents', JSON.stringify(cloudBlocked));
                    console.log(`ğŸ“¡ Synced ${cloudBlocked.length} blocked students from Cloud`);

                    // Update UI if on the block-student tab
                    if (typeof loadBlockedStudents === 'function') {
                        loadBlockedStudents();
                    }
                }
            } catch (error) {
                console.error('âŒ Failed to fetch blocked students from Cloud:', error);
            }
        }

        // Sync data to Firebase
        async function syncToFirebase(studentData = null) {
            if (!db) return;

            try {
                if (studentData) {
                    // Sync single student if provided
                    await db.collection('students').doc(studentData.id).set(studentData);
                    console.log('âœ… Student synced to Cloud:', studentData.id);
                } else {
                    // Sync all students (batch or sequence)
                    const batch = db.batch();
                    const allStudents = JSON.parse(localStorage.getItem('students')) || [];

                    allStudents.forEach(student => {
                        const ref = db.collection('students').doc(student.id);
                        batch.set(ref, student);
                    });

                    await batch.commit();
                    console.log('âœ… All students synced to Cloud');

                    // Also sync blocked students
                    await syncBlockedStudentsToCloud();
                }
            } catch (error) {
                console.error('âŒ Cloud Sync failed:', error);
            }
        }

        // Sync blocked students to Firebase
        async function syncBlockedStudentsToCloud() {
            if (!db) return;
            try {
                const blockedStudents = JSON.parse(localStorage.getItem('blockedStudents') || '[]');
                const batch = db.batch();

                // Clear existing blocked collection in Firebase might be hard, 
                // but we can just set each one. 
                // For a more robust solution, we should probably use a single doc for all blocked IDs 
                // or handle deletions properly.

                // Let's use individual docs in a 'blockedStudents' collection
                for (const blocked of blockedStudents) {
                    const ref = db.collection('blockedStudents').doc(blocked.studentId);
                    batch.set(ref, blocked);
                }

                await batch.commit();
                console.log('âœ… Blocked students synced to Cloud');
            } catch (error) {
                console.error('âŒ Blocked sync failed:', error);
            }
        }

        // Make students globally accessible and ensure it's always in sync
        window.getStudents = function () {
            return JSON.parse(localStorage.getItem('students')) || [];
        };

        window.refreshStudents = function () {
            students = JSON.parse(localStorage.getItem('students')) || [];
        };

        // User Management System
        function showAddUserModal() {
            document.getElementById('userModalTitle').textContent = 'Ø¥Ø¶Ø§ÙØ© Ù…Ø³ØªØ®Ø¯Ù… Ø¬Ø¯ÙŠØ¯';
            document.getElementById('userForm').reset();
            document.getElementById('userModal').style.display = 'block';
            updatePermissionsVisibility();
        }

        function closeUserModal() {
            document.getElementById('userModal').style.display = 'none';
        }

        function generatePassword() {
            const chars = 'ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789!@#$%^&*';
            let password = '';
            for (let i = 0; i < 12; i++) {
                password += chars.charAt(Math.floor(Math.random() * chars.length));
            }
            document.getElementById('userPassword').value = password;
        }

        function updatePermissionsVisibility() {
            const role = document.getElementById('userRole').value;
            const permissionsContainer = document.getElementById('permissionsContainer');

            if (role === 'admin') {
                // Admin gets all permissions
                const checkboxes = permissionsContainer.querySelectorAll('input[type="checkbox"]');
                checkboxes.forEach(checkbox => {
                    checkbox.checked = true;
                    checkbox.disabled = false;
                });
            } else if (role === 'data_entry') {
                // Data entry gets specific permissions
                const permissions = {
                    'perm_add_students': true,
                    'perm_edit_students': true,
                    'perm_delete_students': false,
                    'perm_export_excel': true,
                    'perm_import_excel': true,
                    'perm_manage_departments': false,
                    'perm_manage_users': false,
                    'perm_view_statistics': true,
                    'perm_block_students': false,
                    'perm_backup_restore': false
                };

                Object.keys(permissions).forEach(permId => {
                    const checkbox = document.getElementById(permId);
                    if (checkbox) {
                        checkbox.checked = permissions[permId];
                        checkbox.disabled = false;
                    }
                });
            } else if (role === 'viewer') {
                // Viewer only gets view permissions
                const permissions = {
                    'perm_add_students': false,
                    'perm_edit_students': false,
                    'perm_delete_students': false,
                    'perm_export_excel': true,
                    'perm_import_excel': false,
                    'perm_manage_departments': false,
                    'perm_manage_users': false,
                    'perm_view_statistics': true,
                    'perm_block_students': false,
                    'perm_backup_restore': false
                };

                Object.keys(permissions).forEach(permId => {
                    const checkbox = document.getElementById(permId);
                    if (checkbox) {
                        checkbox.checked = permissions[permId];
                        checkbox.disabled = false;
                    }
                });
            }
        }

        function saveUser() {
            const name = document.getElementById('userName').value.trim();
            const email = document.getElementById('userEmail').value.trim();
            const password = document.getElementById('userPassword').value;
            const role = document.getElementById('userRole').value;
            const status = document.getElementById('userStatus').value;

            if (!name || !email || !password) {
                showStatus('ÙŠØ±Ø¬Ù‰ Ù…Ù„Ø¡ Ø¬Ù…ÙŠØ¹ Ø§Ù„Ø­Ù‚ÙˆÙ„ Ø§Ù„Ù…Ø·Ù„ÙˆØ¨Ø©', 'error');
                return;
            }

            // Get permissions
            const permissions = {};
            const checkboxes = document.querySelectorAll('#permissionsContainer input[type="checkbox"]');
            checkboxes.forEach(checkbox => {
                permissions[checkbox.id.replace('perm_', '')] = checkbox.checked;
            });

            // Check if email already exists
            const existingUser = users.find(u => u.email === email);
            if (existingUser) {
                showStatus('Ø§Ù„Ø¨Ø±ÙŠØ¯ Ø§Ù„Ø¥Ù„ÙƒØªØ±ÙˆÙ†ÙŠ Ù…Ø³ØªØ®Ø¯Ù… Ø¨Ø§Ù„ÙØ¹Ù„', 'error');
                return;
            }

            // Create user object
            const user = {
                id: 'user_' + Date.now(),
                name: name,
                email: email,
                password: btoa(password), // Simple encoding (in production, use proper hashing)
                role: role,
                status: status,
                permissions: permissions,
                createdDate: new Date().toLocaleString('ar-SA'),
                lastLogin: null,
                createdBy: currentUser ? currentUser.name : 'System'
            };

            // Save user
            users.push(user);
            localStorage.setItem('users', JSON.stringify(users));

            showStatus(`ØªÙ… Ø¥Ø¶Ø§ÙØ© Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù… "${name}" Ø¨Ù†Ø¬Ø§Ø­`, 'success');
            closeUserModal();

            // Refresh users list if visible
            if (document.getElementById('usersList').style.display !== 'none') {
                showUsersList();
            }
        }

        function showUsersList() {
            const usersList = document.getElementById('usersList');
            users = JSON.parse(localStorage.getItem('users')) || [];

            if (users.length === 0) {
                usersList.innerHTML = '<p style="text-align: center; color: #666;">Ù„Ø§ ÙŠÙˆØ¬Ø¯ Ù…Ø³ØªØ®Ø¯Ù…ÙˆÙ† Ø­Ø§Ù„ÙŠØ§Ù‹</p>';
                usersList.style.display = 'block';
                return;
            }

            let html = `
                <div style="background: var(--card-bg); backdrop-filter: var(--glass); border: 1px solid var(--border-color); border-radius: 8px; overflow: hidden; box-shadow: 0 2px 10px rgba(0,0,0,0.1);">
                    <table style="width: 100%; border-collapse: collapse;">
                        <thead>
                            <tr style="background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white;">
                                <th style="padding: 12px; text-align: right;">Ø§Ù„Ø§Ø³Ù…</th>
                                <th style="padding: 12px; text-align: right;">Ø§Ù„Ø¨Ø±ÙŠØ¯ Ø§Ù„Ø¥Ù„ÙƒØªØ±ÙˆÙ†ÙŠ</th>
                                <th style="padding: 12px; text-align: right;">Ø§Ù„Ø¯ÙˆØ±</th>
                                <th style="padding: 12px; text-align: right;">Ø§Ù„Ø­Ø§Ù„Ø©</th>
                                <th style="padding: 12px; text-align: right;">Ø¢Ø®Ø± ØªØ³Ø¬ÙŠÙ„ Ø¯Ø®ÙˆÙ„</th>
                                <th style="padding: 12px; text-align: right;">Ø¥Ø¬Ø±Ø§Ø¡Ø§Øª</th>
                            </tr>
                        </thead>
                        <tbody>
            `;

            users.forEach(user => {
                const statusColor = user.status === 'active' ? '#28a745' : '#dc3545';
                const statusText = user.status === 'active' ? 'Ù†Ø´Ø·' : 'ØºÙŠØ± Ù†Ø´Ø·';
                const roleText = user.role === 'admin' ? 'Ù…Ø¯ÙŠØ±' : user.role === 'data_entry' ? 'Ù…Ø¯Ø®Ù„ Ø¨ÙŠØ§Ù†Ø§Øª' : 'Ù…Ø´Ø§Ù‡Ø¯';

                html += `
                    <tr style="border-bottom: 1px solid var(--border-color); color: var(--text-color);">
                        <td style="padding: 12px;">${user.name}</td>
                        <td style="padding: 12px;">${user.email}</td>
                        <td style="padding: 12px;">${roleText}</td>
                        <td style="padding: 12px;">
                            <span style="background: ${statusColor}; color: white; padding: 3px 8px; border-radius: 12px; font-size: 12px;">
                                ${statusText}
                            </span>
                        </td>
                        <td style="padding: 12px;">${user.lastLogin || 'Ù„Ù… ÙŠØ³Ø¬Ù„ Ø¯Ø®ÙˆÙ„Ù‡ Ø¨Ø¹Ø¯'}</td>
                        <td style="padding: 12px;">
                            <button onclick="editUser('${user.id}')" style="background: #007bff; color: white; border: none; padding: 5px 10px; border-radius: 3px; cursor: pointer; margin-left: 5px;">
                                âœï¸ ØªØ¹Ø¯ÙŠÙ„
                            </button>
                            <button onclick="deleteUser('${user.id}')" style="background: #dc3545; color: white; border: none; padding: 5px 10px; border-radius: 3px; cursor: pointer; margin-left: 5px;">
                                ğŸ—‘ï¸ Ø­Ø°Ù
                            </button>
                            <button onclick="resetPassword('${user.id}')" style="background: #6c757d; color: white; border: none; padding: 5px 10px; border-radius: 3px; cursor: pointer;">
                                ğŸ”‘ Ø¥Ø¹Ø§Ø¯Ø© ØªØ¹ÙŠÙŠÙ† ÙƒÙ„Ù…Ø© Ø§Ù„Ù…Ø±ÙˆØ±
                            </button>
                        </td>
                    </tr>
                `;
            });

            html += `
                        </tbody>
                    </table>
                </div>
            `;

            usersList.innerHTML = html;
            usersList.style.display = 'block';
        }

        function editUser(userId) {
            const user = users.find(u => u.id === userId);
            if (!user) return;

            document.getElementById('userModalTitle').textContent = 'ØªØ¹Ø¯ÙŠÙ„ Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…';
            document.getElementById('userName').value = user.name;
            document.getElementById('userEmail').value = user.email;
            document.getElementById('userPassword').value = '';
            document.getElementById('userRole').value = user.role;
            document.getElementById('userStatus').value = user.status;

            // Set permissions
            Object.keys(user.permissions).forEach(perm => {
                const checkbox = document.getElementById('perm_' + perm);
                if (checkbox) {
                    checkbox.checked = user.permissions[perm];
                }
            });

            // Store editing user ID
            document.getElementById('userForm').dataset.editingUserId = userId;

            document.getElementById('userModal').style.display = 'block';
        }

        function deleteUser(userId) {
            if (!confirm('Ù‡Ù„ Ø£Ù†Øª Ù…ØªØ£ÙƒØ¯ Ù…Ù† Ø­Ø°Ù Ù‡Ø°Ø§ Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…ØŸ')) return;

            users = users.filter(u => u.id !== userId);
            localStorage.setItem('users', JSON.stringify(users));

            showStatus('ØªÙ… Ø­Ø°Ù Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù… Ø¨Ù†Ø¬Ø§Ø­', 'success');
            showUsersList();
        }

        function resetPassword(userId) {
            const user = users.find(u => u.id === userId);
            if (!user) return;

            const newPassword = prompt('Ø£Ø¯Ø®Ù„ ÙƒÙ„Ù…Ø© Ø§Ù„Ù…Ø±ÙˆØ± Ø§Ù„Ø¬Ø¯ÙŠØ¯Ø©:', '');
            if (!newPassword) return;

            user.password = btoa(newPassword);
            localStorage.setItem('users', JSON.stringify(users));

            showStatus(`ØªÙ… Ø¥Ø¹Ø§Ø¯Ø© ØªØ¹ÙŠÙŠÙ† ÙƒÙ„Ù…Ø© Ø§Ù„Ù…Ø±ÙˆØ± Ù„Ù„Ù…Ø³ØªØ®Ø¯Ù… "${user.name}" Ø¨Ù†Ø¬Ø§Ø­`, 'success');
        }

        // Save required subject rule setting
        function saveRequiredSubjectRule() {
            const enabled = document.getElementById('requiredSubjectRuleEnabled').checked;
            settings.requiredSubjectRuleEnabled = enabled;
            localStorage.setItem('adminSettings', JSON.stringify(settings));
            showStatus(`ØªÙ… ${enabled ? 'ØªÙØ¹ÙŠÙ„' : 'Ø¥Ù„ØºØ§Ø¡ ØªÙØ¹ÙŠÙ„'} Ø´Ø±Ø· Ø§Ù„Ø±Ø³ÙˆØ¨ Ù„Ù„Ù…ÙˆØ§Ø¯ Ø§Ù„Ù…Ø·Ø§Ù„Ø¨Ø©`, 'success');
        }

        // Initialize settings
        let settings = JSON.parse(localStorage.getItem('adminSettings')) || {
            failRuleEnabled: true,
            requiredSubjectRuleEnabled: true
        };

        // Load required subject rule setting on page load
        function loadRequiredSubjectRule() {
            const checkbox = document.getElementById('requiredSubjectRuleEnabled');
            if (checkbox) {
                checkbox.checked = settings.requiredSubjectRuleEnabled !== false; // Default to true
            }
        }

        // Make functions global - define them early
        window.displayStudentResult = function (studentId) {
            console.log('=== displayStudentResult START ===');
            console.log('Student ID:', studentId);
            console.log('Students array:', students);
            console.log('Students length:', students.length);

            const student = students.find(s => s.id === studentId);
            console.log('Found student:', student);

            if (!student) {
                console.log('Student not found!');
                alert('Ø§Ù„Ø·Ø§Ù„Ø¨ ØºÙŠØ± Ù…ÙˆØ¬ÙˆØ¯');
                return;
            }

            console.log('Student found, name:', student.name);

            const resultDisplayDiv = document.getElementById('studentResultDisplay');
            console.log('Display element:', resultDisplayDiv);

            if (!resultDisplayDiv) {
                console.log('Display element not found!');
                alert('Ø¹Ù†ØµØ± Ø§Ù„Ø¹Ø±Ø¶ ØºÙŠØ± Ù…ÙˆØ¬ÙˆØ¯');
                return;
            }

            console.log('Creating HTML content...');

            // Very simple display
            const htmlContent = `
                <div style="padding: 20px; background: #e8f4fd; border: 3px solid #007bff; border-radius: 15px; margin: 20px;">
                    <h2 style="color: #007bff; margin-bottom: 15px;">ğŸ“ Ù†ØªÙŠØ¬Ø© Ø§Ù„Ø·Ø§Ù„Ø¨</h2>
                    <div style="background: white; padding: 15px; border-radius: 10px;">
                        <p style="margin: 10px 0;"><strong>Ø§Ù„Ø§Ø³Ù…:</strong> <span style="color: #007bff; font-size: 18px;">${student.name}</span></p>
                        <p style="margin: 10px 0;"><strong>Ø§Ù„Ø±Ù‚Ù…:</strong> <span style="color: #495057;">${student.id}</span></p>
                        <p style="margin: 10px 0;"><strong>Ø§Ù„Ù‚Ø³Ù…:</strong> <span style="color: #495057;">${student.department}</span></p>
                        <p style="margin: 10px 0;"><strong>Ø§Ù„ÙØµÙ„:</strong> <span style="color: #495057;">${student.semester}</span></p>
                        <p style="margin: 10px 0;"><strong>Ø¹Ø¯Ø¯ Ø§Ù„Ù…ÙˆØ§Ø¯:</strong> <span style="color: #495057;">${student.subjects ? student.subjects.length : 0}</span></p>
                    </div>
                    <div style="text-align: center; margin-top: 15px;">
                        <button onclick="this.parentElement.parentElement.parentElement.style.display='none'" style="background: #dc3545; color: white; border: none; padding: 10px 20px; border-radius: 5px; cursor: pointer;">Ø¥ØºÙ„Ø§Ù‚</button>
                    </div>
                </div>
            `;

            console.log('Setting innerHTML...');
            resultDisplayDiv.innerHTML = htmlContent;

            console.log('Making it visible...');
            resultDisplayDiv.style.display = 'block';

            console.log('Scrolling to element...');
            resultDisplayDiv.scrollIntoView({ behavior: 'smooth' });

            console.log('=== displayStudentResult END ===');
        };

        window.deleteStudent = function (studentId) {
            if (confirm('Ù‡Ù„ Ø£Ù†Øª Ù…ØªØ£ÙƒØ¯ Ù…Ù† Ø­Ø°Ù Ù‡Ø°Ø§ Ø§Ù„Ø·Ø§Ù„Ø¨ØŸ')) {
                students = students.filter(s => s.id !== studentId);
                localStorage.setItem('students', JSON.stringify(students));

                // Refresh students data
                window.refreshStudents();

                showStatus('ØªÙ… Ø­Ø°Ù Ø§Ù„Ø·Ø§Ù„Ø¨ Ø¨Ù†Ø¬Ø§Ø­', 'success');
                loadAllStudents();
            }
        };

        // Current state
        let currentSemester = 1;
        let selectedSubjects = [];

        // Department subjects database
        const departmentSubjects = {
            'Ø§Ù„ØªÙ…ÙˆÙŠÙ„ ÙˆØ§Ù„Ù…ØµØ§Ø±Ù': {
                1: [
                    { name: 'Ù…Ø¨Ø§Ø¯Ø¦ Ø§Ù„Ù…Ø­Ø§Ø³Ø¨Ø©', units: 3 },
                    { name: 'Ø±ÙŠØ§Ø¶ÙŠØ§Øª Ù…Ø§Ù„ÙŠØ©', units: 3 },
                    { name: 'Ù…Ø¨Ø§Ø¯Ø¦ Ø§Ù„Ø§Ù‚ØªØµØ§Ø¯', units: 3 },
                    { name: 'Ø§Ù„Ù„ØºØ© Ø§Ù„Ø¹Ø±Ø¨ÙŠØ©', units: 2 },
                    { name: 'Ø§Ù„Ù„ØºØ© Ø§Ù„Ø¥Ù†Ø¬Ù„ÙŠØ²ÙŠØ©', units: 2 },
                    { name: 'Ù…Ù‡Ø§Ø±Ø§Øª Ø§Ù„Ø­Ø§Ø³ÙˆØ¨', units: 2 }
                ],
                2: [
                    { name: 'Ù…Ø­Ø§Ø³Ø¨Ø© Ø´Ø±ÙƒØ§Øª', units: 3 },
                    { name: 'Ø§Ù„ØªØ¯Ù‚ÙŠÙ‚ Ø§Ù„Ù…Ø­Ø§Ø³Ø¨ÙŠ', units: 3 },
                    { name: 'Ø¥Ø¯Ø§Ø±Ø© Ù…Ø§Ù„ÙŠØ©', units: 3 },
                    { name: 'Ø§Ù„Ø¥Ø­ØµØ§Ø¡ Ø§Ù„Ù…Ø§Ù„ÙŠ', units: 2 },
                    { name: 'Ù‚ÙˆØ§Ù†ÙŠÙ† Ø§Ù„Ø£Ø¹Ù…Ø§Ù„', units: 2 },
                    { name: 'Ø§Ù„ØªØ³ÙˆÙŠÙ‚ Ø§Ù„Ù…Ø§Ù„ÙŠ', units: 2 }
                ],
                3: [
                    { name: 'Ù…Ø­Ø§Ø³Ø¨Ø© Ù…ØªÙ‚Ø¯Ù…Ø©', units: 3 },
                    { name: 'Ù…Ø­Ø§Ø³Ø¨Ø© Ø¶Ø±ÙŠØ¨ÙŠØ©', units: 3 },
                    { name: 'ØªÙ…ÙˆÙŠÙ„ Ø¯ÙˆÙ„ÙŠ', units: 3 },
                    { name: 'ØªØ­Ù„ÙŠÙ„ Ù…Ø§Ù„ÙŠ', units: 2 },
                    { name: 'Ø£Ø®Ù„Ø§Ù‚ÙŠØ§Øª Ø§Ù„Ù…Ø­Ø§Ø³Ø¨Ø©', units: 2 },
                    { name: 'Ù†Ø¸Ù… Ù…Ø¹Ù„ÙˆÙ…Ø§Øª Ù…Ø­Ø§Ø³Ø¨ÙŠØ©', units: 2 }
                ],
                4: [
                    { name: 'Ù…Ø­Ø§Ø³Ø¨Ø© Ø¥Ø¯Ø§Ø±ÙŠØ©', units: 3 },
                    { name: 'ØªØ¯Ù‚ÙŠÙ‚ Ù…ØªÙ‚Ø¯Ù…', units: 3 },
                    { name: 'Ø¥Ø¯Ø§Ø±Ø© Ø§Ø³ØªØ«Ù…Ø§Ø±', units: 3 },
                    { name: 'Ø£Ø³ÙˆØ§Ù‚ Ù…Ø§Ù„ÙŠØ©', units: 2 },
                    { name: 'Ù…Ø®Ø§Ø·Ø± Ù…Ø§Ù„ÙŠØ©', units: 2 },
                    { name: 'Ù…Ø´Ø±ÙˆØ¹ ØªØ®Ø±Ø¬', units: 2 }
                ],
                5: [
                    { name: 'Ù…Ø­Ø§Ø³Ø¨Ø© Ø­ÙƒÙˆÙ…ÙŠØ©', units: 3 },
                    { name: 'ØªØ®Ø·ÙŠØ· Ù…Ø§Ù„ÙŠ', units: 3 },
                    { name: 'Ù…ØµØ§Ø±Ù Ø¥Ø³Ù„Ø§Ù…ÙŠØ©', units: 3 },
                    { name: 'ØªÙ…ÙˆÙŠÙ„ Ø¹Ù‚Ø§Ø±ÙŠ', units: 2 },
                    { name: 'Ø¥Ø¯Ø§Ø±Ø© Ù…Ø­Ø§ÙØ¸', units: 2 },
                    { name: 'Ø¨Ø­Ø« ØªØ·Ø¨ÙŠÙ‚ÙŠ', units: 2 }
                ],
                6: [
                    { name: 'Ø§Ø³ØªØ´Ø§Ø±Ø§Øª Ù…Ø§Ù„ÙŠØ©', units: 3 },
                    { name: 'Ù…Ø­Ø§Ø³Ø¨Ø© Ø¯ÙˆÙ„ÙŠØ©', units: 3 },
                    { name: 'Ø­ÙˆÙƒÙ…Ø© Ø§Ù„Ø´Ø±ÙƒØ§Øª', units: 3 },
                    { name: 'Ø±ÙŠØ§Ø¯Ø© Ø§Ù„Ø£Ø¹Ù…Ø§Ù„', units: 2 },
                    { name: 'Ù…Ø´Ø±ÙˆØ¹ ØªØ®Ø±Ø¬ Ù…ØªÙ‚Ø¯Ù…', units: 2 },
                    { name: 'ØªØ¯Ø±ÙŠØ¨ Ù…ÙŠØ¯Ø§Ù†ÙŠ', units: 2 }
                ]
            },
            'Ø§Ù„Ù…Ø³Ø§Ø­Ø©': {
                1: [
                    { name: 'Ø±ÙŠØ§Ø¶ÙŠØ§Øª Ù‡Ù†Ø¯Ø³ÙŠØ©', units: 3 },
                    { name: 'ÙÙŠØ²ÙŠØ§Ø¡ Ù‡Ù†Ø¯Ø³ÙŠØ©', units: 3 },
                    { name: 'Ø±Ø³Ù… Ù‡Ù†Ø¯Ø³ÙŠ', units: 2 },
                    { name: 'Ù…Ø³Ø§Ø­Ø© Ø£Ø±Ø¶ÙŠØ© 1', units: 3 },
                    { name: 'Ø¨Ø±Ù…Ø¬Ø© Ù‡Ù†Ø¯Ø³ÙŠØ©', units: 2 },
                    { name: 'Ø§Ù„Ù„ØºØ© Ø§Ù„Ø¥Ù†Ø¬Ù„ÙŠØ²ÙŠØ©', units: 2 }
                ],
                2: [
                    { name: 'Ù…Ø³Ø§Ø­Ø© Ø£Ø±Ø¶ÙŠØ© 2', units: 3 },
                    { name: 'Ø§Ù„Ù…Ø³Ø­ Ø§Ù„ØªØµÙˆÙŠØ±ÙŠ', units: 3 },
                    { name: 'Ø¬ÙŠÙˆØ¯ÙŠØ³ÙŠØ§', units: 3 },
                    { name: 'Ù†Ù…Ø°Ø¬Ø© ØªØ¶Ø§Ø±ÙŠØ³', units: 2 },
                    { name: 'GPS ÙˆÙ†Ø¸Ù… Ø§Ù„Ù…Ø¹Ù„ÙˆÙ…Ø§Øª', units: 2 },
                    { name: 'Ù…Ø´Ø±ÙˆØ¹ ØªØ®Ø±Ø¬', units: 2 }
                ],
                3: [
                    { name: 'Ù…Ø³Ø§Ø­Ø© Ø¬ÙŠÙˆØ¯ÙŠØ³ÙŠØ©', units: 3 },
                    { name: 'Ø§Ø³ØªØ´Ø¹Ø§Ø± Ø¹Ù† Ø¨Ø¹Ø¯', units: 3 },
                    { name: 'ØªØ­Ù„ÙŠÙ„ ØµÙˆØ±', units: 3 },
                    { name: 'Ù†Ø¸Ù… Ø§Ù„Ù…Ø¹Ù„ÙˆÙ…Ø§Øª Ø§Ù„Ø¬ØºØ±Ø§ÙÙŠØ©', units: 2 },
                    { name: 'Ø®Ø±Ø§Ø¦Ø· Ø±Ù‚Ù…ÙŠØ©', units: 2 },
                    { name: 'Ù…Ø³Ø§Ø­Ø© Ø¨Ø­Ø±ÙŠØ©', units: 2 }
                ],
                4: [
                    { name: 'Ù…Ø³Ø§Ø­Ø© Ø­Ø¶Ø±ÙŠØ©', units: 3 },
                    { name: 'ØªØ®Ø·ÙŠØ· Ø¹Ù…Ø±Ø§Ù†ÙŠ', units: 3 },
                    { name: 'Ù‡Ù†Ø¯Ø³Ø© Ø§Ù„Ø·Ø±Ù‚', units: 3 },
                    { name: 'Ù…Ø³Ø§Ø­Ø© Ø§Ù„Ù…Ù†Ø§Ø¬Ù…', units: 2 },
                    { name: 'Ù…Ø³Ø§Ø­Ø© Ø¬ÙŠÙˆÙ„ÙˆØ¬ÙŠØ©', units: 2 },
                    { name: 'Ù…Ø´Ø±ÙˆØ¹ Ù…ÙŠØ¯Ø§Ù†ÙŠ', units: 2 }
                ],
                5: [
                    { name: 'Ù…Ø³Ø§Ø­Ø© Ù…ØªÙ‚Ø¯Ù…Ø©', units: 3 },
                    { name: 'Ø¶Ø¨Ø· Ø¬ÙˆØ¯Ø©', units: 3 },
                    { name: 'Ù†Ø¸Ù… ØªØ­Ø¯ÙŠØ¯ Ø§Ù„Ù…ÙˆØ§Ù‚Ø¹', units: 3 },
                    { name: 'ØªØ­Ù„ÙŠÙ„ Ø¨ÙŠØ§Ù†Ø§Øª Ù…ÙƒØ§Ù†ÙŠØ©', units: 2 },
                    { name: 'Ù…Ø³Ø§Ø­Ø© Ù‡ÙŠØ¯Ø±ÙˆÙ„ÙˆØ¬ÙŠØ©', units: 2 },
                    { name: 'Ø¨Ø­Ø« Ø¹Ù„Ù…ÙŠ', units: 2 }
                ],
                6: [
                    { name: 'Ù…Ø³Ø§Ø­Ø© Ø§Ù„Ø£Ù‚Ù…Ø§Ø± Ø§Ù„ØµÙ†Ø§Ø¹ÙŠØ©', units: 3 },
                    { name: 'Ù†Ø¸Ù… Ø§Ù„Ù…Ø¹Ù„ÙˆÙ…Ø§Øª Ø§Ù„Ù…ØªÙ‚Ø¯Ù…Ø©', units: 3 },
                    { name: 'Ø¥Ø¯Ø§Ø±Ø© Ø§Ù„Ù…Ø´Ø§Ø±ÙŠØ¹', units: 3 },
                    { name: 'Ù‚ÙˆØ§Ù†ÙŠÙ† Ø§Ù„Ù…Ø³Ø§Ø­Ø©', units: 2 },
                    { name: 'Ù…Ø´Ø±ÙˆØ¹ ØªØ®Ø±Ø¬ Ù†Ù‡Ø§Ø¦ÙŠ', units: 2 },
                    { name: 'ØªØ¯Ø±ÙŠØ¨ Ø¹Ù…Ù„ÙŠ', units: 2 }
                ]
            },
            'Ø§Ù„Ø­Ø§Ø³ÙˆØ¨': {
                1: [
                    { name: 'Ø¨Ø±Ù…Ø¬Ø© 1', units: 4 },
                    { name: 'Ù‡ÙŠØ§ÙƒÙ„ Ø¨ÙŠØ§Ù†Ø§Øª', units: 3 },
                    { name: 'Ø±ÙŠØ§Ø¶ÙŠØ§Øª Ù…ØªÙ‚Ø·Ø¹Ø©', units: 3 },
                    { name: 'Ù…Ù†Ø·Ù‚ Ø§Ù„Ø±ÙŠØ§Ø¶ÙŠØ§Øª', units: 2 },
                    { name: 'Ù…Ù‡Ø§Ø±Ø§Øª Ø§Ù„Ø­Ø§Ø³ÙˆØ¨', units: 2 },
                    { name: 'Ø§Ù„Ù„ØºØ© Ø§Ù„Ø¥Ù†Ø¬Ù„ÙŠØ²ÙŠØ©', units: 2 }
                ],
                2: [
                    { name: 'Ø¨Ø±Ù…Ø¬Ø© 2', units: 4 },
                    { name: 'Ù‚ÙˆØ§Ø¹Ø¯ Ø¨ÙŠØ§Ù†Ø§Øª', units: 3 },
                    { name: 'Ø´Ø¨ÙƒØ§Øª Ø­Ø§Ø³ÙˆØ¨', units: 3 },
                    { name: 'Ø£Ù†Ø¸Ù…Ø© ØªØ´ØºÙŠÙ„', units: 2 },
                    { name: 'Ø°ÙƒØ§Ø¡ Ø§ØµØ·Ù†Ø§Ø¹ÙŠ', units: 2 },
                    { name: 'Ù…Ø´Ø±ÙˆØ¹ ØªØ®Ø±Ø¬', units: 2 }
                ],
                3: [
                    { name: 'Ø¨Ø±Ù…Ø¬Ø© ÙƒØ§Ø¦Ù†ÙŠØ©', units: 4 },
                    { name: 'Ø®ÙˆØ§Ø±Ø²Ù…ÙŠØ§Øª', units: 3 },
                    { name: 'Ø´Ø¨ÙƒØ§Øª Ù…ØªÙ‚Ø¯Ù…Ø©', units: 3 },
                    { name: 'Ø£Ù…Ù† Ù…Ø¹Ù„ÙˆÙ…Ø§Øª', units: 2 },
                    { name: 'ÙˆØ§Ø¬Ù‡Ø§Øª Ù…Ø³ØªØ®Ø¯Ù…', units: 2 },
                    { name: 'Ù…Ø´Ø±ÙˆØ¹ ØªØ·Ø¨ÙŠÙ‚ÙŠ', units: 2 }
                ],
                4: [
                    { name: 'ØªØ·ÙˆÙŠØ± ÙˆÙŠØ¨', units: 4 },
                    { name: 'Ù‚ÙˆØ§Ø¹Ø¯ Ø¨ÙŠØ§Ù†Ø§Øª Ù…ØªÙ‚Ø¯Ù…Ø©', units: 3 },
                    { name: 'Ø°ÙƒØ§Ø¡ Ø§ØµØ·Ù†Ø§Ø¹ÙŠ Ù…ØªÙ‚Ø¯Ù…', units: 3 },
                    { name: 'ØªØ·Ø¨ÙŠÙ‚Ø§Øª Ù…ÙˆØ¨Ø§ÙŠÙ„', units: 2 },
                    { name: 'Ù‡Ù†Ø¯Ø³Ø© Ø¨Ø±Ù…Ø¬ÙŠØ§Øª', units: 2 },
                    { name: 'Ù…Ø´Ø±ÙˆØ¹ Ø¬Ù…Ø§Ø¹ÙŠ', units: 2 }
                ],
                5: [
                    { name: 'ØªØ¹Ù„Ù… Ø§Ù„Ø¢Ù„Ø©', units: 4 },
                    { name: 'ØªØ­Ù„ÙŠÙ„ Ø¨ÙŠØ§Ù†Ø§Øª', units: 3 },
                    { name: 'Ø­ÙˆØ³Ø¨Ø© Ø³Ø­Ø§Ø¨ÙŠØ©', units: 3 },
                    { name: 'Ø¥Ù†ØªØ±Ù†Øª Ø§Ù„Ø£Ø´ÙŠØ§Ø¡', units: 2 },
                    { name: 'Ø¨Ù„ÙˆÙƒ ØªØ´ÙŠÙ†', units: 2 },
                    { name: 'Ø¨Ø­Ø« Ø¹Ù„Ù…ÙŠ', units: 2 }
                ],
                6: [
                    { name: 'Ø°ÙƒØ§Ø¡ Ø§ØµØ·Ù†Ø§Ø¹ÙŠ ØªØ·Ø¨ÙŠÙ‚ÙŠ', units: 4 },
                    { name: 'Ø£Ù…Ù† Ø³ÙŠØ¨Ø±Ø§Ù†ÙŠ Ù…ØªÙ‚Ø¯Ù…', units: 3 },
                    { name: 'ØªØ·Ø¨ÙŠÙ‚Ø§Øª Ù…ØªÙ‚Ø¯Ù…Ø©', units: 3 },
                    { name: 'Ø¥Ø¯Ø§Ø±Ø© Ø£Ù†Ø¸Ù…Ø©', units: 2 },
                    { name: 'Ù…Ø´Ø±ÙˆØ¹ ØªØ®Ø±Ø¬ Ù†Ù‡Ø§Ø¦ÙŠ', units: 2 },
                    { name: 'ØªØ¯Ø±ÙŠØ¨ Ù…ÙŠØ¯Ø§Ù†ÙŠ', units: 2 }
                ]
            },
            'Ø§Ù„Ø·Ø§Ù‚Ø©': {
                1: [
                    { name: 'ÙÙŠØ²ÙŠØ§Ø¡ Ø§Ù„Ø·Ø§Ù‚Ø©', units: 3 },
                    { name: 'thermodynamics', units: 3 },
                    { name: 'Ø±ÙŠØ§Ø¶ÙŠØ§Øª Ù‡Ù†Ø¯Ø³ÙŠØ©', units: 3 },
                    { name: 'ÙƒÙŠÙ…ÙŠØ§Ø¡ ØµÙ†Ø§Ø¹ÙŠØ©', units: 2 },
                    { name: 'Ù…ÙŠÙƒØ§Ù†ÙŠÙƒØ§ ØªØ·Ø¨ÙŠÙ‚ÙŠØ©', units: 2 },
                    { name: 'Ø±Ø³Ù… Ù‡Ù†Ø¯Ø³ÙŠ', units: 2 }
                ],
                2: [
                    { name: 'Ø·Ø§Ù‚Ø© Ù…ØªØ¬Ø¯Ø¯Ø©', units: 3 },
                    { name: 'Ù…Ø­Ø·Ø§Øª Ø·Ø§Ù‚Ø©', units: 3 },
                    { name: 'ÙƒÙØ§Ø¡Ø© Ø§Ù„Ø·Ø§Ù‚Ø©', units: 3 },
                    { name: 'ØªØ®Ø²ÙŠÙ† Ø§Ù„Ø·Ø§Ù‚Ø©', units: 2 },
                    { name: 'Ø£Ù†Ø¸Ù…Ø© ØªØ­ÙƒÙ…', units: 2 },
                    { name: 'Ù…Ø´Ø±ÙˆØ¹ ØªØ®Ø±Ø¬', units: 2 }
                ],
                3: [
                    { name: 'Ø·Ø§Ù‚Ø© Ø´Ù…Ø³ÙŠØ©', units: 3 },
                    { name: 'Ø·Ø§Ù‚Ø© Ø±ÙŠØ§Ø­', units: 3 },
                    { name: 'Ø·Ø§Ù‚Ø© Ù…Ø§Ø¦ÙŠØ©', units: 3 },
                    { name: 'Ø®Ù„Ø§ÙŠØ§ ÙˆÙ‚ÙˆØ¯', units: 2 },
                    { name: 'ØªØ­ÙˆÙŠÙ„ Ø·Ø§Ù‚Ø©', units: 2 },
                    { name: 'Ù…Ø´Ø±ÙˆØ¹ ØªØ·Ø¨ÙŠÙ‚ÙŠ', units: 2 }
                ],
                4: [
                    { name: 'Ø·Ø§Ù‚Ø© Ù†ÙˆÙˆÙŠØ©', units: 3 },
                    { name: 'Ø·Ø§Ù‚Ø© Ø­ÙŠÙˆÙŠØ©', units: 3 },
                    { name: 'ØªÙƒÙŠÙŠÙ Ù‡ÙˆØ§Ø¡', units: 3 },
                    { name: 'Ø¹Ø²Ù„ Ø­Ø±Ø§Ø±ÙŠ', units: 2 },
                    { name: 'ØªØµÙ…ÙŠÙ… Ø£Ù†Ø¸Ù…Ø©', units: 2 },
                    { name: 'Ù…Ø´Ø±ÙˆØ¹ Ù…ÙŠØ¯Ø§Ù†ÙŠ', units: 2 }
                ],
                5: [
                    { name: 'Ø·Ø§Ù‚Ø© Ù…ØªÙ‚Ø¯Ù…Ø©', units: 3 },
                    { name: 'ØªØ­Ù„ÙŠÙ„ Ø£Ù†Ø¸Ù…Ø©', units: 3 },
                    { name: 'Ù…Ø­Ø·Ø§Øª Ø°ÙƒÙŠØ©', units: 3 },
                    { name: 'Ø´Ø¨ÙƒØ§Øª Ø·Ø§Ù‚Ø©', units: 2 },
                    { name: 'Ø§Ù‚ØªØµØ§Ø¯ Ø§Ù„Ø·Ø§Ù‚Ø©', units: 2 },
                    { name: 'Ø¨Ø­Ø« Ø¹Ù„Ù…ÙŠ', units: 2 }
                ],
                6: [
                    { name: 'ØªÙƒÙ†ÙˆÙ„ÙˆØ¬ÙŠØ§ Ø·Ø§Ù‚Ø©', units: 3 },
                    { name: 'Ø¥Ø¯Ø§Ø±Ø© Ø·Ø§Ù‚Ø©', units: 3 },
                    { name: 'Ø³ÙŠØ§Ø³Ø§Øª Ø·Ø§Ù‚Ø©', units: 3 },
                    { name: 'Ø§Ø¨ØªÙƒØ§Ø± Ø·Ø§Ù‚Ø©', units: 2 },
                    { name: 'Ù…Ø´Ø±ÙˆØ¹ ØªØ®Ø±Ø¬ Ù†Ù‡Ø§Ø¦ÙŠ', units: 2 },
                    { name: 'ØªØ¯Ø±ÙŠØ¨ Ø¹Ù…Ù„ÙŠ', units: 2 }
                ]
            },
            'Ø§Ù„ÙƒÙ‡Ø±Ø¨Ø§Ø¡': {
                1: [
                    { name: 'Ø¯ÙˆØ§Ø¦Ø± ÙƒÙ‡Ø±Ø¨Ø§Ø¦ÙŠØ©', units: 3 },
                    { name: 'Ø¥Ù„ÙƒØªØ±ÙˆÙ†ÙŠØ§Øª', units: 3 },
                    { name: 'Ø±ÙŠØ§Ø¶ÙŠØ§Øª Ù‡Ù†Ø¯Ø³ÙŠØ©', units: 3 },
                    { name: 'ÙÙŠØ²ÙŠØ§Ø¡ ØªØ·Ø¨ÙŠÙ‚ÙŠØ©', units: 2 },
                    { name: 'Ø¨Ø±Ù…Ø¬Ø© Ù‡Ù†Ø¯Ø³ÙŠØ©', units: 2 },
                    { name: 'Ø±Ø³Ù… Ù‡Ù†Ø¯Ø³ÙŠ', units: 2 }
                ],
                2: [
                    { name: 'Ø¢Ù„Ø§Øª ÙƒÙ‡Ø±Ø¨Ø§Ø¦ÙŠØ©', units: 3 },
                    { name: 'Ø£Ù†Ø¸Ù…Ø© Ù‚ÙˆÙ‰', units: 3 },
                    { name: 'ØªØ­ÙƒÙ… Ø¢Ù„ÙŠ', units: 3 },
                    { name: 'Ø¥Ù„ÙƒØªØ±ÙˆÙ†ÙŠØ§Øª Ù…ØªÙ‚Ø¯Ù…Ø©', units: 2 },
                    { name: 'Ø´Ø¨ÙƒØ§Øª ÙƒÙ‡Ø±Ø¨Ø§Ø¡', units: 2 },
                    { name: 'Ù…Ø´Ø±ÙˆØ¹ ØªØ®Ø±Ø¬', units: 2 }
                ],
                3: [
                    { name: 'Ù…Ø­Ø±ÙƒØ§Øª ÙƒÙ‡Ø±Ø¨Ø§Ø¦ÙŠØ©', units: 3 },
                    { name: 'Ø£Ù†Ø¸Ù…Ø© Ù‚ÙˆÙ‰ Ù…ØªÙ‚Ø¯Ù…Ø©', units: 3 },
                    { name: 'ØªØ­ÙƒÙ… Ø±Ù‚Ù…ÙŠ', units: 3 },
                    { name: 'Ø¥Ù„ÙƒØªØ±ÙˆÙ†ÙŠØ§Øª Ø·Ø§Ù‚Ø©', units: 2 },
                    { name: 'Ø­Ù…Ø§ÙŠØ© Ø£Ù†Ø¸Ù…Ø©', units: 2 },
                    { name: 'Ù…Ø´Ø±ÙˆØ¹ ØªØ·Ø¨ÙŠÙ‚ÙŠ', units: 2 }
                ],
                4: [
                    { name: 'ØªÙˆÙ„ÙŠØ¯ Ø·Ø§Ù‚Ø©', units: 3 },
                    { name: 'Ù†Ù‚Ù„ ÙˆØªÙˆØ²ÙŠØ¹', units: 3 },
                    { name: 'Ø£Ù†Ø¸Ù…Ø© Ø°ÙƒÙŠØ©', units: 3 },
                    { name: 'ÙƒÙ‡Ø±ÙˆÙ…ÙŠÙƒØ§Ù†ÙŠÙƒØ§', units: 2 },
                    { name: 'ØªØµÙ…ÙŠÙ… Ø£Ù†Ø¸Ù…Ø©', units: 2 },
                    { name: 'Ù…Ø´Ø±ÙˆØ¹ Ù…ÙŠØ¯Ø§Ù†ÙŠ', units: 2 }
                ],
                5: [
                    { name: 'Ø·Ø§Ù‚Ø© Ù…ØªØ¬Ø¯Ø¯Ø© ÙƒÙ‡Ø±Ø¨Ø§Ø¦ÙŠØ©', units: 3 },
                    { name: 'Ø£Ù†Ø¸Ù…Ø© ØªØ­ÙƒÙ… Ù…ØªÙ‚Ø¯Ù…Ø©', units: 3 },
                    { name: 'Ø£ØªÙ…ØªØ© ØµÙ†Ø§Ø¹ÙŠØ©', units: 3 },
                    { name: 'Ø±ÙˆØ¨ÙˆØªØ§Øª', units: 2 },
                    { name: 'Ø¨Ø­Ø« Ø¹Ù„Ù…ÙŠ', units: 2 },
                    { name: 'ØªØ·Ø¨ÙŠÙ‚Ø§Øª Ù…ØªÙ‚Ø¯Ù…Ø©', units: 2 }
                ],
                6: [
                    { name: 'Ù‡Ù†Ø¯Ø³Ø© ÙƒÙ‡Ø±Ø¨Ø§Ø¦ÙŠØ© Ù…ØªÙ‚Ø¯Ù…Ø©', units: 3 },
                    { name: 'Ø£Ù†Ø¸Ù…Ø© Ø·Ø§Ù‚Ø© Ù…ØªÙƒØ§Ù…Ù„Ø©', units: 3 },
                    { name: 'Ø§Ø¨ØªÙƒØ§Ø± ÙƒÙ‡Ø±Ø¨Ø§Ø¦ÙŠ', units: 3 },
                    { name: 'Ø¥Ø¯Ø§Ø±Ø© Ù…Ø´Ø§Ø±ÙŠØ¹', units: 2 },
                    { name: 'Ù…Ø´Ø±ÙˆØ¹ ØªØ®Ø±Ø¬ Ù†Ù‡Ø§Ø¦ÙŠ', units: 2 },
                    { name: 'ØªØ¯Ø±ÙŠØ¨ Ø¹Ù…Ù„ÙŠ', units: 2 }
                ]
            },
            'Ø§Ù„Ù…ÙŠÙƒØ§Ù†ÙŠÙƒØ§': {
                1: [
                    { name: 'Ù…ÙŠÙƒØ§Ù†ÙŠÙƒØ§ ØªØ·Ø¨ÙŠÙ‚ÙŠØ©', units: 3 },
                    { name: 'Ø¯ÙŠÙ†Ø§Ù…ÙŠÙƒØ§ Ø­Ø±Ø§Ø±ÙŠØ©', units: 3 },
                    { name: 'ØªØµÙ…ÙŠÙ… Ù…ÙŠÙƒØ§Ù†ÙŠÙƒÙŠ', units: 3 },
                    { name: 'Ù…ÙˆØ§Ø¯ Ù‡Ù†Ø¯Ø³ÙŠØ©', units: 2 },
                    { name: 'ØªØµÙ†ÙŠØ¹', units: 2 },
                    { name: 'Ø±Ø³Ù… Ù‡Ù†Ø¯Ø³ÙŠ', units: 2 }
                ],
                2: [
                    { name: 'Ù…ÙƒØ§Ø¦Ù† Ø­Ø±Ø§Ø±ÙŠØ©', units: 3 },
                    { name: 'ØªÙƒÙŠÙŠÙ ÙˆØªØ¨Ø±ÙŠØ¯', units: 3 },
                    { name: 'Ø§Ù‡ØªØ²Ø§Ø²Ø§Øª Ù…ÙŠÙƒØ§Ù†ÙŠÙƒÙŠØ©', units: 3 },
                    { name: 'Ù…ÙŠÙƒØ§Ù†ÙŠÙƒØ§ Ø§Ù„Ù…ÙˆØ§Ø¦Ø¹', units: 2 },
                    { name: 'ØªØµÙ…ÙŠÙ… Ù…ØªÙ‚Ø¯Ù…', units: 2 },
                    { name: 'Ù…Ø´Ø±ÙˆØ¹ ØªØ®Ø±Ø¬', units: 2 }
                ],
                3: [
                    { name: 'Ù…Ø­Ø±ÙƒØ§Øª Ø§Ø­ØªØ±Ø§Ù‚', units: 3 },
                    { name: 'ØªÙˆØ±Ø¨ÙŠÙ†Ø§Øª', units: 3 },
                    { name: 'Ø§Ù†ØªÙ‚Ø§Ù„ Ø­Ø±Ø§Ø±Ø©', units: 3 },
                    { name: 'Ù…ÙŠÙƒØ§Ù†ÙŠÙƒØ§ Ù…ØªÙ‚Ø¯Ù…Ø©', units: 2 },
                    { name: 'ØªØ­Ù„ÙŠÙ„ Ø¥Ø¬Ù‡Ø§Ø¯', units: 2 },
                    { name: 'Ù…Ø´Ø±ÙˆØ¹ ØªØ·Ø¨ÙŠÙ‚ÙŠ', units: 2 }
                ],
                4: [
                    { name: 'ØªÙƒÙ†ÙˆÙ„ÙˆØ¬ÙŠØ§ ØªØµÙ†ÙŠØ¹', units: 3 },
                    { name: 'Ø£ØªÙ…ØªØ© ØµÙ†Ø§Ø¹ÙŠØ©', units: 3 },
                    { name: 'Ø±ÙˆØ¨ÙˆØªØ§Øª Ù…ÙŠÙƒØ§Ù†ÙŠÙƒÙŠØ©', units: 3 },
                    { name: 'ØªØµÙ…ÙŠÙ… Ù…Ù†ØªØ¬', units: 2 },
                    { name: 'Ù…Ø­Ø§ÙƒØ§Ø©', units: 2 },
                    { name: 'Ù…Ø´Ø±ÙˆØ¹ Ù…ÙŠØ¯Ø§Ù†ÙŠ', units: 2 }
                ],
                5: [
                    { name: 'Ù…ÙŠÙƒØ§Ù†ÙŠÙƒØ§ Ù…ØªÙ‚Ø¯Ù…Ø©', units: 3 },
                    { name: 'Ù‡Ù†Ø¯Ø³Ø© Ø³ÙŠØ§Ø±Ø§Øª', units: 3 },
                    { name: 'Ø·ÙŠØ±Ø§Ù† Ù…ÙŠÙƒØ§Ù†ÙŠÙƒÙŠ', units: 3 },
                    { name: 'Ù…ÙˆØ§Ø¯ Ù…ØªÙ‚Ø¯Ù…Ø©', units: 2 },
                    { name: 'Ø¨Ø­Ø« Ø¹Ù„Ù…ÙŠ', units: 2 },
                    { name: 'ØªØ·Ø¨ÙŠÙ‚Ø§Øª Ù…ØªÙ‚Ø¯Ù…Ø©', units: 2 }
                ],
                6: [
                    { name: 'Ù‡Ù†Ø¯Ø³Ø© Ù…ÙŠÙƒØ§Ù†ÙŠÙƒÙŠØ© Ù…ØªÙ‚Ø¯Ù…Ø©', units: 3 },
                    { name: 'Ø§Ø¨ØªÙƒØ§Ø± Ù…ÙŠÙƒØ§Ù†ÙŠÙƒÙŠ', units: 3 },
                    { name: 'ØªØµÙ…ÙŠÙ… Ù…ØªÙƒØ§Ù…Ù„', units: 3 },
                    { name: 'Ø¥Ø¯Ø§Ø±Ø© Ø£Ù†Ø¸Ù…Ø©', units: 2 },
                    { name: 'Ù…Ø´Ø±ÙˆØ¹ ØªØ®Ø±Ø¬ Ù†Ù‡Ø§Ø¦ÙŠ', units: 2 },
                    { name: 'ØªØ¯Ø±ÙŠØ¨ Ø¹Ù…Ù„ÙŠ', units: 2 }
                ]
            }
        };

        // Load settings on page load
        function loadSettings() {
            const savedSettings = localStorage.getItem('adminSettings');
            if (savedSettings) {
                settings = JSON.parse(savedSettings);
            }
            document.getElementById('failRuleEnabled').checked = settings.failRuleEnabled;

            // Load academic semester
            loadAcademicSemester();

            updateStatistics();
        }

        // Save settings
        function saveSettings() {
            settings.failRuleEnabled = document.getElementById('failRuleEnabled').checked;
            localStorage.setItem('adminSettings', JSON.stringify(settings));
            showStatus('ØªÙ… Ø­ÙØ¸ Ø§Ù„Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª Ø¨Ù†Ø¬Ø§Ø­', 'success');

            // Recalculate all students' totals to apply new rule
            recalculateAllStudents();
        }

        // Save academic semester
        function saveAcademicSemester() {
            const semesterInput = document.getElementById('currentAcademicSemester');
            const semesterText = semesterInput.value.trim();

            if (semesterText) {
                localStorage.setItem('currentAcademicSemester', semesterText);
                showStatus(`ØªÙ… Ø­ÙØ¸ Ø§Ù„ÙØµÙ„ Ø§Ù„Ø¯Ø±Ø§Ø³ÙŠ: ${semesterText}`, 'success');
            } else {
                localStorage.removeItem('currentAcademicSemester');
                showStatus('ØªÙ… Ù…Ø³Ø­ Ø§Ù„ÙØµÙ„ Ø§Ù„Ø¯Ø±Ø§Ø³ÙŠ', 'info');
            }
        }

        // Load academic semester
        function loadAcademicSemester() {
            const savedSemester = localStorage.getItem('currentAcademicSemester');
            if (savedSemester) {
                document.getElementById('currentAcademicSemester').value = savedSemester;
            }
        }

        // Get current academic semester
        function getCurrentAcademicSemester() {
            const savedSemester = localStorage.getItem('currentAcademicSemester');
            return savedSemester || 'Ø§Ù„ÙØµÙ„ Ø§Ù„Ø¯Ø±Ø§Ø³ÙŠ Ø§Ù„Ø­Ø§Ù„ÙŠ';
        }

        // Recalculate all students' totals when settings change
        function recalculateAllStudents() {
            students.forEach((student, index) => {
                if (student.subjects) {
                    student.subjects.forEach((subject, subjectIndex) => {
                        // Recalculate total using the new rule
                        const newTotal = calculateTotalGrade(subject.classWork, subject.finalExam);

                        // Update evaluation based on new total
                        const newEvaluation = getEvaluation(newTotal);

                        // Update the subject
                        subject.total = newTotal;
                        subject.evaluation = newEvaluation;

                        console.log(`Updated ${student.name} - ${subject.name}: classwork=${subject.classWork}, final=${subject.finalExam}, total=${newTotal}, eval=${newEvaluation}, rule=${settings.failRuleEnabled}`);
                    });
                }
            });

            // Save updated students to localStorage
            localStorage.setItem('students', JSON.stringify(students));

            // Update UI if student is being displayed
            const currentStudentId = document.getElementById('studentId').value;
            if (currentStudentId) {
                updateSubjectTotals();
            }

            // Update statistics
            updateStatistics();

            showStatus('ØªÙ… ØªØ·Ø¨ÙŠÙ‚ Ø§Ù„Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª Ø¹Ù„Ù‰ Ø¬Ù…ÙŠØ¹ Ø§Ù„Ø·Ù„Ø§Ø¨', 'success');
        }

        // Calculate total grade with fail rule
        function calculateTotalGrade(classwork, finalExam) {
            const cw = parseFloat(classwork) || 0;
            const fe = parseFloat(finalExam) || 0;

            console.log(`calculateTotalGrade: classwork=${cw}, finalExam=${fe}, failRuleEnabled=${settings.failRuleEnabled}`);

            if (settings.failRuleEnabled && fe < 30) {
                console.log(`Final exam < 30 (${fe}), returning only classwork: ${cw}`);
                return cw; // Only count classwork if final exam < 30
            }

            const total = cw + fe;
            console.log(`Normal calculation, returning: ${total}`);
            return total;
        }

        // Get grade class based on total grade
        function getGradeClass(total) {
            if (total >= 85) return 'grade-excellent';
            if (total >= 75) return 'grade-very-good';
            if (total >= 65) return 'grade-good';
            if (total >= 50) return 'grade-acceptable';
            return 'grade-weak';
        }

        // Get evaluation based on total grade
        function getEvaluation(total) {
            if (total >= 85) return 'Ù…Ù…ØªØ§Ø²';
            if (total >= 75) return 'Ø¬ÙŠØ¯ Ø¬Ø¯Ø§';
            if (total >= 65) return 'Ø¬ÙŠØ¯';
            if (total >= 50) return 'Ù…Ù‚Ø¨ÙˆÙ„';
            return 'Ø±Ø§Ø³Ø¨';
        }

        // Select semester
        function selectSemester(semester) {
            currentSemester = semester;

            // Update button states
            document.querySelectorAll('.semester-selector button').forEach(btn => {
                btn.classList.remove('active');
            });
            event.target.classList.add('active');

            // Reload subjects for new semester
            loadDepartmentSubjectsForGrid();
        }

        function loadDepartmentSubjectsForGrid() {
            const department = document.getElementById('department').value;
            const grid = document.getElementById('subjectsGrid');

            if (!department) {
                grid.innerHTML = '<p style="color: #666; text-align: center; padding: 20px;">Ø§Ø®ØªØ± Ø§Ù„Ù‚Ø³Ù… Ø£ÙˆÙ„Ø§Ù‹</p>';
                return;
            }

            const subjects = departmentSubjects[department]?.[currentSemester] || [];

            if (subjects.length === 0) {
                grid.innerHTML = '<p style="color: #666; text-align: center; padding: 20px;">Ù„Ø§ ØªÙˆØ¬Ø¯ Ù…ÙˆØ§Ø¯ Ù„Ù‡Ø°Ø§ Ø§Ù„Ù‚Ø³Ù… ÙÙŠ Ù‡Ø°Ø§ Ø§Ù„ÙØµÙ„</p>';
                return;
            }

            grid.innerHTML = subjects.map((subject, index) => `
                <div class="subject-item" onclick="toggleSubject(${index}, '${subject.name}', ${subject.units})" id="subject-${index}">
                    <strong>${subject.name}</strong><br>
                    <small>${subject.units} ÙˆØ­Ø¯Ø§Øª</small>
                </div>
            `).join('');
        }

        // Toggle subject selection
        function toggleSubject(index, name, units) {
            const element = document.getElementById(`subject-${index}`);
            const isSelected = element.classList.contains('selected');

            if (isSelected) {
                element.classList.remove('selected');
                removeSubjectFromList(name);
            } else {
                element.classList.add('selected');
                addSubjectToList(name, units);
            }
        }

        // Add subject to list
        function addSubjectToList(name, units) {
            const container = document.getElementById('subjectsContainer');
            const subjectDiv = document.createElement('div');
            subjectDiv.className = 'subject-input';
            subjectDiv.innerHTML = `
                <input type="text" placeholder="Ø§Ø³Ù… Ø§Ù„Ù…Ø§Ø¯Ø©" class="subject-name" value="${name}" readonly style="background: #f8f9fa;">
                <input type="number" placeholder="Ø§Ù„ÙˆØ­Ø¯Ø§Øª" class="subject-units" min="1" max="6" value="${units}" readonly style="background: #f8f9fa;">
                <input type="number" placeholder="Ø£Ø¹Ù…Ø§Ù„ Ø§Ù„ÙØµÙ„" class="subject-classwork" min="0" max="40" onchange="autoCalculate(this)">
                <input type="number" placeholder="Ø§Ù„Ø§Ø®ØªØ¨Ø§Ø± Ø§Ù„Ù†Ù‡Ø§Ø¦ÙŠ" class="subject-final" min="0" max="60" onchange="autoCalculate(this)">
                <input type="number" placeholder="Ø§Ù„Ù…Ø¬Ù…ÙˆØ¹" class="subject-total" min="0" max="100" readonly style="background: rgba(15, 23, 42, 0.4); color: var(--text-color);">
                <select class="subject-evaluation" readonly style="background: rgba(15, 23, 42, 0.4); color: var(--text-color);">
                    <option value="">ÙŠØªÙ… Ø­Ø³Ø§Ø¨ ØªÙ„Ù‚Ø§Ø¦ÙŠØ§Ù‹</option>
                    <option value="Ù…Ù…ØªØ§Ø²">Ù…Ù…ØªØ§Ø²</option>
                    <option value="Ø¬ÙŠØ¯ Ø¬Ø¯Ø§">Ø¬ÙŠØ¯ Ø¬Ø¯Ø§</option>
                    <option value="Ø¬ÙŠØ¯">Ø¬ÙŠØ¯</option>
                    <option value="Ù…Ù‚Ø¨ÙˆÙ„">Ù…Ù‚Ø¨ÙˆÙ„</option>
                    <option value="Ø¶Ø¹ÙŠÙ">Ø¶Ø¹ÙŠÙ</option>
                    <option value="Ø±Ø§Ø³Ø¨">Ø±Ø§Ø³Ø¨</option>
                </select>
                <button type="button" class="remove-subject" onclick="removeSubject(this)">Ø­Ø°Ù</button>
            `;
            container.appendChild(subjectDiv);

            // Add to selected subjects list
            selectedSubjects.push({ name, units });
        }

        // Remove subject from list
        function removeSubjectFromList(name) {
            const container = document.getElementById('subjectsContainer');
            const subjects = container.querySelectorAll('.subject-input');

            subjects.forEach(subject => {
                const nameInput = subject.querySelector('.subject-name');
                if (nameInput && nameInput.value === name) {
                    subject.remove();
                }
            });

            // Remove from selected subjects list
            selectedSubjects = selectedSubjects.filter(s => s.name !== name);
        }

        // Add failed subject (Ù…Ø·Ø§Ù„Ø¨) from previous semester
        function addFailedSubject() {
            const department = document.getElementById('department').value;
            const currentSemesterNum = currentSemester;

            if (!department) {
                alert('Ø§Ø®ØªØ± Ø§Ù„Ù‚Ø³Ù… Ø£ÙˆÙ„Ø§Ù‹');
                return;
            }

            if (currentSemesterNum <= 1) {
                alert('Ù„Ø§ ÙŠÙ…ÙƒÙ† Ø¥Ø¶Ø§ÙØ© Ù…ÙˆØ§Ø¯ Ù…Ø·Ø§Ù„Ø¨Ø© Ù„Ù„ÙØµÙ„ Ø§Ù„Ø£ÙˆÙ„');
                return;
            }

            const previousSemester = currentSemesterNum - 1;
            const previousSubjects = departmentSubjects[department]?.[previousSemester] || [];

            if (previousSubjects.length === 0) {
                alert('Ù„Ø§ ØªÙˆØ¬Ø¯ Ù…ÙˆØ§Ø¯ ÙÙŠ Ø§Ù„ÙØµÙ„ Ø§Ù„Ø³Ø§Ø¨Ù‚');
                return;
            }

            // Create modal for selecting failed subjects
            const modal = document.createElement('div');
            modal.className = 'modal-overlay';
            modal.innerHTML = `
                <div class="modal-content">
                    <h3>Ø§Ø®ØªØ± Ø§Ù„Ù…ÙˆØ§Ø¯ Ø§Ù„Ù…Ø·Ø§Ù„Ø¨Ø© Ù…Ù† Ø§Ù„ÙØµÙ„ ${previousSemester}</h3>
                    <p style="color: #666; margin-bottom: 20px;">Ø§Ø®ØªØ± Ø§Ù„Ù…ÙˆØ§Ø¯ Ø§Ù„ØªÙŠ Ø±Ø³Ø¨ ÙÙŠÙ‡Ø§ Ø§Ù„Ø·Ø§Ù„Ø¨ Ù…Ù† Ø§Ù„ÙØµÙ„ Ø§Ù„Ø³Ø§Ø¨Ù‚</p>
                    <div class="failed-subjects-list">
                        ${previousSubjects.map((subject, index) => `
                            <div class="failed-subject-item">
                                <input type="checkbox" id="failed-${index}" value="${index}">
                                <label for="failed-${index}">
                                    <strong>${subject.name}</strong> - ${subject.units} ÙˆØ­Ø¯Ø§Øª
                                </label>
                            </div>
                        `).join('')}
                    </div>
                    <div class="modal-buttons">
                        <button class="primary" onclick="confirmFailedSubjects(this)">Ø¥Ø¶Ø§ÙØ© Ø§Ù„Ù…ÙˆØ§Ø¯ Ø§Ù„Ù…Ø®ØªØ§Ø±Ø©</button>
                        <button class="danger" onclick="closeFailedSubjectsModal(this)">Ø¥Ù„ØºØ§Ø¡</button>
                    </div>
                </div>
            `;

            document.body.appendChild(modal);
        }

        // Confirm failed subjects selection
        function confirmFailedSubjects(button) {
            const modal = button.closest('.modal-overlay');
            const checkboxes = modal.querySelectorAll('input[type="checkbox"]:checked');

            if (checkboxes.length === 0) {
                alert('Ø§Ø®ØªØ± Ù…Ø§Ø¯Ø© ÙˆØ§Ø­Ø¯Ø© Ø¹Ù„Ù‰ Ø§Ù„Ø£Ù‚Ù„');
                return;
            }

            const container = document.getElementById('subjectsContainer');

            checkboxes.forEach(checkbox => {
                const index = parseInt(checkbox.value);
                const department = document.getElementById('department').value;
                const previousSemester = currentSemester - 1;
                const subject = departmentSubjects[department]?.[previousSemester]?.[index];

                if (subject) {
                    const subjectDiv = document.createElement('div');
                    subjectDiv.className = 'subject-input';
                    subjectDiv.innerHTML = `
                        <input type="text" placeholder="Ø§Ø³Ù… Ø§Ù„Ù…Ø§Ø¯Ø©" class="subject-name" value="${subject.name} (Ù…Ø·Ø§Ù„Ø¨)" readonly style="background: rgba(220, 53, 69, 0.1); color: var(--text-color);">
                        <input type="number" placeholder="Ø§Ù„ÙˆØ­Ø¯Ø§Øª" class="subject-units" min="1" max="6" value="${subject.units}" readonly style="background: rgba(220, 53, 69, 0.1); color: var(--text-color);">
                        <input type="number" placeholder="Ø£Ø¹Ù…Ø§Ù„ Ø§Ù„ÙØµÙ„" class="subject-classwork" min="0" max="50" onchange="autoCalculate(this)">
                        <input type="number" placeholder="Ø§Ù„Ø§Ø®ØªØ¨Ø§Ø± Ø§Ù„Ù†Ù‡Ø§Ø¦ÙŠ" class="subject-final" min="0" max="50" onchange="autoCalculate(this)">
                        <input type="number" placeholder="Ø§Ù„Ù…Ø¬Ù…ÙˆØ¹" class="subject-total" min="0" max="100" readonly style="background: rgba(15, 23, 42, 0.4); color: var(--text-color);">
                        <select class="subject-evaluation" readonly style="background: rgba(15, 23, 42, 0.4); color: var(--text-color);">
                            <option value="">ÙŠØªÙ… Ø­Ø³Ø§Ø¨ ØªÙ„Ù‚Ø§Ø¦ÙŠØ§Ù‹</option>
                            <option value="Ù…Ù…ØªØ§Ø²">Ù…Ù…ØªØ§Ø²</option>
                            <option value="Ø¬ÙŠØ¯ Ø¬Ø¯Ø§">Ø¬ÙŠØ¯ Ø¬Ø¯Ø§</option>
                            <option value="Ø¬ÙŠØ¯">Ø¬ÙŠØ¯</option>
                            <option value="Ù…Ù‚Ø¨ÙˆÙ„">Ù…Ù‚Ø¨ÙˆÙ„</option>
                            <option value="Ø¶Ø¹ÙŠÙ">Ø¶Ø¹ÙŠÙ</option>
                            <option value="Ø±Ø§Ø³Ø¨">Ø±Ø§Ø³Ø¨</option>
                        </select>
                        <button type="button" class="remove-subject" onclick="removeSubject(this)">Ø­Ø°Ù</button>
                    `;
                    container.appendChild(subjectDiv);
                }
            });

            closeFailedSubjectsModal(button);
            showStatus(`ØªÙ… Ø¥Ø¶Ø§ÙØ© ${checkboxes.length} Ù…ÙˆØ§Ø¯ Ù…Ø·Ø§Ù„Ø¨Ø© Ø¨Ù†Ø¬Ø§Ø­`, 'success');
        }

        // Close failed subjects modal
        function closeFailedSubjectsModal(button) {
            const modal = button.closest('.modal-overlay');
            if (modal) {
                modal.remove();
            }
        }

        // Toggle subject editor
        function toggleSubjectEditor() {
            const editor = document.getElementById('subjectEditor');
            const isActive = editor.classList.contains('active');

            if (isActive) {
                editor.classList.remove('active');
            } else {
                editor.classList.add('active');
                loadSubjectsForEditing();
            }
        }

        // Load subjects for editing
        function loadSubjectsForEditing() {
            const department = document.getElementById('department').value;
            const editorContainer = document.getElementById('subjectListEditor');

            if (!department) {
                editorContainer.innerHTML = '<p style="color: #666; text-align: center; padding: 20px;">Ø§Ø®ØªØ± Ø§Ù„Ù‚Ø³Ù… Ø£ÙˆÙ„Ø§Ù‹</p>';
                return;
            }

            const subjects = departmentSubjects[department]?.[currentSemester] || [];

            if (subjects.length === 0) {
                editorContainer.innerHTML = '<p style="color: #666; text-align: center; padding: 20px;">Ù„Ø§ ØªÙˆØ¬Ø¯ Ù…ÙˆØ§Ø¯ Ù„Ù‡Ø°Ø§ Ø§Ù„Ù‚Ø³Ù… ÙÙŠ Ù‡Ø°Ø§ Ø§Ù„ÙØµÙ„</p>';
                return;
            }

            editorContainer.innerHTML = subjects.map((subject, index) => `
                <div class="subject-editor-item">
                    <input type="text" value="${subject.name}" id="edit-subject-name-${index}" placeholder="Ø§Ø³Ù… Ø§Ù„Ù…Ø§Ø¯Ø©">
                    <input type="number" value="${subject.units}" id="edit-subject-units-${index}" min="1" max="6" placeholder="Ø§Ù„ÙˆØ­Ø¯Ø§Øª">
                    <button onclick="removeSubjectFromEditor(${index})">Ø­Ø°Ù</button>
                </div>
            `).join('');
        }

        // Add new subject to editor
        function addNewSubject() {
            const editorContainer = document.getElementById('subjectListEditor');
            const subjectCount = editorContainer.children.length;

            const newSubjectHtml = `
                <div class="subject-editor-item">
                    <input type="text" id="edit-subject-name-${subjectCount}" placeholder="Ø§Ø³Ù… Ø§Ù„Ù…Ø§Ø¯Ø©">
                    <input type="number" id="edit-subject-units-${subjectCount}" min="1" max="6" placeholder="Ø§Ù„ÙˆØ­Ø¯Ø§Øª">
                    <button onclick="removeSubjectFromEditor(${subjectCount})">Ø­Ø°Ù</button>
                </div>
            `;

            editorContainer.insertAdjacentHTML('beforeend', newSubjectHtml);
        }

        // Remove subject from editor
        function removeSubjectFromEditor(index) {
            const editorContainer = document.getElementById('subjectListEditor');
            const subjectItem = document.getElementById(`edit-subject-name-${index}`)?.parentElement;
            if (subjectItem) {
                subjectItem.remove();
            }
        }

        // Save subjects changes
        function saveSubjectsChanges() {
            const department = document.getElementById('department').value;
            const editorContainer = document.getElementById('subjectListEditor');

            if (!department) {
                alert('Ø§Ø®ØªØ± Ø§Ù„Ù‚Ø³Ù… Ø£ÙˆÙ„Ø§Ù‹');
                return;
            }

            const subjectItems = editorContainer.querySelectorAll('.subject-editor-item');
            const newSubjects = [];

            subjectItems.forEach(item => {
                const nameInput = item.querySelector('input[type="text"]');
                const unitsInput = item.querySelector('input[type="number"]');

                if (nameInput && unitsInput && nameInput.value.trim() && unitsInput.value) {
                    newSubjects.push({
                        name: nameInput.value.trim(),
                        units: parseInt(unitsInput.value)
                    });
                }
            });

            if (newSubjects.length === 0) {
                alert('ÙŠØ¬Ø¨ Ø¥Ø¶Ø§ÙØ© Ù…Ø§Ø¯Ø© ÙˆØ§Ø­Ø¯Ø© Ø¹Ù„Ù‰ Ø§Ù„Ø£Ù‚Ù„');
                return;
            }

            // Update the subjects database
            if (!departmentSubjects[department]) {
                departmentSubjects[department] = {};
            }
            departmentSubjects[department][currentSemester] = newSubjects;

            // Save to localStorage
            localStorage.setItem('departmentSubjects', JSON.stringify(departmentSubjects));

            // Reload subjects display
            loadDepartmentSubjectsForGrid();

            // Close editor
            toggleSubjectEditor();

            showStatus('ØªÙ… Ø­ÙØ¸ Ø§Ù„ØªØºÙŠÙŠØ±Ø§Øª Ø¨Ù†Ø¬Ø§Ø­', 'success');
        }

        // Load custom subjects from localStorage
        function loadCustomSubjects() {
            const customSubjects = localStorage.getItem('departmentSubjects');
            if (customSubjects) {
                const parsed = JSON.parse(customSubjects);
                Object.assign(departmentSubjects, parsed);
            }
        }

        // Update statistics
        function updateStatistics() {
            const totalStudents = students.length;
            let totalSubjects = 0;
            let totalGrades = 0;
            let gradeCount = 0;

            students.forEach(student => {
                totalSubjects += student.subjects.length;
                student.subjects.forEach(subject => {
                    const total = calculateTotalGrade(subject.classWork, subject.finalExam);
                    if (total > 0) {
                        totalGrades += total;
                        gradeCount++;
                    }
                });
            });

            document.getElementById('totalStudents').textContent = totalStudents;
            document.getElementById('totalSubjects').textContent = totalSubjects;
            document.getElementById('averageGrade').textContent = gradeCount > 0 ? (totalGrades / gradeCount).toFixed(2) : '0';
        }

        // Clear all data
        function clearAllData() {
            if (confirm('Ù‡Ù„ Ø£Ù†Øª Ù…ØªØ£ÙƒØ¯ Ù…Ù† Ù…Ø³Ø­ Ø¬Ù…ÙŠØ¹ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§ØªØŸ Ù‡Ø°Ø§ Ø§Ù„Ø¥Ø¬Ø±Ø§Ø¡ Ù„Ø§ ÙŠÙ…ÙƒÙ† Ø§Ù„ØªØ±Ø§Ø¬Ø¹ Ø¹Ù†Ù‡.\n\nØ³ÙŠØªÙ… Ø­Ø°Ù:\nâ€¢ Ø¬Ù…ÙŠØ¹ Ø§Ù„Ø·Ù„Ø§Ø¨ ÙˆØ¯Ø±Ø¬Ø§ØªÙ‡Ù…\nâ€¢ Ø§Ù„Ø£Ù‚Ø³Ø§Ù… Ø§Ù„Ù…Ø¶Ø§ÙØ©\nâ€¢ Ø§Ù„Ù…ÙˆØ§Ø¯ Ø§Ù„Ù…Ø®ØµØµØ©\nâ€¢ Ø§Ù„Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª\nâ€¢ Ø§Ù„Ø·Ù„Ø§Ø¨ Ø§Ù„Ù…Ø­Ø¬ÙˆØ¨ÙŠÙ†')) {
                if (confirm('ØªØ­Ø°ÙŠØ± Ø£Ø®ÙŠØ±: Ù‡Ù„ Ø­Ù‚Ø§Ù‹ ØªØ±ÙŠØ¯ Ù…Ø³Ø­ ÙƒÙ„ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§ØªØŸ')) {
                    // Clear all localStorage data
                    localStorage.removeItem('students');
                    localStorage.removeItem('adminSettings');
                    localStorage.removeItem('departments');
                    localStorage.removeItem('blockedStudents');
                    localStorage.removeItem('customSubjects');

                    // Reset global variables
                    students = [];
                    settings = { failRuleEnabled: true };

                    // Update UI
                    updateStatistics();
                    displayDepartments();
                    loadAllStudents();

                    showStatus('ØªÙ… Ù…Ø³Ø­ Ø¬Ù…ÙŠØ¹ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ø¨Ù†Ø¬Ø§Ø­', 'success');
                }
            }
        }

        // Download database as JSON for web hosting
        function downloadJSONDatabase() {
            const students = JSON.parse(localStorage.getItem('students')) || [];
            if (students.length === 0) {
                showStatus('Ù„Ø§ ØªÙˆØ¬Ø¯ Ø¨ÙŠØ§Ù†Ø§Øª Ù„ØªØµØ¯ÙŠØ±Ù‡Ø§!', 'error');
                return;
            }

            const dataStr = JSON.stringify(students, null, 2);
            const blob = new Blob([dataStr], { type: "application/json" });
            const url = URL.createObjectURL(blob);

            const a = document.createElement('a');
            a.href = url;
            a.download = "students.json";
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
            URL.revokeObjectURL(url);

            showStatus('âœ… ØªÙ… ØªØ¬Ù‡ÙŠØ² Ù…Ù„Ù students.json. ÙŠØ±Ø¬Ù‰ Ø±ÙØ¹Ù‡ Ø¨Ø¬Ø§Ù†Ø¨ index.html ÙÙŠ Ù…ÙˆÙ‚Ø¹Ùƒ.', 'success');
        }

        // Export all settings and data
        function exportAllSettings() {
            const exportData = {
                // System info
                exportInfo: {
                    version: '2.0',
                    exportDate: new Date().toLocaleString('ar-SA'),
                    systemName: 'Ù†Ø¸Ø§Ù… Ø¥Ø¯Ø§Ø±Ø© Ø§Ù„Ø·Ù„Ø§Ø¨ - Ø§Ù„Ù…Ø¹Ù‡Ø¯ Ø§Ù„Ø¹Ø§Ù„ÙŠ Ù„Ù„Ø¹Ù„ÙˆÙ… ÙˆØ§Ù„ØªÙ‚Ù†ÙŠØ©'
                },

                // Core data
                students: JSON.parse(localStorage.getItem('students')) || [],
                settings: JSON.parse(localStorage.getItem('adminSettings')) || { failRuleEnabled: true },

                // Department management
                departments: JSON.parse(localStorage.getItem('departments')) || [],

                // Blocked students
                blockedStudents: JSON.parse(localStorage.getItem('blockedStudents')) || [],

                // Custom subjects (if exists)
                customSubjects: JSON.parse(localStorage.getItem('customSubjects')) || {},

                // Statistics
                statistics: {
                    totalStudents: (JSON.parse(localStorage.getItem('students')) || []).length,
                    totalDepartments: (JSON.parse(localStorage.getItem('departments')) || []).length,
                    totalBlocked: (JSON.parse(localStorage.getItem('blockedStudents')) || []).length,
                    exportTimestamp: new Date().toISOString()
                }
            };

            // Create and download file
            const blob = new Blob([JSON.stringify(exportData, null, 2)], { type: 'application/json' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `system_complete_backup_${new Date().toISOString().split('T')[0]}.json`;
            a.click();
            URL.revokeObjectURL(url);

            showStatus('ØªÙ… ØªØµØ¯ÙŠØ± Ø¬Ù…ÙŠØ¹ Ø§Ù„Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª ÙˆØ§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ø¨Ù†Ø¬Ø§Ø­', 'success');
        }

        // Import all settings and data
        function importAllSettings(event) {
            const file = event.target.files[0];

            if (!file) {
                return;
            }

            if (!file.name.endsWith('.json')) {
                showStatus('ÙŠØ±Ø¬Ù‰ Ø§Ø®ØªÙŠØ§Ø± Ù…Ù„Ù JSON ØµØ§Ù„Ø­', 'error');
                return;
            }

            const reader = new FileReader();
            reader.onload = function (e) {
                try {
                    const importData = JSON.parse(e.target.result);

                    // Validate import data structure
                    if (!importData.exportInfo || !importData.students) {
                        showStatus('Ù…Ù„Ù Ø§Ù„Ù†Ø³Ø®Ø© Ø§Ù„Ø§Ø­ØªÙŠØ§Ø·ÙŠØ© ØºÙŠØ± ØµØ§Ù„Ø­', 'error');
                        return;
                    }

                    // Confirm import
                    const confirmMessage = `Ù‡Ù„ ØªØ±ÙŠØ¯ Ø§Ø³ØªÙŠØ±Ø§Ø¯ Ø§Ù„Ù†Ø³Ø®Ø© Ø§Ù„Ø§Ø­ØªÙŠØ§Ø·ÙŠØ© Ø§Ù„ØªØ§Ù„ÙŠØ©ØŸ\n\n` +
                        `ØªØ§Ø±ÙŠØ® Ø§Ù„ØªØµØ¯ÙŠØ±: ${importData.exportInfo.exportDate}\n` +
                        `Ø§Ù„Ø¥ØµØ¯Ø§Ø±: ${importData.exportInfo.version || 'ØºÙŠØ± Ù…Ø­Ø¯Ø¯'}\n` +
                        `Ø¹Ø¯Ø¯ Ø§Ù„Ø·Ù„Ø§Ø¨: ${importData.students.length}\n` +
                        `Ø¹Ø¯Ø¯ Ø§Ù„Ø£Ù‚Ø³Ø§Ù…: ${(importData.departments || []).length}\n` +
                        `Ø§Ù„Ø·Ù„Ø§Ø¨ Ø§Ù„Ù…Ø­Ø¬ÙˆØ¨ÙŠÙ†: ${(importData.blockedStudents || []).length}\n\n` +
                        `Ø³ÙŠØªÙ… Ø§Ø³ØªØ¨Ø¯Ø§Ù„ Ø¬Ù…ÙŠØ¹ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ø­Ø§Ù„ÙŠØ©!`;

                    if (!confirm(confirmMessage)) {
                        return;
                    }

                    // Import all data
                    localStorage.setItem('students', JSON.stringify(importData.students || []));
                    localStorage.setItem('adminSettings', JSON.stringify(importData.settings || { failRuleEnabled: true }));
                    localStorage.setItem('departments', JSON.stringify(importData.departments || []));
                    localStorage.setItem('blockedStudents', JSON.stringify(importData.blockedStudents || []));
                    localStorage.setItem('customSubjects', JSON.stringify(importData.customSubjects || {}));

                    // Update global variables
                    students = importData.students || [];
                    settings = importData.settings || { failRuleEnabled: true };

                    // Refresh all UI components
                    window.refreshStudents();
                    updateStatistics();
                    displayDepartments();
                    loadAllStudents();

                    // Load blocked students if the function exists
                    if (typeof loadBlockedStudents === 'function') {
                        loadBlockedStudents();
                    }

                    // Update settings UI
                    const failRuleCheckbox = document.getElementById('failRuleEnabled');
                    if (failRuleCheckbox) {
                        failRuleCheckbox.checked = settings.failRuleEnabled;
                    }

                    showStatus(`ØªÙ… Ø§Ø³ØªÙŠØ±Ø§Ø¯ Ø§Ù„Ù†Ø³Ø®Ø© Ø§Ù„Ø§Ø­ØªÙŠØ§Ø·ÙŠØ© Ø¨Ù†Ø¬Ø§Ø­\n` +
                        `â€¢ ${importData.students.length} Ø·Ø§Ù„Ø¨\n` +
                        `â€¢ ${(importData.departments || []).length} Ù‚Ø³Ù…\n` +
                        `â€¢ ${(importData.blockedStudents || []).length} Ø·Ø§Ù„Ø¨ Ù…Ø­Ø¬ÙˆØ¨`, 'success');

                } catch (error) {
                    showStatus('Ø®Ø·Ø£ ÙÙŠ Ø§Ø³ØªÙŠØ±Ø§Ø¯ Ø§Ù„Ù…Ù„Ù: ' + error.message, 'error');
                }

                // Sync to Firebase and reload
                syncToFirebase();
                setTimeout(() => location.reload(), 2000); // Give time for sync
            };

            reader.readAsText(file);

            // Reset file input
            event.target.value = '';
        }

        // Login functionality
        function login() {
            const username = document.getElementById('username').value.trim();
            const password = document.getElementById('password').value.trim();

            if (!username || !password) {
                showStatus('Ø§Ù„Ø±Ø¬Ø§Ø¡ Ø¥Ø¯Ø®Ø§Ù„ Ø§Ø³Ù… Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù… ÙˆÙƒÙ„Ù…Ø© Ø§Ù„Ù…Ø±ÙˆØ±', 'error');
                return;
            }

            // Check if student login
            if (username.toLowerCase() === 'student') {
                loginAsStudent(password);
                return;
            }

            // Check if admin login
            users = JSON.parse(localStorage.getItem('users')) || [];
            const user = users.find(u =>
                (u.email === username || u.name === username) &&
                u.password === btoa(password) &&
                u.status === 'active'
            );

            if (user) {
                // Update last login
                user.lastLogin = new Date().toLocaleString('ar-SA');
                localStorage.setItem('users', JSON.stringify(users));

                // Set current user
                currentUser = user;
                sessionStorage.setItem('currentUser', JSON.stringify(user));

                // Hide login screen and show main app
                document.getElementById('loginScreen').style.display = 'none';
                document.getElementById('mainApp').style.display = 'block';

                // Apply user permissions
                applyUserPermissions(user);

                showStatus(`Ù…Ø±Ø­Ø¨Ø§Ù‹ ${user.name}! ØªÙ… ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¯Ø®ÙˆÙ„ Ø¨Ù†Ø¬Ø§Ø­`, 'success');
            } else {
                showStatus('Ø§Ø³Ù… Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù… Ø£Ùˆ ÙƒÙ„Ù…Ø© Ø§Ù„Ù…Ø±ÙˆØ± ØºÙŠØ± ØµØ­ÙŠØ­Ø©', 'error');
            }
        }

        // Student login function
        function loginAsStudent(studentId) {
            const students = JSON.parse(localStorage.getItem('students')) || [];

            // Robust normalization
            const normalize = (id) => {
                if (!id) return "";
                return id.toString().trim().toUpperCase().replace(/[^A-Z0-9]/g, '');
            };

            const nId = normalize(studentId);

            // Find student by ID
            const student = students.find(s => normalize(s.id) === nId);

            if (!student) {
                showStatus('Ø§Ù„Ø±Ù‚Ù… Ø§Ù„Ø¯Ø±Ø§Ø³ÙŠ ØºÙŠØ± Ù…ÙˆØ¬ÙˆØ¯. ØªØ£ÙƒØ¯ Ù…Ù† Ø§Ù„Ø±Ù‚Ù… ÙˆØ­Ø§ÙˆÙ„ Ù…Ø±Ø© Ø£Ø®Ø±Ù‰', 'error');
                return;
            }

            // CHECK IF BLOCKED
            const blockedInfo = isStudentBlocked(student.id);
            if (blockedInfo) {
                const reason = blockedInfo.reason || 'ØºÙŠØ± Ù…Ø­Ø¯Ø¯';
                // Show a more permanent blocked message instead of just a status
                const loginBox = document.querySelector('.login-box');
                if (loginBox) {
                    loginBox.innerHTML = `
                        <h2 style="color: var(--danger-color);">ğŸš« Ø§Ù„Ù†ØªÙŠØ¬Ø© Ù…Ø­Ø¬ÙˆØ¨Ø©</h2>
                        <div style="background: rgba(239, 68, 68, 0.1); border: 1px solid var(--danger-color); border-radius: 16px; padding: 20px; margin: 20px 0; text-align: right;">
                            <p style="margin-bottom: 10px;"><strong>Ø§Ù„Ø§Ø³Ù…:</strong> ${student.name}</p>
                            <p style="margin-bottom: 10px;"><strong>Ø§Ù„Ø³Ø¨Ø¨:</strong> ${reason}</p>
                            <p style="color: var(--text-muted); font-size: 0.9rem; margin-top: 15px; text-align: center;">ÙŠØ±Ø¬Ù‰ Ù…Ø±Ø§Ø¬Ø¹Ø© Ø¥Ø¯Ø§Ø±Ø© Ø§Ù„ØªØ³Ø¬ÙŠÙ„ Ø¨Ø§Ù„Ù…Ø¹Ù‡Ø¯ Ù„Ù„Ù…Ø²ÙŠØ¯ Ù…Ù† Ø§Ù„ØªÙØ§ØµÙŠÙ„</p>
                        </div>
                        <button onclick="location.reload()" class="primary" style="width: 100%; padding: 16px;">Ø¹ÙˆØ¯Ø© Ù„ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¯Ø®ÙˆÙ„</button>
                    `;
                } else {
                    showStatus(`ğŸš« Ø§Ù„Ù†ØªÙŠØ¬Ø© Ù…Ø­Ø¬ÙˆØ¨Ø© Ù„Ø³Ø¨Ø¨: ${reason}`, 'error');
                }
                return;
            }

            // Set current user as student
            currentUser = {
                type: 'student',
                studentData: student
            };
            sessionStorage.setItem('currentUser', JSON.stringify(currentUser));

            // Hide login screen and show student view
            document.getElementById('loginScreen').style.display = 'none';
            document.getElementById('mainApp').style.display = 'none';

            // Show student view
            showStudentView(student);

            showStatus(`Ù…Ø±Ø­Ø¨Ø§Ù‹ ${student.name}! ØªÙ… ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¯Ø®ÙˆÙ„ Ø¨Ù†Ø¬Ø§Ø­`, 'success');
        }

        function logout() {
            currentUser = null;
            sessionStorage.removeItem('currentUser');
            // Reload to clear any injected blocked UI and reset states securely
            location.reload();
        }

        // Robust Block Check
        function isStudentBlocked(studentId) {
            try {
                if (!studentId) return null;

                const normalize = (id) => {
                    if (!id) return "";
                    return id.toString().trim().toUpperCase().replace(/[^A-Z0-9]/g, '');
                };

                const nid = normalize(studentId);
                if (!nid) return null;

                // Load blocked list from local storage
                let blockedList = JSON.parse(localStorage.getItem('blockedStudents') || '[]');

                // If it's a single object instead of array (from older syncs?), wrap it
                if (blockedList && !Array.isArray(blockedList)) {
                    blockedList = [blockedList];
                }

                if (blockedList.length === 0) return null;

                // Robust fuzzy matching
                return blockedList.find(blocked => {
                    const bid = normalize(blocked.studentId);
                    if (!bid) return false;

                    // Exact match
                    if (bid === nid) return true;

                    // Partial match for entries that might be missing prefixes
                    if (bid.length >= 5 && nid.includes(bid)) return true;
                    if (nid.length >= 5 && bid.includes(nid)) return true;

                    return false;
                });
            } catch (error) {
                console.error('âŒ isStudentBlocked error:', error);
                return null;
            }
        }

        // Show individual student result in student portal
        function showStudentView(student) {
            // Guard: Check if blocked
            const blockedInfo = isStudentBlocked(student.id);
            if (blockedInfo) {
                document.getElementById('studentView').innerHTML = `
                    <div class="student-portal">
                        <div class="portal-container" style="text-align: center; padding: 50px 20px;">
                            <h1 style="color: var(--danger-color); font-size: 3rem; margin-bottom: 20px;">ğŸš«</h1>
                            <h2 style="color: var(--text-color); margin-bottom: 15px;">Ø¹Ø°Ø±Ø§Ù‹ØŒ Ù†ØªÙŠØ¬ØªÙƒ Ù…Ø­Ø¬ÙˆØ¨Ø© Ø­Ø§Ù„ÙŠØ§Ù‹</h2>
                            <p style="color: var(--text-muted); font-size: 1.2rem; margin-bottom: 30px;">Ø§Ù„Ø³Ø¨Ø¨: ${blockedInfo.reason || 'ØºÙŠØ± Ù…Ø­Ø¯Ø¯'}</p>
                            <button onclick="logout()" class="logout-btn-portal">ØªØ³Ø¬ÙŠÙ„ Ø®Ø±ÙˆØ¬</button>
                        </div>
                    </div>
                `;
                document.getElementById('studentView').style.display = 'block';
                return;
            }

            const container = document.getElementById('studentResultContainer');
            document.getElementById('studentView').style.display = 'block';

            // Logic matching main system
            const studentGPA = calculateStudentGPA(student);
            const semesterStatus = calculateSemesterStatus(student);
            const passedCount = student.subjects ? student.subjects.filter(s => s.total >= 50).length : 0;
            const failedCount = student.subjects ? student.subjects.filter(s => s.total < 50).length : 0;

            let subjectsHtml = '';
            if (student.subjects && student.subjects.length > 0) {
                subjectsHtml = `
                    <div style="margin-top: 2.5rem;">
                        <h3 style="margin-bottom: 1.5rem; text-align: center; color: var(--portal-secondary);">ğŸ“Š Ø³Ø¬Ù„ Ø§Ù„Ø¯Ø±Ø¬Ø§Øª Ø§Ù„ØªÙØµÙŠÙ„ÙŠ</h3>
                        <div class="portal-table-container">
                            <table class="portal-table">
                                <thead>
                                    <tr>
                                        <th style="text-align: right;">Ø§Ù„Ù…Ø§Ø¯Ø©</th>
                                        <th>Ø§Ù„ÙˆØ­Ø¯Ø§Øª</th>
                                        <th>Ø£Ø¹Ù…Ø§Ù„ Ø§Ù„ÙØµÙ„</th>
                                        <th>Ø§Ù„Ù†Ù‡Ø§Ø¦ÙŠ</th>
                                        <th>Ø§Ù„Ù…Ø¬Ù…ÙˆØ¹</th>
                                        <th>Ø§Ù„ØªÙ‚Ø¯ÙŠØ±</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    ${student.subjects.map(s => `
                                        <tr>
                                            <td style="text-align: right; font-weight: 600;">${s.name}</td>
                                            <td>${s.units || '-'}</td>
                                            <td>${s.classWork || '0'}</td>
                                            <td>${s.finalExam || '0'}</td>
                                            <td style="font-weight: bold; color: ${s.total >= 50 ? 'var(--portal-accent)' : 'var(--portal-danger)'};">${s.total || '0'}</td>
                                            <td>
                                                <span class="portal-badge ${s.total >= 50 ? 'portal-badge-passed' : 'portal-badge-failed'}">
                                                    ${getGrade(s.total)}
                                                </span>
                                            </td>
                                        </tr>
                                    `).join('')}
                                </tbody>
                            </table>
                        </div>
                    </div>

                    <div style="margin-top: 2rem; display: flex; gap: 1rem; flex-wrap: wrap; justify-content: center;">
                        <span class="portal-badge portal-badge-passed">Ø§Ù„Ù…ÙˆØ§Ø¯ Ø§Ù„Ù†Ø§Ø¬Ø­Ø©: ${passedCount}</span>
                        <span class="portal-badge portal-badge-failed">Ø§Ù„Ù…ÙˆØ§Ø¯ Ø§Ù„Ø±Ø§Ø³Ø¨Ø©: ${failedCount}</span>
                    </div>
                `;
            } else {
                subjectsHtml = '<div class="portal-header"><h3>Ù„Ø§ ØªÙˆØ¬Ø¯ Ù…ÙˆØ§Ø¯ Ù…Ø³Ø¬Ù„Ø© Ù„Ù‡Ø°Ø§ Ø§Ù„Ø·Ø§Ù„Ø¨</h3></div>';
            }

            container.innerHTML = `
                <div class="portal-info-grid">
                    <div class="portal-info-card">
                        <strong>Ø§Ù„Ø§Ø³Ù… Ø§Ù„ÙƒØ§Ù…Ù„</strong>
                        <p>${student.name}</p>
                    </div>
                    <div class="portal-info-card">
                        <strong>Ø§Ù„Ø±Ù‚Ù… Ø§Ù„Ø¯Ø±Ø§Ø³ÙŠ</strong>
                        <p>${student.id}</p>
                    </div>
                    <div class="portal-info-card">
                        <strong>Ø§Ù„Ù‚Ø³Ù… Ø§Ù„Ø¹Ù„Ù…ÙŠ</strong>
                        <p>${student.department}</p>
                    </div>
                    <div class="portal-info-card">
                        <strong>Ø§Ù„ÙØµÙ„ Ø§Ù„Ø¯Ø±Ø§Ø³ÙŠ</strong>
                        <p>${student.semester}</p>
                    </div>
                    <div class="portal-info-card" style="border-right-color: var(--portal-secondary);">
                        <strong>Ø§Ù„Ù…Ø¹Ø¯Ù„ Ø§Ù„ÙØµÙ„ÙŠ</strong>
                        <p style="color: var(--portal-secondary); font-size: 1.8rem;">${studentGPA}</p>
                    </div>
                    <div class="portal-info-card">
                        <strong>Ø­Ø§Ù„Ø© Ø§Ù„Ø·Ø§Ù„Ø¨</strong>
                        <p>
                            <span class="portal-badge ${semesterStatus.passed ? 'portal-badge-passed' : 'portal-badge-failed'}">
                                ${semesterStatus.reason}
                            </span>
                        </p>
                    </div>
                </div>
                ${subjectsHtml}
            `;
        }

        function applyUserPermissions(user) {
            // Hide/show elements based on permissions
            const permissions = user.permissions;

            // Student management tabs
            const addStudentTab = document.querySelector('[onclick="showTab(\'add\')"]');
            const listStudentTab = document.querySelector('[onclick="showTab(\'list\')"]');
            const blockStudentTab = document.querySelector('[onclick="showTab(\'block-student\')"]');

            if (addStudentTab) addStudentTab.style.display = permissions.add_students ? 'block' : 'none';
            if (listStudentTab) listStudentTab.style.display = permissions.edit_students || permissions.view_statistics ? 'block' : 'none';
            if (blockStudentTab) blockStudentTab.style.display = permissions.block_students ? 'block' : 'none';

            // Excel tab
            const excelTab = document.querySelector('[onclick="showTab(\'excel\')"]');
            if (excelTab) excelTab.style.display = (permissions.export_excel || permissions.import_excel) ? 'block' : 'none';

            // Settings tab
            const settingsTab = document.querySelector('[onclick="showTab(\'settings\')"]');
            if (settingsTab) settingsTab.style.display = permissions.manage_departments || permissions.manage_users ? 'block' : 'none';

            // Statistics tab
            const statisticsTab = document.querySelector('[onclick="showTab(\'statistics\')"]');
            if (statisticsTab) statisticsTab.style.display = permissions.view_statistics ? 'block' : 'none';

            // Department management in settings
            const deptManagement = document.querySelector('h4:contains("Ø¥Ø¯Ø§Ø±Ø© Ø§Ù„Ø£Ù‚Ø³Ø§Ù…")');
            if (deptManagement && !permissions.manage_departments) {
                deptManagement.parentElement.style.display = 'none';
            }

            // User management in settings
            const userManagement = document.querySelector('h4:contains("Ø¥Ø¯Ø§Ø±Ø© Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…ÙŠÙ†")');
            if (userManagement && !permissions.manage_users) {
                userManagement.parentElement.style.display = 'none';
            }

            // Backup/restore buttons
            const backupBtn = document.querySelector('button[onclick*="exportAllSettings"]');
            const restoreBtn = document.querySelector('button[onclick*="importAllSettings"]');
            if (backupBtn && !permissions.backup_restore) backupBtn.style.display = 'none';
            if (restoreBtn && !permissions.backup_restore) restoreBtn.style.display = 'none';

            // Excel buttons
            const exportExcelBtn = document.querySelector('button[onclick="exportToExcel()"]');
            const importExcelBtn = document.querySelector('button[onclick="importFromExcel()"]');
            if (exportExcelBtn && !permissions.export_excel) exportExcelBtn.style.display = 'none';
            if (importExcelBtn && !permissions.import_excel) importExcelBtn.style.display = 'none';
        }

        function checkPermission(permission) {
            if (!currentUser) return false;
            return currentUser.permissions[permission] || false;
        }
        // Update student ID prefix based on department
        function updateStudentIdPrefix() {
            const department = document.getElementById('department').value;
            const studentIdInput = document.getElementById('studentId');
            const currentId = studentIdInput.value;

            let prefix = '';
            switch (department) {
                case 'Ø§Ù„ØªÙ…ÙˆÙŠÙ„ ÙˆØ§Ù„Ù…ØµØ§Ø±Ù':
                    prefix = 'AC';
                    break;
                case 'Ø§Ù„Ù…Ø³Ø§Ø­Ø©':
                    prefix = 'SE';
                    break;
                case 'Ø§Ù„Ø­Ø§Ø³ÙˆØ¨':
                    prefix = 'CO';
                    break;
                case 'Ø§Ù„Ø·Ø§Ù‚Ø©':
                    prefix = 'RE';
                    break;
                case 'Ø§Ù„ÙƒÙ‡Ø±Ø¨Ø§Ø¡':
                    prefix = 'EL';
                    break;
                case 'Ø§Ù„Ù…ÙŠÙƒØ§Ù†ÙŠÙƒØ§':
                    prefix = 'ME';
                    break;
                default:
                    return;
            }

            // If current ID is empty or starts with different prefix, update it
            if (!currentId || !['SE', 'AC', 'CO', 'RE', 'EL', 'ME'].includes(currentId.substring(0, 2))) {
                // Generate a sample ID with current year and sequence
                const currentYear = new Date().getFullYear() % 100; // Get last 2 digits
                const sequence = Math.floor(Math.random() * 999) + 1; // Random sequence 1-999
                const newId = prefix + currentYear + '2' + sequence.toString().padStart(3, '0');
                studentIdInput.value = newId;
            }

            // Auto-load subjects based on student ID
            autoLoadSubjectsFromId();
        }

        function loadDepartmentSubjects() {
            const department = document.getElementById('department').value;
            const subjectsContainer = document.getElementById('subjectsContainer');

            if (!department) {
                clearSubjectsContainer();
                return;
            }

            // Get departments from localStorage
            const departments = JSON.parse(localStorage.getItem('departments')) || [];

            // Check if department exists in custom departments
            const customDept = departments.find(d => d.name === department);

            if (customDept) {
                // Load custom department subjects
                loadCustomDepartmentSubjects(customDept.code);
            } else {
                // Load default department subjects
                loadDefaultDepartmentSubjects(department);
            }
        }

        function loadCustomDepartmentSubjects(deptCode) {
            const subjectsContainer = document.getElementById('subjectsContainer');

            // Get custom subjects for this department
            const customSubjects = JSON.parse(localStorage.getItem('customSubjects')) || {};
            const deptSubjects = customSubjects[deptCode] || [];

            if (deptSubjects.length === 0) {
                // Load default subjects if no custom subjects found
                loadDefaultSubjects();
                return;
            }

            // Create subject inputs for custom department
            let subjectsHTML = '<h4>ğŸ“š Ù…ÙˆØ§Ø¯ Ø§Ù„Ù‚Ø³Ù…:</h4><div class="subjects-grid">';

            deptSubjects.forEach(subject => {
                subjectsHTML += `
                    <div class="subject-item">
                        <label>${subject.name}</label>
                        <input type="number" 
                               id="${subject.code}_total" 
                               placeholder="Ø§Ù„Ø¯Ø±Ø¬Ø©" 
                               min="0" 
                               max="100" 
                               onchange="calculateGPA()" 
                               data-units="${subject.units}">
                        <span class="units">(${subject.units} ÙˆØ­Ø¯Ø©)</span>
                    </div>
                `;
            });

            subjectsHTML += '</div>';
            subjectsContainer.innerHTML = subjectsHTML;
        }

        function loadDefaultDepartmentSubjects(department) {
            const subjectsContainer = document.getElementById('subjectsContainer');

            // Get subjects from departmentSubjects database
            const subjects = departmentSubjects[department];

            if (!subjects || !subjects[currentSemester]) {
                // Load default empty subjects if no subjects found
                clearSubjectsContainer();
                return;
            }

            const semesterSubjects = subjects[currentSemester];

            // Create subject inputs for default department
            let subjectsHTML = '<h4>ğŸ“š Ù…ÙˆØ§Ø¯ Ø§Ù„Ù‚Ø³Ù…:</h4><div class="subjects-grid">';

            semesterSubjects.forEach(subject => {
                subjectsHTML += `
                    <div class="subject-item">
                        <label>${subject.name}</label>
                        <input type="number" 
                               id="${subject.name.replace(/\s+/g, '_')}_total" 
                               placeholder="Ø§Ù„Ø¯Ø±Ø¬Ø©" 
                               min="0" 
                               max="100" 
                               onchange="calculateGPA()" 
                               data-units="${subject.units}">
                        <span class="units">(${subject.units} ÙˆØ­Ø¯Ø©)</span>
                    </div>
                `;
            });

            subjectsHTML += '</div>';
            subjectsContainer.innerHTML = subjectsHTML;
        }

        function loadDefaultSubjects() {
            const subjectsContainer = document.getElementById('subjectsContainer');

            // Load default empty subjects
            clearSubjectsContainer();
        }

        function updateDepartmentSelect() {
            const departmentSelect = document.getElementById('department');
            const departments = JSON.parse(localStorage.getItem('departments')) || [];

            // Get current value
            const currentValue = departmentSelect.value;

            // Clear existing options except the first one
            while (departmentSelect.children.length > 1) {
                departmentSelect.removeChild(departmentSelect.lastChild);
            }

            // Add default departments
            const defaultDepts = [
                { name: 'Ø§Ù„ØªÙ…ÙˆÙŠÙ„ ÙˆØ§Ù„Ù…ØµØ§Ø±Ù', code: 'AC' },
                { name: 'Ø§Ù„Ù…Ø³Ø§Ø­Ø©', code: 'SE' },
                { name: 'Ø§Ù„Ø­Ø§Ø³ÙˆØ¨', code: 'CO' },
                { name: 'Ø§Ù„Ø·Ø§Ù‚Ø©', code: 'RE' },
                { name: 'Ø§Ù„ÙƒÙ‡Ø±Ø¨Ø§Ø¡', code: 'EL' },
                { name: 'Ø§Ù„Ù…ÙŠÙƒØ§Ù†ÙŠÙƒØ§', code: 'ME' }
            ];

            // Add all departments (default + custom)
            const allDepts = [...defaultDepts, ...departments];

            allDepts.forEach(dept => {
                const option = document.createElement('option');
                option.value = dept.name;
                option.textContent = `${dept.name} (${dept.code})`;
                departmentSelect.appendChild(option);
            });

            // Restore previous selection if it still exists
            if (currentValue && allDepts.find(d => d.name === currentValue)) {
                departmentSelect.value = currentValue;
            }
        }

        // Auto-load subjects based on student ID
        function autoLoadSubjectsFromId() {
            const studentId = document.getElementById('studentId').value;
            const departmentSelect = document.getElementById('department');

            if (!studentId || studentId.length < 7) {
                clearSubjectsContainer();
                return;
            }

            // Parse student ID to get department and semester
            const parsedId = parseStudentId(studentId);
            if (!parsedId) {
                clearSubjectsContainer();
                return;
            }

            // Update department select if needed
            const departmentMap = {
                'SE': 'Ø§Ù„Ù…Ø³Ø§Ø­Ø©',
                'AC': 'Ø§Ù„ØªÙ…ÙˆÙŠÙ„ ÙˆØ§Ù„Ù…ØµØ§Ø±Ù',
                'CO': 'Ø§Ù„Ø­Ø§Ø³ÙˆØ¨',
                'RE': 'Ø§Ù„Ø·Ø§Ù‚Ø©',
                'EL': 'Ø§Ù„ÙƒÙ‡Ø±Ø¨Ø§Ø¡',
                'ME': 'Ø§Ù„Ù…ÙŠÙƒØ§Ù†ÙŠÙƒØ§'
            };

            const department = departmentMap[parsedId.prefix];
            if (department && departmentSelect.value !== department) {
                departmentSelect.value = department;
            }

            // Set semester based on student ID OR user selection
            const userSemesterSelect = document.getElementById('userSemesterSelect');
            if (userSemesterSelect && userSemesterSelect.value) {
                // Use user selection if available
                currentSemester = parseInt(userSemesterSelect.value);
            } else {
                // Use semester from student ID
                currentSemester = parsedId.semester === '2' ? 2 : 1;
            }

            // Update semester buttons
            document.querySelectorAll('.semester-selector button').forEach(btn => {
                btn.classList.remove('active');
            });
            const semesterBtn = document.querySelector(`.semester-selector button:nth-child(${currentSemester})`);
            if (semesterBtn) {
                semesterBtn.classList.add('active');
            }

            // Load subjects automatically
            loadDepartmentSubjectsForGrid();

            // Auto-add all subjects for the department and semester
            setTimeout(() => {
                autoAddAllSubjects();
            }, 100);
        }

        // Update semester from user selection
        function updateSemesterFromUserSelection() {
            const userSemesterSelect = document.getElementById('userSemesterSelect');
            const selectedSemester = userSemesterSelect.value;

            if (selectedSemester) {
                currentSemester = parseInt(selectedSemester);

                // Update semester buttons
                document.querySelectorAll('.semester-selector button').forEach(btn => {
                    btn.classList.remove('active');
                });
                const semesterBtn = document.querySelector(`.semester-selector button:nth-child(${currentSemester})`);
                if (semesterBtn) {
                    semesterBtn.classList.add('active');
                }

                // Reload subjects if department is selected
                const department = document.getElementById('department').value;
                if (department) {
                    loadDepartmentSubjectsForGrid();
                    setTimeout(() => {
                        autoAddAllSubjects();
                    }, 100);
                }
            }
        }

        // Auto-add all subjects for the current department and semester
        function autoAddAllSubjects() {
            const department = document.getElementById('department').value;
            const subjects = departmentSubjects[department]?.[currentSemester] || [];

            if (subjects.length === 0) {
                showStatus('Ù„Ø§ ØªÙˆØ¬Ø¯ Ù…ÙˆØ§Ø¯ Ù„Ù‡Ø°Ø§ Ø§Ù„Ù‚Ø³Ù… ÙÙŠ Ù‡Ø°Ø§ Ø§Ù„ÙØµÙ„', 'error');
                return;
            }

            // Clear existing subjects first
            clearSubjectsContainer();

            // Add all subjects automatically
            subjects.forEach((subject, index) => {
                setTimeout(() => {
                    const element = document.getElementById(`subject-${index}`);
                    if (element && !element.classList.contains('selected')) {
                        toggleSubject(index, subject.name, subject.units);
                    }
                }, index * 50); // Small delay for visual effect
            });

            // Show success message
            setTimeout(() => {
                showStatus(`ØªÙ… Ø¥Ø¶Ø§ÙØ© ${subjects.length} Ù…ÙˆØ§Ø¯ Ø¨Ù†Ø¬Ø§Ø­ Ù„Ù‚Ø³Ù… ${department} - Ø§Ù„ÙØµÙ„ ${currentSemester}`, 'success');
            }, subjects.length * 50 + 200);

            // Remove any empty subject rows that might be added automatically
            setTimeout(() => {
                removeEmptySubjectRows();
            }, subjects.length * 50 + 500);
        }

        // Remove empty subject rows
        function removeEmptySubjectRows() {
            const container = document.getElementById('subjectsContainer');
            const subjectInputs = container.querySelectorAll('.subject-input');

            subjectInputs.forEach(input => {
                const name = input.querySelector('.subject-name').value.trim();
                if (!name) {
                    input.remove();
                }
            });
        }

        // Clear subjects container
        function clearSubjectsContainer() {
            const container = document.getElementById('subjectsContainer');
            container.innerHTML = `
                <div class="subject-input">
                    <input type="text" placeholder="Ø§Ø³Ù… Ø§Ù„Ù…Ø§Ø¯Ø©" class="subject-name">
                    <input type="number" placeholder="Ø§Ù„ÙˆØ­Ø¯Ø§Øª" class="subject-units" min="1" max="6">
                    <input type="number" placeholder="Ø£Ø¹Ù…Ø§Ù„ Ø§Ù„ÙØµÙ„" class="subject-classwork" min="0" max="40" onchange="autoCalculate(this)">
                    <input type="number" placeholder="Ø§Ù„Ø§Ø®ØªØ¨Ø§Ø± Ø§Ù„Ù†Ù‡Ø§Ø¦ÙŠ" class="subject-final" min="0" max="60" onchange="autoCalculate(this)">
                    <input type="number" placeholder="Ø§Ù„Ù…Ø¬Ù…ÙˆØ¹" class="subject-total" min="0" max="100" readonly style="background: rgba(15, 23, 42, 0.4); color: var(--text-color);">
                    <select class="subject-evaluation" readonly style="background: rgba(15, 23, 42, 0.4); color: var(--text-color);">
                        <option value="">ÙŠØªÙ… Ø­Ø³Ø§Ø¨ ØªÙ„Ù‚Ø§Ø¦ÙŠØ§Ù‹</option>
                        <option value="Ù…Ù…ØªØ§Ø²">Ù…Ù…ØªØ§Ø²</option>
                        <option value="Ø¬ÙŠØ¯ Ø¬Ø¯Ø§">Ø¬ÙŠØ¯ Ø¬Ø¯Ø§</option>
                        <option value="Ø¬ÙŠØ¯">Ø¬ÙŠØ¯</option>
                        <option value="Ù…Ù‚Ø¨ÙˆÙ„">Ù…Ù‚Ø¨ÙˆÙ„</option>
                        <option value="Ø¶Ø¹ÙŠÙ">Ø¶Ø¹ÙŠÙ</option>
                        <option value="Ø±Ø§Ø³Ø¨">Ø±Ø§Ø³Ø¨</option>
                    </select>
                    <button type="button" class="remove-subject" onclick="removeSubject(this)">Ø­Ø°Ù</button>
                </div>
            `;

            // Reset selected subjects
            selectedSubjects = [];
        }

        // Parse student ID to get information
        function parseStudentId(studentId) {
            if (!studentId || studentId.length < 7) return null;

            const prefix = studentId.substring(0, 2);
            const year = studentId.substring(2, 4);
            const semester = studentId.substring(4, 5);
            const sequence = studentId.substring(5, 8);

            let department = '';
            switch (prefix) {
                case 'SE':
                    department = 'Ø§Ù„Ù…Ø³Ø§Ø­Ø©';
                    break;
                case 'AC':
                    department = 'Ø§Ù„ØªÙ…ÙˆÙŠÙ„ ÙˆØ§Ù„Ù…ØµØ§Ø±Ù';
                    break;
                case 'CO':
                    department = 'Ø§Ù„Ø­Ø§Ø³ÙˆØ¨';
                    break;
                case 'RE':
                    department = 'Ø§Ù„Ø·Ø§Ù‚Ø©';
                    break;
                case 'EL':
                    department = 'Ø§Ù„ÙƒÙ‡Ø±Ø¨Ø§Ø¡';
                    break;
                case 'ME':
                    department = 'Ø§Ù„Ù…ÙŠÙƒØ§Ù†ÙŠÙƒØ§';
                    break;
                default:
                    department = 'ØºÙŠØ± Ù…Ø¹Ø±ÙˆÙ';
            }

            const semesterText = semester === '2' ? 'Ø®Ø±ÙŠÙ' : 'Ø±Ø¨ÙŠØ¹';
            const fullYear = '20' + year;

            return {
                prefix: prefix,
                department: department,
                year: year,
                fullYear: fullYear,
                semester: semester,
                semesterText: semesterText,
                sequence: sequence
            };
        }

        // Tab switching
        function showTab(tabId) {
            console.log('ğŸ”„ Switching to tab:', tabId);
            
            // Hide all tabs
            document.querySelectorAll('.tab-content').forEach(tab => {
                tab.classList.remove('active');
            });

            // Show selected tab
            const selectedTab = document.getElementById(tabId);
            if (selectedTab) {
                selectedTab.classList.add('active');
                console.log('âœ… Tab found and activated:', tabId);
            } else {
                console.error('âŒ Tab not found:', tabId);
            }

            // Activate tab button
            const tabButtons = document.querySelectorAll('.tab');
            tabButtons.forEach(button => {
                if (button.getAttribute('onclick').includes(tabId)) {
                    button.classList.add('active');
                }
            });

            // Load data for specific tabs
            if (tabId === 'list') {
                console.log('ğŸ“‹ Loading students list...');
                // Check if data exists first
                const students = JSON.parse(localStorage.getItem('students')) || [];
                if (students.length === 0) {
                    console.log('ğŸ“ No students found, adding test data...');
                    addTestStudents();
                } else {
                    // Force immediate load
                    loadAllStudents();
                    // Also try after delay
                    setTimeout(() => {
                        loadAllStudents();
                    }, 500);
                }
            } else if (tabId === 'block-student') {
                loadBlockedStudents();
            }
        }

        // Add subject with auto-calculation
        function addSubject() {
            const container = document.getElementById('subjectsContainer');
            const subjectDiv = document.createElement('div');
            subjectDiv.className = 'subject-input';
            subjectDiv.innerHTML = `
                <input type="text" placeholder="Ø§Ø³Ù… Ø§Ù„Ù…Ø§Ø¯Ø©" class="subject-name">
                <input type="number" placeholder="Ø§Ù„ÙˆØ­Ø¯Ø§Øª" class="subject-units" min="1" max="6">
                <input type="number" placeholder="Ø£Ø¹Ù…Ø§Ù„ Ø§Ù„ÙØµÙ„" class="subject-classwork" min="0" max="40" onchange="autoCalculate(this)">
                <input type="number" placeholder="Ø§Ù„Ø§Ø®ØªØ¨Ø§Ø± Ø§Ù„Ù†Ù‡Ø§Ø¦ÙŠ" class="subject-final" min="0" max="60" onchange="autoCalculate(this)">
                <input type="number" placeholder="Ø§Ù„Ù…Ø¬Ù…ÙˆØ¹" class="subject-total" min="0" max="100" readonly style="background: rgba(15, 23, 42, 0.4); color: var(--text-color);">
                <select class="subject-evaluation" readonly style="background: rgba(15, 23, 42, 0.4); color: var(--text-color);">
                    <option value="">ÙŠØªÙ… Ø­Ø³Ø§Ø¨ ØªÙ„Ù‚Ø§Ø¦ÙŠØ§Ù‹</option>
                    <option value="Ù…Ù…ØªØ§Ø²">Ù…Ù…ØªØ§Ø²</option>
                    <option value="Ø¬ÙŠØ¯ Ø¬Ø¯Ø§">Ø¬ÙŠØ¯ Ø¬Ø¯Ø§</option>
                    <option value="Ø¬ÙŠØ¯">Ø¬ÙŠØ¯</option>
                    <option value="Ù…Ù‚Ø¨ÙˆÙ„">Ù…Ù‚Ø¨ÙˆÙ„</option>
                    <option value="Ø¶Ø¹ÙŠÙ">Ø¶Ø¹ÙŠÙ</option>
                    <option value="Ø±Ø§Ø³Ø¨">Ø±Ø§Ø³Ø¨</option>
                </select>
                <button type="button" class="remove-subject" onclick="removeSubject(this)">Ø­Ø°Ù</button>
            `;
            container.appendChild(subjectDiv);
        }

        // Auto calculate total and evaluation
        function autoCalculate(element) {
            const subjectDiv = element.closest('.subject-input');
            const classWorkInput = subjectDiv.querySelector('.subject-classwork');
            const finalExamInput = subjectDiv.querySelector('.subject-final');
            const totalInput = subjectDiv.querySelector('.subject-total');
            const evaluationSelect = subjectDiv.querySelector('.subject-evaluation');

            const classWork = parseFloat(classWorkInput.value) || 0;
            const finalExam = parseFloat(finalExamInput.value) || 0;

            // Calculate total
            const total = calculateTotalGrade(classWork, finalExam);
            totalInput.value = total;

            // Get evaluation
            const evaluation = getEvaluation(total);
            evaluationSelect.value = evaluation;

            // Apply color coding
            const gradeClass = getGradeClass(total);
            totalInput.className = `subject-total ${gradeClass}`;
            evaluationSelect.className = `subject-evaluation ${gradeClass}`;

            // Show warning if final exam < 30 and fail rule is enabled
            if (settings.failRuleEnabled && finalExam < 30 && finalExam > 0) {
                showStatus('ØªÙ†Ø¨ÙŠÙ‡: Ø¯Ø±Ø¬Ø© Ø§Ù„Ø§Ø®ØªØ¨Ø§Ø± Ø§Ù„Ù†Ù‡Ø§Ø¦ÙŠ Ø£Ù‚Ù„ Ù…Ù† 30ØŒ Ø³ÙŠØªÙ… Ø§Ø­ØªØ³Ø§Ø¨Ù‡Ø§ ØµÙØ± ÙÙŠ Ø§Ù„Ù…Ø¬Ù…ÙˆØ¹', 'warning');
            }
        }

        function removeSubject(button) {
            button.parentElement.remove();
        }

        // Update evaluation based on total grade
        function updateEvaluation(totalInput) {
            const evaluationSelect = totalInput.parentElement.querySelector('.subject-evaluation');
            const total = parseFloat(totalInput.value) || 0;
            const evaluation = getEvaluation(total);
            evaluationSelect.value = evaluation;

            // Apply color coding
            const gradeClass = getGradeClass(total);
            totalInput.className = `subject-total ${gradeClass}`;
            evaluationSelect.className = `subject-evaluation ${gradeClass}`;
        }

        // Update total based on evaluation
        function updateTotalFromEvaluation(evaluationSelect) {
            const totalInput = evaluationSelect.parentElement.querySelector('.subject-total');
            const evaluation = evaluationSelect.value;
            let total = '';

            switch (evaluation) {
                case 'Ù…Ù…ØªØ§Ø²':
                    total = '85';
                    break;
                case 'Ø¬ÙŠØ¯ Ø¬Ø¯Ø§':
                    total = '75';
                    break;
                case 'Ø¬ÙŠØ¯':
                    total = '65';
                    break;
                case 'Ù…Ù‚Ø¨ÙˆÙ„':
                    total = '50';
                    break;
                case 'Ø¶Ø¹ÙŠÙ':
                    total = '55';
                    break;
                case 'Ø±Ø§Ø³Ø¨':
                    total = '45';
                    break;
                default:
                    total = '';
            }

            totalInput.value = total;

            // Apply color coding
            const gradeClass = getGradeClass(parseFloat(total) || 0);
            totalInput.className = `subject-total ${gradeClass}`;
            evaluationSelect.className = `subject-evaluation ${gradeClass}`;
        }

        // Add student
        function addStudent() {
            const studentId = document.getElementById('studentId').value.trim();
            const studentName = document.getElementById('studentName').value.trim();
            const department = document.getElementById('department').value;
            const userSemester = document.getElementById('userSemesterSelect').value;

            if (!studentId || !studentName || !department) {
                showStatus('Ø§Ù„Ø±Ø¬Ø§Ø¡ Ù…Ù„Ø¡ Ø¬Ù…ÙŠØ¹ Ø§Ù„Ø­Ù‚ÙˆÙ„ Ø§Ù„Ù…Ø·Ù„ÙˆØ¨Ø©', 'error');
                return;
            }

            // Get subjects
            const subjects = [];
            const subjectInputs = document.querySelectorAll('#subjectsContainer .subject-input');

            subjectInputs.forEach(input => {
                const name = input.querySelector('.subject-name').value.trim();
                const units = input.querySelector('.subject-units').value;
                const classWork = input.querySelector('.subject-classwork').value;
                const finalExam = input.querySelector('.subject-final').value;

                // Only require name, units, classWork, and finalExam
                // Total and evaluation will be calculated automatically
                if (name && units && classWork && finalExam) {
                    const total = calculateTotalGrade(parseFloat(classWork), parseFloat(finalExam));
                    subjects.push({
                        name: name,
                        units: parseInt(units),
                        classWork: parseFloat(classWork),
                        finalExam: parseFloat(finalExam),
                        total: total,
                        evaluation: getEvaluation(total)
                    });
                }
            });

            if (subjects.length === 0) {
                showStatus('Ø§Ù„Ø±Ø¬Ø§Ø¡ Ø¥Ø¶Ø§ÙØ© Ù…Ø§Ø¯Ø© ÙˆØ§Ø­Ø¯Ø© Ø¹Ù„Ù‰ Ø§Ù„Ø£Ù‚Ù„', 'error');
                return;
            }

            // Check if student already exists
            if (students.find(s => s.id === studentId)) {
                showStatus('Ø§Ù„Ø·Ø§Ù„Ø¨ Ù…ÙˆØ¬ÙˆØ¯ Ø¨Ø§Ù„ÙØ¹Ù„', 'error');
                return;
            }

            // Create student object
            const student = {
                id: studentId,
                name: studentName,
                department: department,
                semester: userSemester || currentSemester,
                subjects: subjects,
                addedDate: new Date().toISOString()
            };

            // Add to students array
            students.push(student);

            // Save to localStorage
            localStorage.setItem('students', JSON.stringify(students));

            // Sync to Firebase
            console.log('ğŸ”„ Auto-syncing new student to Firebase...');
            autoSyncToFirebase();

            // Clear form
            clearForm();

            // Show success message
            showStatus(`ØªÙ… Ø¥Ø¶Ø§ÙØ© Ø§Ù„Ø·Ø§Ù„Ø¨ ${studentName} Ø¨Ù†Ø¬Ø§Ø­ Ù…Ø¹ ${subjects.length} Ù…ÙˆØ§Ø¯`, 'success');

            // Refresh student list
            displayStudents();
        }

        // Clear form
        function clearForm() {
            document.getElementById('studentId').value = '';
            document.getElementById('studentName').value = '';
            document.getElementById('department').value = '';
            document.getElementById('userSemesterSelect').value = '';

            // Reset subjects to one empty row
            const container = document.getElementById('subjectsContainer');
            container.innerHTML = `
                <div class="subject-input">
                    <input type="text" placeholder="Ø§Ø³Ù… Ø§Ù„Ù…Ø§Ø¯Ø©" class="subject-name">
                    <input type="number" placeholder="Ø§Ù„ÙˆØ­Ø¯Ø§Øª" class="subject-units" min="1" max="6">
                    <input type="number" placeholder="Ø£Ø¹Ù…Ø§Ù„ Ø§Ù„ÙØµÙ„" class="subject-classwork" min="0" max="50" onchange="autoCalculate(this)">
                    <input type="number" placeholder="Ø§Ù„Ø§Ø®ØªØ¨Ø§Ø± Ø§Ù„Ù†Ù‡Ø§Ø¦ÙŠ" class="subject-final" min="0" max="50" onchange="autoCalculate(this)">
                    <input type="number" placeholder="Ø§Ù„Ù…Ø¬Ù…ÙˆØ¹" class="subject-total" min="0" max="100" readonly style="background: rgba(15, 23, 42, 0.4); color: var(--text-color);">
                    <select class="subject-evaluation" readonly style="background: rgba(15, 23, 42, 0.4); color: var(--text-color);">
                        <option value="">ÙŠØªÙ… Ø­Ø³Ø§Ø¨ ØªÙ„Ù‚Ø§Ø¦ÙŠØ§Ù‹</option>
                        <option value="Ù…Ù…ØªØ§Ø²">Ù…Ù…ØªØ§Ø²</option>
                        <option value="Ø¬ÙŠØ¯ Ø¬Ø¯Ø§">Ø¬ÙŠØ¯ Ø¬Ø¯Ø§</option>
                        <option value="Ø¬ÙŠØ¯">Ø¬ÙŠØ¯</option>
                        <option value="Ù…Ù‚Ø¨ÙˆÙ„">Ù…Ù‚Ø¨ÙˆÙ„</option>
                        <option value="Ø¶Ø¹ÙŠÙ">Ø¶Ø¹ÙŠÙ</option>
                        <option value="Ø±Ø§Ø³Ø¨">Ø±Ø§Ø³Ø¨</option>
                    </select>
                    <button type="button" class="remove-subject" onclick="removeSubject(this)">Ø­Ø°Ù</button>
                </div>
            `;

            // Clear subjects grid
            document.getElementById('subjectsGrid').innerHTML = '<p style="color: #666; text-align: center; padding: 20px;">Ø£Ø¯Ø®Ù„ Ø§Ù„Ø±Ù‚Ù… Ø§Ù„Ø¯Ø±Ø§Ø³ÙŠ Ù„ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ù…ÙˆØ§Ø¯ ØªÙ„Ù‚Ø§Ø¦ÙŠØ§Ù‹</p>';

            // Reset selected subjects
            selectedSubjects = [];
        }

        // Quick search function
        function quickSearch(studentId) {
            document.getElementById('searchId').value = studentId;
            searchStudent();
        }

        // Clear search function
        function clearSearch() {
            document.getElementById('searchId').value = '';
            document.getElementById('searchResults').innerHTML = '';
            document.getElementById('studentResultDisplay').style.display = 'none';
            document.getElementById('studentResultDisplay').innerHTML = '';
        }

        // Enhanced searchStudent to check for blocked students
        function searchStudent() {
            const searchId = document.getElementById('searchId').value.trim();
            const resultsDiv = document.getElementById('searchResults');
            const resultDisplayDiv = document.getElementById('studentResultDisplay');

            if (!searchId) {
                resultsDiv.innerHTML = '<div class="no-results">Ø§Ù„Ø±Ø¬Ø§Ø¡ Ø¥Ø¯Ø®Ø§Ù„ Ø§Ù„Ø±Ù‚Ù… Ø§Ù„Ø¯Ø±Ø§Ø³ÙŠ</div>';
                resultDisplayDiv.style.display = 'none';
                return;
            }

            // Reload students from localStorage to get latest data
            const students = JSON.parse(localStorage.getItem('students')) || [];
            const student = students.find(s => s.id === searchId);

            if (!student) {
                resultsDiv.innerHTML = '<div class="no-results">Ø§Ù„Ø·Ø§Ù„Ø¨ ØºÙŠØ± Ù…ÙˆØ¬ÙˆØ¯</div>';
                resultDisplayDiv.style.display = 'none';
                return;
            }

            // Check if student is blocked
            const blockedStudents = JSON.parse(localStorage.getItem('blockedStudents') || '[]');
            const blocked = blockedStudents.find(b => b.studentId === searchId);

            if (blocked) {
                resultsDiv.innerHTML = `
                    <div class="student-card" style="border: 2px solid #dc3545; background: rgba(220, 53, 69, 0.1);">
                        <h3 style="color: #dc3545;">ğŸš« Ù†ØªÙŠØ¬Ø© Ø§Ù„Ø·Ø§Ù„Ø¨ Ù…Ø­Ø¬ÙˆØ¨Ø©</h3>
                        <p><strong>Ø§Ù„Ø±Ù‚Ù… Ø§Ù„Ø¯Ø±Ø§Ø³ÙŠ:</strong> ${student.id}</p>
                        <p><strong>Ø§Ø³Ù… Ø§Ù„Ø·Ø§Ù„Ø¨:</strong> ${student.name}</p>
                        <p><strong>Ø§Ù„Ù‚Ø³Ù…:</strong> ${student.department}</p>
                        <p><strong>Ø§Ù„ÙØµÙ„:</strong> ${student.semester}</p>
                        <div style="background: #f8d7da; color: #721c24; padding: 15px; border-radius: 5px; margin-top: 10px; border: 1px solid #f5c6cb;">
                            <h4 style="margin: 0 0 10px 0; color: #721c24;">Ø³Ø¨Ø¨ Ø§Ù„Ø­Ø¬Ø¨:</h4>
                            <p style="margin: 0; font-size: 14px; font-weight: bold;">${blocked.reason}</p>
                            <p style="margin: 10px 0 0 0; font-size: 12px; color: #856404;">
                                <strong>ØªØ§Ø±ÙŠØ® Ø§Ù„Ø­Ø¬Ø¨:</strong> ${new Date(blocked.date).toLocaleDateString('ar-SA')}
                            </p>
                        </div>
                        <div style="background: #fff3cd; color: #856404; padding: 10px; border-radius: 5px; margin-top: 10px; border: 1px solid #ffeaa7;">
                            <strong>Ù„Ø§ ÙŠÙ…ÙƒÙ† Ø¹Ø±Ø¶ Ø§Ù„Ù†ØªÙŠØ¬Ø© Ø¨Ø³Ø¨Ø¨ Ø§Ù„Ø­Ø¬Ø¨</strong>
                        </div>
                    </div>
                `;
                resultDisplayDiv.style.display = 'none';
                return;
            }

            // Display search result
            resultsDiv.innerHTML = `
                <div class="student-card">
                    <h3>${student.name}</h3>
                    <p><strong>Ø§Ù„Ø±Ù‚Ù… Ø§Ù„Ø¯Ø±Ø§Ø³ÙŠ:</strong> ${student.id}</p>
                    <p><strong>Ø§Ù„Ù‚Ø³Ù…:</strong> ${student.department}</p>
                    <p><strong>Ø§Ù„ÙØµÙ„:</strong> ${student.semester}</p>
                    <p><strong>Ø¹Ø¯Ø¯ Ø§Ù„Ù…ÙˆØ§Ø¯:</strong> ${student.subjects.length}</p>
                    <button class="primary" onclick="showSimpleResult('${student.id}')">Ø¹Ø±Ø¶ Ø§Ù„Ù†ØªÙŠØ¬Ø©</button>
                </div>
            `;

            resultDisplayDiv.style.display = 'none';
        }

        // Load all students
        function loadAllStudents() {
            console.log('ğŸ”„ loadAllStudents() called');
            const listDiv = document.getElementById('allStudentsList');
            
            if (!listDiv) {
                console.error('âŒ allStudentsList div not found!');
                return;
            }
            
            console.log('âœ… allStudentsList div found');

            // Try multiple data sources
            let students = [];
            
            // 1. Check localStorage first
            students = JSON.parse(localStorage.getItem('students')) || [];
            console.log('ğŸ“Š Students from localStorage:', students.length);
            
            // 2. Check if students-data.js exists and has newer data
            if (typeof studentsData !== 'undefined' && Array.isArray(studentsData) && studentsData.length > 0) {
                console.log('ğŸ“ Found students-data.js with', studentsData.length, 'students');
                
                // Check if we should sync from file (if file has more students)
                if (studentsData.length > students.length) {
                    console.log('ğŸ”„ Syncing from file - file has more students');
                    students = studentsData;
                    localStorage.setItem('students', JSON.stringify(students));
                    showStatus('âœ… ØªÙ… ØªØ­Ø¯ÙŠØ« Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ù…Ù† Ø§Ù„Ù…Ù„Ù ØªÙ„Ù‚Ø§Ø¦ÙŠØ§Ù‹', 'success');
                }
            }

            // 3. Check for any external data updates
            checkForExternalUpdates();

            if (students.length === 0) {
                console.log('âŒ No students found');
                listDiv.innerHTML = '<div class="no-results">Ù„Ø§ ØªÙˆØ¬Ø¯ Ø¨ÙŠØ§Ù†Ø§Øª Ø·Ù„Ø§Ø¨</div>';
                return;
            }

            console.log('ğŸ¯ Building HTML for', students.length, 'students');
            let html = '<div class="students-grid">';

            students.forEach((student, index) => {
                console.log(`ğŸ‘¤ Processing student ${index + 1}:`, student.name);
                
                const parsedId = parseStudentId(student.id);
                const idInfo = parsedId ? `
                    <div><strong>Ø§Ù„Ù‚Ø³Ù… (Ù…Ù† Ø§Ù„Ø±Ù‚Ù…):</strong> ${parsedId.department}</div>
                    <div><strong>Ø³Ù†Ø© Ø§Ù„ØªØ³Ø¬ÙŠÙ„:</strong> ${parsedId.fullYear} (${parsedId.semesterText})</div>
                    <div><strong>Ø±Ù‚Ù… Ø§Ù„ØªØ³Ù„Ø³Ù„:</strong> ${parsedId.sequence}</div>
                ` : '';

                const blockedStudents = JSON.parse(localStorage.getItem('blockedStudents') || '[]');
                const isBlocked = blockedStudents.some(b => b.studentId === student.id);

                html += `
                    <div class="student-card" style="${isBlocked ? 'border: 2px solid #dc3545; background: rgba(220, 53, 69, 0.1);' : ''}">
                        <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 10px;">
                            <h3 style="${isBlocked ? 'color: #dc3545;' : ''}">${student.name} ${isBlocked ? 'ğŸš«' : ''}</h3>
                            <div style="display: flex; gap: 8px;">
                                <button class="primary" onclick="showSimpleResult('${student.id}')">Ø¹Ø±Ø¶ Ø§Ù„Ù†ØªÙŠØ¬Ø©</button>
                                <button class="danger" onclick="deleteSimpleStudent('${student.id}')">Ø­Ø°Ù</button>
                            </div>
                        </div>
                        <div style="background: rgba(15, 23, 42, 0.4); padding: 10px; border-radius: 5px; margin-bottom: 10px;">
                            <p style="margin: 3px 0;"><strong>Ø§Ù„Ø±Ù‚Ù… Ø§Ù„Ø¯Ø±Ø§Ø³ÙŠ:</strong> ${student.id}</p>
                            <p style="margin: 3px 0;"><strong>Ø§Ù„Ù‚Ø³Ù…:</strong> ${student.department}</p>
                            <p style="margin: 3px 0;"><strong>Ø§Ù„ÙØµÙ„:</strong> ${student.semester}</p>
                            <p style="margin: 3px 0;"><strong>Ø¹Ø¯Ø¯ Ø§Ù„Ù…ÙˆØ§Ø¯:</strong> ${student.subjects ? student.subjects.length : 0}</p>
                            ${idInfo}
                        </div>
                        ${isBlocked ? `
                            <div style="background: #f8d7da; color: #721c24; padding: 10px; border-radius: 5px; margin: 10px 0;">
                                <h4 style="margin: 0 0 5px 0; font-size: 12px;">ğŸš« Ù†ØªÙŠØ¬Ø© Ù…Ø­Ø¬ÙˆØ¨Ø©</h4>
                                <p style="margin: 0; font-size: 11px;"><strong>Ø§Ù„Ø³Ø¨Ø¨:</strong> ${blockedStudents.find(b => b.studentId === student.id)?.reason}</p>
                            </div>
                        ` : ''}
                    </div>
                `;
            });

            html += '</div>';
            console.log('ğŸ¨ HTML built, setting innerHTML');
            listDiv.innerHTML = html;
            console.log('âœ… loadAllStudents() completed successfully');
        }

        // Check for external data updates
        function checkForExternalUpdates() {
            // Check if there's a newer version in students-data.js
            if (typeof studentsData !== 'undefined' && Array.isArray(studentsData)) {
                const localStudents = JSON.parse(localStorage.getItem('students')) || [];
                const fileStudents = studentsData;
                
                // Simple comparison - check if file has more students
                if (fileStudents.length > localStudents.length) {
                    console.log('ğŸ”„ External update detected - syncing...');
                    localStorage.setItem('students', JSON.stringify(fileStudents));
                    showStatus('âœ… ØªÙ… ØªØ­Ø¯ÙŠØ« Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª ØªÙ„Ù‚Ø§Ø¦ÙŠØ§Ù‹', 'success');
                    return true;
                }
            }
            return false;
        }

        // Manual sync function
        function syncWithFile() {
            if (typeof studentsData !== 'undefined' && Array.isArray(studentsData) && studentsData.length > 0) {
                if (confirm('Ù‡Ù„ ØªØ±ÙŠØ¯ Ù…Ø²Ø§Ù…Ù†Ø© Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ù…Ø¹ Ø§Ù„Ù…Ù„ÙØŸ Ø³ÙŠØªÙ… Ø§Ø³ØªØ¨Ø¯Ø§Ù„ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ø­Ø§Ù„ÙŠØ© Ø¨Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ù…Ù† Ø§Ù„Ù…Ù„Ù.')) {
                    localStorage.setItem('students', JSON.stringify(studentsData));
                    loadAllStudents();
                    showStatus('âœ… ØªÙ…Øª Ø§Ù„Ù…Ø²Ø§Ù…Ù†Ø© Ø¨Ù†Ø¬Ø§Ø­', 'success');
                }
            } else {
                showStatus('âŒ Ù„Ø§ ØªÙˆØ¬Ø¯ Ø¨ÙŠØ§Ù†Ø§Øª ÙÙŠ Ø§Ù„Ù…Ù„Ù Ù„Ù„Ù…Ø²Ø§Ù…Ù†Ø©', 'error');
            }
        }

        // Sync with external data (for static sites)
        function syncWithExternalData() {
            // Check for sync data from data_updater.html
            const syncData = localStorage.getItem('syncData');
            if (syncData) {
                try {
                    const data = JSON.parse(syncData);
                    const students = data.students;
                    
                    if (Array.isArray(students) && students.length > 0) {
                        localStorage.setItem('students', JSON.stringify(students));
                        loadAllStudents();
                        showStatus(`âœ… ØªÙ… Ù…Ø²Ø§Ù…Ù†Ø© ${students.length} Ø·Ø§Ù„Ø¨ Ø¨Ù†Ø¬Ø§Ø­`, 'success');
                        
                        // Clear sync data after successful sync
                        localStorage.removeItem('syncData');
                    }
                } catch (error) {
                    showStatus('âŒ Ø®Ø·Ø£ ÙÙŠ Ù‚Ø±Ø§Ø¡Ø© Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ù…Ø²Ø§Ù…Ù†Ø©', 'error');
                }
            } else {
                showStatus('âŒ Ù„Ø§ ØªÙˆØ¬Ø¯ Ø¨ÙŠØ§Ù†Ø§Øª Ù…Ø²Ø§Ù…Ù†Ø© Ù…ØªØ§Ø­Ø©', 'error');
            }
        }

        // Sync with Firebase
        async function syncWithFirebase() {
            console.log('ğŸ”„ Starting Firebase sync...');
            
            // Check internet connection first
            if (!navigator.onLine) {
                showStatus('âŒ Ù„Ø§ ÙŠÙˆØ¬Ø¯ Ø§ØªØµØ§Ù„ Ø¨Ø§Ù„Ø¥Ù†ØªØ±Ù†Øª', 'error');
                console.log('âŒ No internet connection');
                return;
            }
            
            // Check if Firebase is available in the main system
            if (typeof db !== 'undefined') {
                try {
                    console.log('âœ… Firebase db is available');
                    
                    const snapshot = await db.collection('students').get();
                    console.log('ğŸ“Š Firebase snapshot size:', snapshot.size);
                    
                    const students = [];
                    
                    snapshot.forEach(doc => {
                        const data = doc.data();
                        delete data.timestamp;
                        students.push(data);
                    });
                    
                    console.log('ğŸ‘¤ Students from Firebase:', students.length);
                    
                    if (students.length > 0) {
                        localStorage.setItem('students', JSON.stringify(students));
                        loadAllStudents();
                        showStatus(`âœ… ØªÙ… Ù…Ø²Ø§Ù…Ù†Ø© ${students.length} Ø·Ø§Ù„Ø¨ Ù…Ù† Firebase Ø¨Ù†Ø¬Ø§Ø­`, 'success');
                        console.log('âœ… Firebase sync completed successfully');
                    } else {
                        showStatus('âŒ Ù„Ø§ ØªÙˆØ¬Ø¯ Ø¨ÙŠØ§Ù†Ø§Øª ÙÙŠ Firebase', 'error');
                        console.log('âŒ No data found in Firebase');
                    }
                } catch (error) {
                    console.error('âŒ Firebase sync error:', error);
                    
                    // Check if it's a network error
                    if (error.message && error.message.includes('offline')) {
                        showStatus('âŒ Ù…Ø´ÙƒÙ„Ø© ÙÙŠ Ø§Ù„Ø§ØªØµØ§Ù„ Ø¨Ø§Ù„Ø¥Ù†ØªØ±Ù†Øª - ÙŠØ±Ø¬Ù‰ Ø§Ù„ØªØ­Ù‚Ù‚ Ù…Ù† Ø§Ù„Ø§ØªØµØ§Ù„', 'error');
                    } else if (error.message && error.message.includes('permission')) {
                        showStatus('âŒ Ù…Ø´ÙƒÙ„Ø© ÙÙŠ ØµÙ„Ø§Ø­ÙŠØ§Øª Ø§Ù„ÙˆØµÙˆÙ„ Ø¥Ù„Ù‰ Firebase', 'error');
                    } else {
                        showStatus('âŒ Ø®Ø·Ø£ ÙÙŠ Ø§Ù„Ù…Ø²Ø§Ù…Ù†Ø© Ù…Ø¹ Firebase: ' + error.message, 'error');
                    }
                }
            } else {
                console.log('âŒ Firebase db not available');
                showStatus('âŒ Firebase ØºÙŠØ± Ù…Ù‡ÙŠØ£ ÙÙŠ Ø§Ù„Ù…Ù†Ø¸ÙˆÙ…Ø©', 'error');
            }
        }

        // Push to Firebase
        async function pushToFirebase() {
            console.log('ğŸ“¤ Starting Firebase push...');
            
            // Check internet connection first
            if (!navigator.onLine) {
                showStatus('âŒ Ù„Ø§ ÙŠÙˆØ¬Ø¯ Ø§ØªØµØ§Ù„ Ø¨Ø§Ù„Ø¥Ù†ØªØ±Ù†Øª', 'error');
                console.log('âŒ No internet connection');
                return;
            }
            
            // Check if Firebase is available
            if (typeof db !== 'undefined') {
                try {
                    console.log('âœ… Firebase db is available');
                    
                    const students = JSON.parse(localStorage.getItem('students') || '[]');
                    console.log('ğŸ‘¤ Local students to push:', students.length);
                    
                    if (students.length === 0) {
                        showStatus('âŒ Ù„Ø§ ØªÙˆØ¬Ø¯ Ø¨ÙŠØ§Ù†Ø§Øª Ù…Ø­Ù„ÙŠØ© Ù„Ø¯ÙØ¹Ù‡Ø§ Ø¥Ù„Ù‰ Firebase', 'error');
                        return;
                    }
                    
                    // Clear existing data
                    console.log('ğŸ—‘ï¸ Clearing existing Firebase data...');
                    const snapshot = await db.collection('students').get();
                    const batch = db.batch();
                    snapshot.docs.forEach(doc => {
                        batch.delete(doc.ref);
                    });
                    await batch.commit();
                    console.log('âœ… Existing data cleared');
                    
                    // Add new data
                    console.log('ğŸ“¤ Adding new data to Firebase...');
                    for (const student of students) {
                        await db.collection('students').doc(student.id).set({
                            ...student,
                            timestamp: Date.now()
                        });
                    }
                    console.log('âœ… New data added to Firebase');
                    
                    showStatus(`âœ… ØªÙ… Ø¯ÙØ¹ ${students.length} Ø·Ø§Ù„Ø¨ Ø¥Ù„Ù‰ Firebase Ø¨Ù†Ø¬Ø§Ø­`, 'success');
                    console.log('âœ… Firebase push completed successfully');
                    
                } catch (error) {
                    console.error('âŒ Firebase push error:', error);
                    
                    // Check if it's a network error
                    if (error.message && error.message.includes('offline')) {
                        showStatus('âŒ Ù…Ø´ÙƒÙ„Ø© ÙÙŠ Ø§Ù„Ø§ØªØµØ§Ù„ Ø¨Ø§Ù„Ø¥Ù†ØªØ±Ù†Øª - Ø³ÙŠØªÙ… Ø­ÙØ¸ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ù…Ø­Ù„ÙŠØ§Ù‹', 'error');
                    } else if (error.message && error.message.includes('permission')) {
                        showStatus('âŒ Ù…Ø´ÙƒÙ„Ø© ÙÙŠ ØµÙ„Ø§Ø­ÙŠØ§Øª Ø§Ù„ÙˆØµÙˆÙ„ Ø¥Ù„Ù‰ Firebase', 'error');
                    } else {
                        showStatus('âŒ Ø®Ø·Ø£ ÙÙŠ Ø¯ÙØ¹ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ø¥Ù„Ù‰ Firebase: ' + error.message, 'error');
                    }
                }
            } else {
                console.log('âŒ Firebase db not available');
                showStatus('âŒ Firebase ØºÙŠØ± Ù…Ù‡ÙŠØ£ ÙÙŠ Ø§Ù„Ù…Ù†Ø¸ÙˆÙ…Ø©', 'error');
            }
        }

        // Auto sync after adding student
        async function autoSyncToFirebase() {
            console.log('ğŸ”„ Auto-syncing to Firebase after student addition...');
            
            // Check internet connection first
            if (!navigator.onLine) {
                showStatus('âš ï¸ Ù„Ø§ ÙŠÙˆØ¬Ø¯ Ø§ØªØµØ§Ù„ Ø¨Ø§Ù„Ø¥Ù†ØªØ±Ù†Øª - Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ù…Ø­ÙÙˆØ¸Ø© Ù…Ø­Ù„ÙŠØ§Ù‹ ÙÙ‚Ø·', 'warning');
                console.log('âš ï¸ No internet connection - data saved locally only');
                return;
            }
            
            await pushToFirebase();
        }

        // Sync with offline data (for when Firebase fails)
        function syncWithOfflineData() {
            // Check for offline sync data
            const syncData = localStorage.getItem('offlineSyncData');
            if (syncData) {
                try {
                    const data = JSON.parse(syncData);
                    
                    if (data.students && Array.isArray(data.students) && data.students.length > 0) {
                        localStorage.setItem('students', JSON.stringify(data.students));
                        loadAllStudents();
                        showStatus(`âœ… ØªÙ… Ù…Ø²Ø§Ù…Ù†Ø© ${data.students.length} Ø·Ø§Ù„Ø¨ Ø¨Ø¯ÙˆÙ† Ø¥Ù†ØªØ±Ù†Øª Ø¨Ù†Ø¬Ø§Ø­`, 'success');
                        console.log('âœ… Offline sync completed successfully');
                        
                        // Clear sync data after successful sync
                        localStorage.removeItem('offlineSyncData');
                    } else {
                        showStatus('âŒ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ù…Ø³ØªÙˆØ±Ø¯Ø© ØºÙŠØ± ØµØ§Ù„Ø­Ø©', 'error');
                    }
                } catch (error) {
                    showStatus('âŒ Ø®Ø·Ø£ ÙÙŠ Ù‚Ø±Ø§Ø¡Ø© Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ù…Ø²Ø§Ù…Ù†Ø©: ' + error.message, 'error');
                }
            } else {
                showStatus('âŒ Ù„Ø§ ØªÙˆØ¬Ø¯ Ø¨ÙŠØ§Ù†Ø§Øª Ù…Ø²Ø§Ù…Ù†Ø© Ù…ØªØ§Ø­Ø©', 'error');
            }
        }

        // Check connection status
        function checkConnectionStatus() {
            if (navigator.onLine) {
                console.log('ğŸŒ Online - Firebase sync available');
                return true;
            } else {
                console.log('ğŸ“´ Offline - Firebase sync unavailable');
                return false;
            }
        }

        // Add connection status listener
        window.addEventListener('online', function() {
            console.log('ğŸŒ Connection restored - attempting Firebase sync');
            showStatus('ğŸŒ ØªÙ… Ø§Ø³ØªØ¹Ø§Ø¯Ø© Ø§Ù„Ø§ØªØµØ§Ù„ Ø¨Ø§Ù„Ø¥Ù†ØªØ±Ù†Øª', 'success');
            // Try to sync when connection is restored
            setTimeout(() => {
                if (typeof db !== 'undefined') {
                    pushToFirebase();
                }
            }, 2000);
        });

        window.addEventListener('offline', function() {
            console.log('ğŸ“´ Connection lost - Firebase sync unavailable');
            showStatus('ğŸ“´ ÙÙ‚Ø¯Ø§Ù† Ø§Ù„Ø§ØªØµØ§Ù„ Ø¨Ø§Ù„Ø¥Ù†ØªØ±Ù†Øª - Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ù…Ø­ÙÙˆØ¸Ø© Ù…Ø­Ù„ÙŠØ§Ù‹', 'warning');
        });

        // Add test students
        function addTestStudents() {
            const testStudents = [
                {
                    id: 'AC242037',
                    name: 'Ø£Ø­Ù…Ø¯ Ù…Ø­Ù…Ø¯ Ø¹Ù„ÙŠ',
                    department: 'Ø¹Ù„ÙˆÙ… Ø§Ù„Ø­Ø§Ø³Ø¨',
                    semester: 'Ø§Ù„Ø³Ø§Ø¯Ø³',
                    subjects: [
                        { name: 'Ø¨Ø±Ù…Ø¬Ø© Ù…ØªÙ‚Ø¯Ù…Ø©', degree: 85, status: 'Ù†Ø¬Ø­' },
                        { name: 'Ø´Ø¨ÙƒØ§Øª', degree: 90, status: 'Ù†Ø¬Ø­' },
                        { name: 'Ù‚ÙˆØ§Ø¹Ø¯ Ø¨ÙŠØ§Ù†Ø§Øª', degree: 78, status: 'Ù†Ø¬Ø­' }
                    ]
                },
                {
                    id: 'AC242038',
                    name: 'ÙØ§Ø·Ù…Ø© Ø­Ø³Ù† Ø¥Ø¨Ø±Ø§Ù‡ÙŠÙ…',
                    department: 'Ù†Ø¸Ù… Ù…Ø¹Ù„ÙˆÙ…Ø§Øª',
                    semester: 'Ø§Ù„Ø±Ø§Ø¨Ø¹',
                    subjects: [
                        { name: 'ØªØ­Ù„ÙŠÙ„ Ù†Ø¸Ù…', degree: 92, status: 'Ù†Ø¬Ø­' },
                        { name: 'Ø¥Ø¯Ø§Ø±Ø© Ù…Ø´Ø§Ø±ÙŠØ¹', degree: 88, status: 'Ù†Ø¬Ø­' }
                    ]
                },
                {
                    id: 'AC242039',
                    name: 'Ù…Ø­Ù…Ø¯ Ø¹Ø¨Ø¯Ø§Ù„Ù„Ù‡ Ø³Ø§Ù„Ù…',
                    department: 'Ù‡Ù†Ø¯Ø³Ø© Ø¨Ø±Ù…Ø¬ÙŠØ§Øª',
                    semester: 'Ø§Ù„Ø«Ø§Ù…Ù†',
                    subjects: [
                        { name: 'Ø°ÙƒØ§Ø¡ Ø§ØµØ·Ù†Ø§Ø¹ÙŠ', degree: 95, status: 'Ù…Ù…ØªØ§Ø²' },
                        { name: 'Ø£Ù…Ù† Ù…Ø¹Ù„ÙˆÙ…Ø§Øª', degree: 87, status: 'Ù†Ø¬Ø­' }
                    ]
                }
            ];
            
            localStorage.setItem('students', JSON.stringify(testStudents));
            showStatus('âœ… ØªÙ… Ø¥Ø¶Ø§ÙØ© 3 Ø·Ù„Ø§Ø¨ ØªØ¬Ø±ÙŠØ¨ÙŠÙŠÙ† Ø¨Ù†Ø¬Ø§Ø­', 'success');
            loadAllStudents();
        }

        // Force load data from static file (Manual Overwrite)
        function forceLoadFromStatic() {
            if (typeof studentsData !== 'undefined' && Array.isArray(studentsData) && studentsData.length > 0) {
                if (confirm('Ù‡Ù„ Ø£Ù†Øª Ù…ØªØ£ÙƒØ¯ØŸ Ø³ÙŠØªÙ… Ø§Ø³ØªØ¨Ø¯Ø§Ù„ Ø£ÙŠ Ø¨ÙŠØ§Ù†Ø§Øª Ø­Ø§Ù„ÙŠØ© Ø¨Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ù…ÙˆØ¬ÙˆØ¯Ø© ÙÙŠ Ù…Ù„Ù Ø§Ù„Ù…ÙˆÙ‚Ø¹.')) {
                    localStorage.setItem('students', JSON.stringify(studentsData));
                    showStatus('âœ… ØªÙ… Ø§Ø³ØªØ¹Ø§Ø¯Ø© Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ø¨Ù†Ø¬Ø§Ø­!', 'success');
                    setTimeout(() => location.reload(), 1000);
                }
            } else {
                showStatus('âŒ Ù…Ù„Ù Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª ØºÙŠØ± Ù…ÙˆØ¬ÙˆØ¯ Ø£Ùˆ ÙØ§Ø±Øº. ØªØ£ÙƒØ¯ Ù…Ù† Ø±ÙØ¹ students-data.js', 'error');
            }
        }

        // Make functions global
        window.deleteStudent = function (studentId) {
            if (confirm('Ù‡Ù„ Ø£Ù†Øª Ù…ØªØ£ÙƒØ¯ Ù…Ù† Ø­Ø°Ù Ù‡Ø°Ø§ Ø§Ù„Ø·Ø§Ù„Ø¨ØŸ')) {
                students = students.filter(s => s.id !== studentId);
                localStorage.setItem('students', JSON.stringify(students));

                // Refresh students data
                window.refreshStudents();

                // Remove from Firebase
                if (db) {
                    db.collection('students').doc(studentId).delete()
                        .then(() => console.log('ğŸ—‘ï¸ Student removed from Cloud'))
                        .catch(err => console.error('âŒ Cloud removal failed:', err));
                }

                showStatus('ØªÙ… Ø­Ø°Ù Ø§Ù„Ø·Ø§Ù„Ø¨ Ø¨Ù†Ø¬Ø§Ø­', 'success');
                loadAllStudents();
            }
        }

        // Display student
        function displayStudent(studentId) {
            // Reload students from localStorage to get latest data
            const students = JSON.parse(localStorage.getItem('students')) || [];
            const student = students.find(s => s.id === studentId);
            if (!student) return;

            const resultsDiv = document.getElementById('searchResults');
            const parsedId = parseStudentId(student.id);
            const idInfo = parsedId ? `
                <div><strong>Ø§Ù„Ù‚Ø³Ù… (Ù…Ù† Ø§Ù„Ø±Ù‚Ù…):</strong> ${parsedId.department}</div>
                <div><strong>Ø³Ù†Ø© Ø§Ù„ØªØ³Ø¬ÙŠÙ„:</strong> ${parsedId.fullYear} (${parsedId.semesterText})</div>
                <div><strong>Ø±Ù‚Ù… Ø§Ù„ØªØ³Ù„Ø³Ù„:</strong> ${parsedId.sequence}</div>
            ` : '';

            // Create subjects table
            let subjectsHtml = '<table class="grades-table"><thead><tr><th>Ù…</th><th>Ø§Ø³Ù… Ø§Ù„Ù…Ø§Ø¯Ø©</th><th>ÙˆØ­Ø¯Ø§Øª</th><th>Ø£Ø¹Ù…Ø§Ù„ Ø§Ù„ÙØµÙ„</th><th>Ø§Ù„Ø§Ø®ØªØ¨Ø§Ø± Ø§Ù„Ù†Ù‡Ø§Ø¦ÙŠ</th><th>Ø§Ù„Ù…Ø¬Ù…ÙˆØ¹</th><th>Ø§Ù„ØªÙ‚Ø¯ÙŠØ±</th></tr></thead><tbody>';

            student.subjects.forEach((subject, index) => {
                const isFailed = subject.name.includes('(Ù…Ø·Ø§Ù„Ø¨)');
                const gradeClass = getGradeClass(subject.total);
                subjectsHtml += `
                    <tr class="${isFailed ? 'failed-subject' : ''}">
                        <td>${index + 1}</td>
                        <td>${subject.name}</td>
                        <td>${subject.units}</td>
                        <td>${subject.classWork}</td>
                        <td>${subject.finalExam}</td>
                        <td class="${gradeClass}">${subject.total}</td>
                        <td class="${gradeClass}">${subject.evaluation}</td>
                    </tr>
                `;
            });

            subjectsHtml += '</tbody></table>';

            resultsDiv.innerHTML = `
                <div class="student-card">
                    <h3>${student.name}</h3>
                    <p><strong>Ø§Ù„Ø±Ù‚Ù… Ø§Ù„Ø¯Ø±Ø§Ø³ÙŠ:</strong> ${student.id}</p>
                    <p><strong>Ø§Ù„Ù‚Ø³Ù…:</strong> ${student.department}</p>
                    <p><strong>Ø§Ù„ÙØµÙ„:</strong> ${student.semester}</p>
                    ${idInfo}
                    <div style="margin-top: 15px;">
                        <h4>Ø§Ù„Ù…ÙˆØ§Ø¯ ÙˆØ§Ù„Ø¯Ø±Ø¬Ø§Øª:</h4>
                        ${subjectsHtml}
                    </div>
                    <div style="margin-top: 10px;">
                        <button class="primary" onclick="displayStudentResult('${student.id}')">Ø¹Ø±Ø¶ Ø§Ù„Ù†ØªÙŠØ¬Ø© Ø§Ù„ÙƒØ§Ù…Ù„Ø©</button>
                        <button class="danger" onclick="deleteStudent('${student.id}')">Ø­Ø°Ù</button>
                    </div>
                </div>
            `;
        }

        // Grading helper functions
        function getGrade(score) {
            score = parseFloat(score) || 0;
            if (score >= 85) return "Ù…Ù…ØªØ§Ø²";
            if (score >= 75) return "Ø¬ÙŠØ¯ Ø¬Ø¯Ø§Ù‹";
            if (score >= 65) return "Ø¬ÙŠØ¯";
            if (score >= 50) return "Ù…Ù‚Ø¨ÙˆÙ„";
            return "Ø±Ø§Ø³Ø¨";
        }

        function getEvaluation(score) {
            return getGrade(score);
        }

        function getGradeClass(total) {
            total = parseFloat(total) || 0;
            if (total >= 85) return 'grade-excellent';
            if (total >= 75) return 'grade-very-good';
            if (total >= 65) return 'grade-good';
            if (total >= 50) return 'grade-acceptable';
            return 'failed-subject';
        }

        // Calculate student GPA
        function calculateStudentGPA(student) {
            if (!student.subjects || student.subjects.length === 0) {
                return 0;
            }

            let totalUnits = 0;
            let totalWeightedGrade = 0;

            student.subjects.forEach(subject => {
                if (subject && typeof subject.total === 'number' && typeof subject.units === 'number') {
                    totalUnits += subject.units;
                    totalWeightedGrade += (subject.total * subject.units);
                }
            });

            return totalUnits > 0 ? (totalWeightedGrade / totalUnits).toFixed(2) : 0;
        }

        // Check if student has failed in any "Ù…Ø·Ø§Ù„Ø¨" subject
        function hasFailedRequiredSubject(student) {
            if (!student.subjects || student.subjects.length === 0) {
                return false;
            }

            return student.subjects.some(subject => {
                return subject &&
                    subject.name &&
                    subject.name.includes('(Ù…Ø·Ø§Ù„Ø¨)') &&
                    subject.total < 50;
            });
        }

        // Calculate semester pass/fail status with new "Ù…Ø·Ø§Ù„Ø¨" rule
        function calculateSemesterStatus(student) {
            const studentGPA = parseFloat(calculateStudentGPA(student));
            const failedSubjects = student.subjects ? student.subjects.filter(s => s.total < 50).length : 0;
            const hasFailedRequired = hasFailedRequiredSubject(student);

            // Check if required subject rule is enabled
            const ruleEnabled = settings.requiredSubjectRuleEnabled !== false; // Default to true

            // New rule: If student failed any "Ù…Ø·Ø§Ù„Ø¨" subject AND rule is enabled, they fail regardless of other conditions
            if (hasFailedRequired && ruleEnabled) {
                return {
                    passed: false,
                    reason: 'Ø±Ø§Ø³Ø¨ Ø¨Ø³Ø¨Ø¨ Ù…Ø§Ø¯Ø© Ù…Ø·Ø§Ù„Ø¨Ø©',
                    gpa: studentGPA,
                    failedSubjects: failedSubjects,
                    hasFailedRequired: true
                };
            }

            // Original rule: Pass if failed subjects <= 2 AND GPA >= 50
            const passed = failedSubjects <= 2 && studentGPA >= 50;

            return {
                passed: passed,
                reason: passed ? 'Ù…Ù†Ù‚ÙˆÙ„' : 'Ø±Ø§Ø³Ø¨',
                gpa: studentGPA,
                failedSubjects: failedSubjects,
                hasFailedRequired: false
            };
        }

        // Simple functions that work 100% - from test_simple.html
        function showSimpleResult(studentId) {
            // Reload students from localStorage to get latest data
            const students = JSON.parse(localStorage.getItem('students')) || [];
            const student = students.find(s => s.id === studentId);

            if (!student) {
                alert('Ø§Ù„Ø·Ø§Ù„Ø¨ ØºÙŠØ± Ù…ÙˆØ¬ÙˆØ¯');
                return;
            }

            // Find the student card by ID and insert result after it
            const studentCards = document.querySelectorAll('.student-card');
            let targetCard = null;
            let targetIndex = -1;

            for (let i = 0; i < studentCards.length; i++) {
                const cardHtml = studentCards[i].innerHTML;
                if (cardHtml.includes(studentId)) {
                    targetCard = studentCards[i];
                    targetIndex = i;
                    break;
                }
            }

            if (targetCard) {
                // Calculate actual GPA and evaluation using new semester status function
                const semesterStatus = calculateSemesterStatus(student);
                const studentGPA = semesterStatus.gpa;
                const studentEvaluation = getEvaluation(studentGPA);
                const passedSubjects = student.subjects ? student.subjects.filter(s => s.total >= 50).length : 0;
                const failedSubjects = semesterStatus.failedSubjects;
                const isSemesterPassed = semesterStatus.passed;
                const statusReason = semesterStatus.reason;

                const resultDiv = document.createElement('div');
                resultDiv.className = 'result';
                resultDiv.innerHTML = `
                    <div style="background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white; padding: 20px; border-radius: 10px; text-align: center; margin: 10px 0;">
                        <h3 style="margin: 0 0 15px 0; font-size: 20px;">ğŸ“Š Ù†ØªÙŠØ¬Ø© Ø§Ù„Ø·Ø§Ù„Ø¨</h3>
                        <p style="margin: 10px 0; font-size: 18px;"><strong style="color: #fff;">Ø§Ù„Ù…Ø¹Ø¯Ù„ Ø§Ù„ØªØ±Ø§ÙƒÙ…ÙŠ:</strong> <span style="color: #ffd700; font-size: 18px; font-weight: bold;">${studentGPA}</span></p>
                        <p style="margin: 10px 0; font-size: 18px;"><strong style="color: #fff;">Ø§Ù„ØªÙ‚Ø¯ÙŠØ±:</strong> <span style="color: #ffd700; font-size: 18px; font-weight: bold;">${studentEvaluation}</span></p>
                        <p style="margin: 10px 0; font-size: 16px;"><strong style="color: #fff;">Ø§Ù„Ù…ÙˆØ§Ø¯ Ø§Ù„Ù†Ø§Ø¬Ø­Ø©:</strong> <span style="color: #4ade80; font-weight: bold;">${passedSubjects}</span></p>
                        <p style="margin: 10px 0; font-size: 16px;"><strong style="color: #fff;">Ø§Ù„Ù…ÙˆØ§Ø¯ Ø§Ù„Ø±Ø§Ø³Ø¨Ø©:</strong> <span style="color: #f87171; font-weight: bold;">${failedSubjects}</span></p>
                        <p style="margin: 10px 0; font-size: 16px;"><strong style="color: #fff;">Ø­Ø§Ù„Ø© Ø§Ù„ÙØµÙ„:</strong> <span style="color: #fbbf24; font-weight: bold;">${statusReason}</span></p>
                        ${semesterStatus.hasFailedRequired ? '<p style="margin: 10px 0; font-size: 14px; color: #ff6b6b; font-weight: bold;">âš ï¸ Ø§Ù„Ø·Ø§Ù„Ø¨ Ø±Ø§Ø³Ø¨ Ø¨Ø³Ø¨Ø¨ Ù…Ø§Ø¯Ø© Ù…Ø·Ø§Ù„Ø¨Ø©</p>' : ''}
                    </div>
                    <table style="width: 100%; border-collapse: collapse; margin: 10px 0; background: rgba(30, 41, 59, 0.4); border-radius: 10px; overflow: hidden; box-shadow: 0 2px 10px rgba(0,0,0,0.1);">
                        <thead>
                            <tr style="background: linear-gradient(135deg, #4f46e5 0%, #7c3aed 100%); color: white;">
                                <th style="padding: 12px; border: none; text-align: center; font-weight: bold;">Ù…</th>
                                <th style="padding: 12px; border: none; text-align: center; font-weight: bold;">Ø§Ù„Ù…Ø§Ø¯Ø©</th>
                                <th style="padding: 12px; border: none; text-align: center; font-weight: bold;">ÙˆØ­Ø¯Ø§Øª</th>
                                <th style="padding: 12px; border: none; text-align: center; font-weight: bold;">Ø£Ø¹Ù…Ø§Ù„ Ø§Ù„ÙØµÙ„</th>
                                <th style="padding: 12px; border: none; text-align: center; font-weight: bold;">Ø§Ù„Ø§Ø®ØªØ¨Ø§Ø± Ø§Ù„Ù†Ù‡Ø§Ø¦ÙŠ</th>
                                <th style="padding: 12px; border: none; text-align: center; font-weight: bold;">Ø§Ù„Ù…Ø¬Ù…ÙˆØ¹</th>
                                <th style="padding: 12px; border: none; text-align: center; font-weight: bold;">Ø§Ù„ØªÙ‚Ø¯ÙŠØ±</th>
                                <th style="padding: 12px; border: none; text-align: center; font-weight: bold;">Ø§Ù„Ø­Ø§Ù„Ø©</th>
                            </tr>
                        </thead>
                        <tbody>
                             ${student.subjects ? student.subjects.map((subject, idx) => `
                                <tr style="${subject.total >= 50 ? 'background: rgba(16, 185, 129, 0.05);' : 'background: rgba(239, 68, 68, 0.05);'} border-bottom: 1px solid rgba(255,255,255,0.05);">
                                    <td style="padding: 10px; border: none; text-align: center; font-weight: bold; color: var(--text-color);">${idx + 1}</td>
                                    <td style="padding: 10px; border: none; text-align: right; color: var(--text-color); font-weight: 500;">${subject.name}</td>
                                    <td style="padding: 10px; border: none; text-align: center; color: var(--text-color); font-weight: bold;">${subject.units}</td>
                                    <td style="padding: 10px; border: none; text-align: center; color: var(--text-muted);">${subject.classWork}</td>
                                    <td style="padding: 10px; border: none; text-align: center; color: var(--text-muted);">${subject.finalExam}</td>
                                    <td style="padding: 10px; border: none; text-align: center; font-weight: bold; color: ${subject.total >= 50 ? '#10b981' : '#f87171'};">${subject.total}</td>
                                    <td style="padding: 10px; border: none; text-align: center; color: var(--text-color);">${subject.evaluation}</td>
                                    <td style="padding: 10px; border: none; text-align: center;">
                                        ${subject.total >= 50 ?
                        '<span style="color: #059669; font-weight: bold;">âœ… Ù†Ø§Ø¬Ø­</span>' :
                        '<span style="color: #dc2626; font-weight: bold;">âŒ Ø±Ø§Ø³Ø¨</span>'}
                                    </td>
                                </tr>
                            `).join('') : ''}
                            <tr style="background: linear-gradient(135deg, #6b7280 0%, #4b5563 100%); color: white; font-weight: bold;">
                                <td colspan="2" style="padding: 12px; border: none; text-align: center;">Ø§Ù„Ù…Ø¬Ù…ÙˆØ¹</td>
                                <td style="padding: 12px; border: none; text-align: center;">${student.subjects ? student.subjects.reduce((sum, s) => sum + s.units, 0) : 0}</td>
                                <td style="padding: 12px; border: none; text-align: center;">-</td>
                                <td style="padding: 12px; border: none; text-align: center;">-</td>
                                <td style="padding: 12px; border: none; text-align: center;">-</td>
                                <td style="padding: 12px; border: none; text-align: center;">-</td>
                                <td style="padding: 12px; border: none; text-align: center;">-</td>
                            </tr>
                        </tbody>
                    </table>
                    <div style="text-align: center; margin-top: 20px;">
                        <button class="button danger" onclick="this.parentElement.parentElement.remove()" style="background: linear-gradient(135deg, #dc2626 0%, #b91c1c 100%); color: white; border: none; padding: 12px 24px; border-radius: 8px; cursor: pointer; font-weight: bold; font-size: 16px;">Ø¥ØºÙ„Ø§Ù‚</button>
                    </div>
                `;

                // Remove any existing result for this student
                const existingResults = targetCard.parentElement.querySelectorAll('.result');
                existingResults.forEach(r => r.remove());

                // Insert result after the student card
                targetCard.parentNode.insertBefore(resultDiv, targetCard.nextSibling);

                // Scroll to result
                resultDiv.scrollIntoView({ behavior: 'smooth', block: 'nearest' });
            }
        }

        function deleteSimpleStudent(studentId) {
            // Reload students from localStorage to get latest data
            const students = JSON.parse(localStorage.getItem('students')) || [];
            const student = students.find(s => s.id === studentId);

            if (!student) {
                alert('Ø§Ù„Ø·Ø§Ù„Ø¨ ØºÙŠØ± Ù…ÙˆØ¬ÙˆØ¯');
                return;
            }

            if (confirm('Ù‡Ù„ Ø£Ù†Øª Ù…ØªØ£ÙƒØ¯ Ù…Ù† Ø­Ø°Ù Ø§Ù„Ø·Ø§Ù„Ø¨ ' + student.name + 'ØŸ')) {
                const updatedStudents = students.filter(s => s.id !== studentId);
                localStorage.setItem('students', JSON.stringify(updatedStudents));

                // Refresh students data
                window.refreshStudents();

                loadAllStudents();
                alert('ØªÙ… Ø­Ø°Ù Ø§Ù„Ø·Ø§Ù„Ø¨ Ø¨Ù†Ø¬Ø§Ø­');
            }
        }

        // Generate student search link function
        function generateStudentSearchLink() {
            // Get current URL directory
            // If hosted on Firebase, use the proper hosting domain
            let urlPath;
            if (window.location.hostname.includes('firebaseapp.com')) {
                urlPath = window.location.origin + '/student_search.html';
            } else {
                const currentUrl = window.location.origin + window.location.pathname;
                urlPath = currentUrl.substring(0, currentUrl.lastIndexOf('/')) + '/student_search.html';
            }

            // Batch sync all to cloud before generating link (optional but good)
            syncToFirebase();

            // Create modal to show the link
            const modal = document.createElement('div');
            modal.style.cssText = `
                position: fixed;
                top: 0;
                left: 0;
                width: 100%;
                height: 100%;
                background: rgba(0, 0, 0, 0.5);
                display: flex;
                justify-content: center;
                align-items: center;
                z-index: 10000;
            `;

            modal.innerHTML = `
                <div style="background: var(--bg-color); color: var(--text-color); padding: 30px; border-radius: 15px; max-width: 500px; width: 90%; text-align: center; box-shadow: 0 10px 30px rgba(0,0,0,0.3); border: 1px solid var(--border-color); backdrop-filter: var(--glass);">
                    <h2 style="color: #3b82f6; margin-bottom: 20px;">ğŸ”— Ø±Ø§Ø¨Ø· Ø§Ù„Ø¨Ø­Ø« Ø¹Ù† Ø§Ù„Ù†ØªÙŠØ¬Ø© Ù„Ù„Ø·Ù„Ø§Ø¨</h2>
                    <div style="background: #f8f9fa; padding: 15px; border-radius: 8px; margin: 20px 0; border: 2px solid #e5e7eb;">
                        <p style="margin: 0 0 15px 0; color: #374151; font-weight: bold;">ÙŠÙ…ÙƒÙ† Ù„Ù„Ø·Ù„Ø§Ø¨ Ø§Ø³ØªØ®Ø¯Ø§Ù… Ù‡Ø°Ø§ Ø§Ù„Ø±Ø§Ø¨Ø· Ù„Ù„Ø¨Ø­Ø« Ø¹Ù† Ù†ØªØ§Ø¦Ø¬Ù‡Ù…</p>
                        <div style="background: white; padding: 10px; border-radius: 5px; border: 1px solid #d1d5db;">
                            <input type="text" value="${urlPath}" readonly style="width: 100%; border: none; outline: none; font-family: monospace; font-size: 12px; direction: ltr;" id="linkInput">
                        </div>
                    </div>
                    <div style="background: #e3f2fd; padding: 15px; border-radius: 8px; margin: 20px 0; border: 1px solid #bbdefb;">
                        <h3 style="margin: 0 0 10px 0; color: #1976d2;">ğŸ“‹ Ø®Ø·ÙˆØ§Øª Ø§Ù„Ø§Ø³ØªØ®Ø¯Ø§Ù… Ù„Ù„Ø·Ø§Ù„Ø¨:</h3>
                        <ol style="margin: 0; padding-right: 20px; text-align: right; color: #424242; font-size: 14px;">
                            <li>ÙŠÙØªØ­ Ø§Ù„Ø·Ø§Ù„Ø¨ Ø§Ù„Ø±Ø§Ø¨Ø·</li>
                            <li>ÙŠØ¯Ø®Ù„ Ø±Ù‚Ù…Ù‡ Ø§Ù„Ø¯Ø±Ø§Ø³ÙŠ ÙÙŠ Ø­Ù‚Ù„ Ø§Ù„Ø¨Ø­Ø«</li>
                            <li>ÙŠØ¶ØºØ· Ø¹Ù„Ù‰ Ø²Ø± "Ø¨Ø­Ø«"</li>
                            <li>ØªØ¸Ù‡Ø± Ù†ØªÙŠØ¬ØªÙ‡ Ù…Ø¨Ø§Ø´Ø±Ø©</li>
                        </ol>
                    </div>
                    <div style="background: #d4edda; padding: 15px; border-radius: 8px; margin: 20px 0; border: 1px solid #c3e6cb;">
                        <h3 style="margin: 0 0 10px 0; color: #155724;">âœ¨ Ù…Ù…ÙŠØ²Ø§Øª ØµÙØ­Ø© Ø§Ù„Ø·Ø§Ù„Ø¨:</h3>
                        <ul style="margin: 0; padding-right: 20px; text-align: right; color: #155724; font-size: 14px;">
                            <li>ØµÙØ­Ø© Ù†Ø¸ÙŠÙØ© ÙˆØ®Ø§ØµØ© Ù„Ù„Ø·Ù„Ø§Ø¨</li>
                            <li>Ù„Ø§ ØªÙˆØ¬Ø¯ Ù†Ø§ÙØ°Ø© Ø¯Ø®ÙˆÙ„ Ø£Ùˆ Ø£Ø²Ø±Ø§Ø± ØªØ­ÙƒÙ…</li>
                            <li>ÙˆØ§Ø¬Ù‡Ø© Ø¨Ø³ÙŠØ·Ø© ÙˆØ³Ù‡Ù„Ø© Ø§Ù„Ø§Ø³ØªØ®Ø¯Ø§Ù…</li>
                            <li>Ø¹Ø±Ø¶ ÙƒØ§Ù…Ù„ Ù„Ù„Ù†ØªÙŠØ¬Ø© Ù…Ø¹ Ø¬Ø¯ÙˆÙ„ Ø§Ù„Ù…ÙˆØ§Ø¯</li>
                        </ul>
                    </div>
                    <div style="display: flex; gap: 10px; justify-content: center; margin-top: 20px;">
                        <button onclick="copyLink('${urlPath}')" style="background: linear-gradient(135deg, #10b981 0%, #059669 100%); color: white; border: none; padding: 10px 20px; border-radius: 8px; cursor: pointer; font-weight: bold;">ğŸ“‹ Ù†Ø³Ø® Ø§Ù„Ø±Ø§Ø¨Ø·</button>
                        <button onclick="testLink('${urlPath}')" style="background: linear-gradient(135deg, #8b5cf6 0%, #7c3aed 100%); color: white; border: none; padding: 10px 20px; border-radius: 8px; cursor: pointer; font-weight: bold;">ğŸ§ª Ø§Ø®ØªØ¨Ø§Ø± Ø§Ù„Ø±Ø§Ø¨Ø·</button>
                        <button onclick="this.parentElement.parentElement.parentElement.remove()" style="background: linear-gradient(135deg, #ef4444 0%, #dc2626 100%); color: white; border: none; padding: 10px 20px; border-radius: 8px; cursor: pointer; font-weight: bold;">Ø¥ØºÙ„Ø§Ù‚</button>
                    </div>
                    <p style="margin-top: 15px; font-size: 12px; color: #6b7280;">ÙŠÙ…ÙƒÙ† Ù…Ø´Ø§Ø±ÙƒØ© Ù‡Ø°Ø§ Ø§Ù„Ø±Ø§Ø¨Ø· Ù…Ø¹ Ø¬Ù…ÙŠØ¹ Ø§Ù„Ø·Ù„Ø§Ø¨</p>
                </div>
            `;

            document.body.appendChild(modal);

            // Auto-select the link text
            setTimeout(() => {
                const linkInput = document.getElementById('linkInput');
                if (linkInput) {
                    linkInput.select();
                    linkInput.setSelectionRange(0, 99999);
                }
            }, 100);
        }

        // Copy link to clipboard
        function copyLink(link) {
            navigator.clipboard.writeText(link).then(() => {
                alert('âœ… ØªÙ… Ù†Ø³Ø® Ø§Ù„Ø±Ø§Ø¨Ø· Ø¨Ù†Ø¬Ø§Ø­!');
            }).catch(() => {
                // Fallback for older browsers
                const textArea = document.createElement('textarea');
                textArea.value = link;
                document.body.appendChild(textArea);
                textArea.select();
                document.execCommand('copy');
                document.body.removeChild(textArea);
                alert('âœ… ØªÙ… Ù†Ø³Ø® Ø§Ù„Ø±Ø§Ø¨Ø· Ø¨Ù†Ø¬Ø§Ø­!');
            });
        }

        // Test link in new window
        function testLink(link) {
            window.open(link, '_blank');
        }

        // Make functions global - simplified version
        window.displayStudentResult = function (studentId) {
            console.log('=== displayStudentResult START ===');
            console.log('Student ID:', studentId);
            console.log('Students array:', students);
            console.log('Students length:', students.length);

            const student = students.find(s => s.id === studentId);
            console.log('Found student:', student);

            if (!student) {
                console.log('Student not found!');
                alert('Ø§Ù„Ø·Ø§Ù„Ø¨ ØºÙŠØ± Ù…ÙˆØ¬ÙˆØ¯');
                return;
            }

            console.log('Student found, name:', student.name);

            const resultDisplayDiv = document.getElementById('studentResultDisplay');
            console.log('Display element:', resultDisplayDiv);

            if (!resultDisplayDiv) {
                console.log('Display element not found!');
                alert('Ø¹Ù†ØµØ± Ø§Ù„Ø¹Ø±Ø¶ ØºÙŠØ± Ù…ÙˆØ¬ÙˆØ¯');
                return;
            }

            console.log('Creating HTML content...');

            // Very simple display
            const htmlContent = `
                <div style="padding: 20px; background: #e8f4fd; border: 3px solid #007bff; border-radius: 15px; margin: 20px;">
                    <h2 style="color: #007bff; margin-bottom: 15px;">ğŸ“ Ù†ØªÙŠØ¬Ø© Ø§Ù„Ø·Ø§Ù„Ø¨</h2>
                    <div style="background: white; padding: 15px; border-radius: 10px;">
                        <p style="margin: 10px 0;"><strong>Ø§Ù„Ø§Ø³Ù…:</strong> <span style="color: #007bff; font-size: 18px;">${student.name}</span></p>
                        <p style="margin: 10px 0;"><strong>Ø§Ù„Ø±Ù‚Ù…:</strong> <span style="color: #495057;">${student.id}</span></p>
                        <p style="margin: 10px 0;"><strong>Ø§Ù„Ù‚Ø³Ù…:</strong> <span style="color: #495057;">${student.department}</span></p>
                        <p style="margin: 10px 0;"><strong>Ø§Ù„ÙØµÙ„:</strong> <span style="color: #495057;">${student.semester}</span></p>
                        <p style="margin: 10px 0;"><strong>Ø¹Ø¯Ø¯ Ø§Ù„Ù…ÙˆØ§Ø¯:</strong> <span style="color: #495057;">${student.subjects ? student.subjects.length : 0}</span></p>
                    </div>
                    <div style="text-align: center; margin-top: 15px;">
                        <button onclick="this.parentElement.parentElement.parentElement.style.display='none'" style="background: #dc3545; color: white; border: none; padding: 10px 20px; border-radius: 5px; cursor: pointer;">Ø¥ØºÙ„Ø§Ù‚</button>
                    </div>
                </div>
            `;

            console.log('Setting innerHTML...');
            resultDisplayDiv.innerHTML = htmlContent;

            console.log('Making it visible...');
            resultDisplayDiv.style.display = 'block';

            console.log('Scrolling to element...');
            resultDisplayDiv.scrollIntoView({ behavior: 'smooth' });

            console.log('=== displayStudentResult END ===');
        };

        // Block Student Functions
        function blockStudent() {
            const studentId = document.getElementById('blockStudentId').value.trim();
            const reason = document.getElementById('blockReason').value.trim();

            if (!studentId) {
                showStatus('Ø§Ù„Ø±Ø¬Ø§Ø¡ Ø¥Ø¯Ø®Ø§Ù„ Ø§Ù„Ø±Ù‚Ù… Ø§Ù„Ø¯Ø±Ø§Ø³ÙŠ', 'error');
                return;
            }

            if (!reason) {
                showStatus('Ø§Ù„Ø±Ø¬Ø§Ø¡ Ø¥Ø¯Ø®Ø§Ù„ Ø³Ø¨Ø¨ Ø§Ù„Ø­Ø¬Ø¨', 'error');
                return;
            }

            const student = students.find(s => s.id === studentId);
            if (!student) {
                showStatus('Ø§Ù„Ø·Ø§Ù„Ø¨ ØºÙŠØ± Ù…ÙˆØ¬ÙˆØ¯', 'error');
                return;
            }

            // Get existing blocked students or create new array
            let blockedStudents = JSON.parse(localStorage.getItem('blockedStudents') || '[]');

            // Check if already blocked
            const existingBlock = blockedStudents.find(b => b.studentId === studentId);
            if (existingBlock) {
                existingBlock.reason = reason;
                existingBlock.date = new Date().toISOString();
            } else {
                blockedStudents.push({
                    studentId: studentId,
                    studentName: student.name,
                    reason: reason,
                    date: new Date().toISOString()
                });
            }

            localStorage.setItem('blockedStudents', JSON.stringify(blockedStudents));
            showStatus('ØªÙ… Ø­Ø¬Ø¨ Ù†ØªÙŠØ¬Ø© Ø§Ù„Ø·Ø§Ù„Ø¨ Ø¨Ù†Ø¬Ø§Ø­', 'success');

            // Sync to Firestore
            if (db) {
                db.collection('blockedStudents').doc(studentId).set(blockedStudents.find(b => b.studentId === studentId))
                    .then(() => console.log('ğŸš« Blocked status synced to Cloud'))
                    .catch(err => console.error('âŒ Blocked sync failed:', err));
            }

            // Clear form
            document.getElementById('blockStudentId').value = '';
            document.getElementById('blockReason').value = '';

            // Update lists
            loadBlockedStudents();
        }

        function unblockStudent() {
            const studentId = document.getElementById('blockStudentId').value.trim();

            if (!studentId) {
                showStatus('Ø§Ù„Ø±Ø¬Ø§Ø¡ Ø¥Ø¯Ø®Ø§Ù„ Ø§Ù„Ø±Ù‚Ù… Ø§Ù„Ø¯Ø±Ø§Ø³ÙŠ', 'error');
                return;
            }

            let blockedStudents = JSON.parse(localStorage.getItem('blockedStudents') || '[]');
            const initialLength = blockedStudents.length;

            blockedStudents = blockedStudents.filter(b => b.studentId !== studentId);

            if (blockedStudents.length === initialLength) {
                showStatus('Ø§Ù„Ø·Ø§Ù„Ø¨ ØºÙŠØ± Ù…Ø­Ø¬ÙˆØ¨ Ø£ØµÙ„Ø§Ù‹', 'warning');
                return;
            }

            localStorage.setItem('blockedStudents', JSON.stringify(blockedStudents));
            showStatus('ØªÙ… Ø¥Ù„ØºØ§Ø¡ Ø­Ø¬Ø¨ Ù†ØªÙŠØ¬Ø© Ø§Ù„Ø·Ø§Ù„Ø¨ Ø¨Ù†Ø¬Ø§Ø­', 'success');

            // Remove from Firestore
            if (db) {
                db.collection('blockedStudents').doc(studentId).delete()
                    .then(() => console.log('âœ… Blocked status removed from Cloud'))
                    .catch(err => console.error('âŒ Blocked removal failed:', err));
            }

            // Clear form and update lists
            document.getElementById('blockStudentId').value = '';
            loadBlockedStudents();
        }

        function checkBlockedStatus() {
            const studentId = document.getElementById('blockStudentId').value.trim();
            const statusDiv = document.getElementById('blockStatus');

            if (!studentId) {
                statusDiv.innerHTML = '<div class="no-results">Ø§Ù„Ø±Ø¬Ø§Ø¡ Ø¥Ø¯Ø®Ø§Ù„ Ø§Ù„Ø±Ù‚Ù… Ø§Ù„Ø¯Ø±Ø§Ø³ÙŠ</div>';
                return;
            }

            const blockedStudents = JSON.parse(localStorage.getItem('blockedStudents') || '[]');
            const blocked = blockedStudents.find(b => b.studentId === studentId);

            if (blocked) {
                statusDiv.innerHTML = `
                    <div class="alert alert-danger" style="background: #f8d7da; color: #721c24; padding: 15px; border-radius: 5px; border: 1px solid #f5c6cb;">
                        <h4>ğŸš« Ù†ØªÙŠØ¬Ø© Ø§Ù„Ø·Ø§Ù„Ø¨ Ù…Ø­Ø¬ÙˆØ¨Ø©</h4>
                        <p><strong>Ø§Ù„Ø±Ù‚Ù… Ø§Ù„Ø¯Ø±Ø§Ø³ÙŠ:</strong> ${blocked.studentId}</p>
                        <p><strong>Ø§Ø³Ù… Ø§Ù„Ø·Ø§Ù„Ø¨:</strong> ${blocked.studentName}</p>
                        <p><strong>Ø³Ø¨Ø¨ Ø§Ù„Ø­Ø¬Ø¨:</strong> ${blocked.reason}</p>
                        <p><strong>ØªØ§Ø±ÙŠØ® Ø§Ù„Ø­Ø¬Ø¨:</strong> ${new Date(blocked.date).toLocaleDateString('ar-SA')}</p>
                    </div>
                `;
            } else {
                statusDiv.innerHTML = `
                    <div class="alert alert-success" style="background: #d4edda; color: #155724; padding: 15px; border-radius: 5px; border: 1px solid #c3e6cb;">
                        <h4>âœ… Ù†ØªÙŠØ¬Ø© Ø§Ù„Ø·Ø§Ù„Ø¨ ØºÙŠØ± Ù…Ø­Ø¬ÙˆØ¨Ø©</h4>
                        <p>Ø§Ù„Ø·Ø§Ù„Ø¨ Ø¨Ø±Ù‚Ù… ${studentId} ÙŠÙ…ÙƒÙ†Ù‡ Ø¹Ø±Ø¶ Ù†ØªÙŠØ¬ØªÙ‡ Ø¨Ø´ÙƒÙ„ Ø·Ø¨ÙŠØ¹ÙŠ</p>
                    </div>
                `;
            }
        }

        function loadBlockedStudents() {
            const blockedStudents = JSON.parse(localStorage.getItem('blockedStudents') || '[]');
            const listDiv = document.getElementById('blockedStudentsList');

            if (blockedStudents.length === 0) {
                listDiv.innerHTML = '<div class="no-results">Ù„Ø§ ÙŠÙˆØ¬Ø¯ Ø·Ù„Ø§Ø¨ Ù…Ø­Ø¬ÙˆØ¨ÙˆÙ†</div>';
                return;
            }

            let html = `
                <table class="students-table" style="margin-top: 15px;">
                    <thead>
                        <tr>
                            <th>Ø§Ù„Ø±Ù‚Ù… Ø§Ù„Ø¯Ø±Ø§Ø³ÙŠ</th>
                            <th>Ø§Ø³Ù… Ø§Ù„Ø·Ø§Ù„Ø¨</th>
                            <th>Ø³Ø¨Ø¨ Ø§Ù„Ø­Ø¬Ø¨</th>
                            <th>ØªØ§Ø±ÙŠØ® Ø§Ù„Ø­Ø¬Ø¨</th>
                            <th>Ø¥Ø¬Ø±Ø§Ø¡Ø§Øª</th>
                        </tr>
                    </thead>
                    <tbody>
            `;

            blockedStudents.forEach(blocked => {
                html += `
                    <tr>
                        <td>${blocked.studentId}</td>
                        <td>${blocked.studentName}</td>
                        <td>${blocked.reason}</td>
                        <td>${new Date(blocked.date).toLocaleDateString('ar-SA')}</td>
                        <td>
                            <button onclick="unblockStudentById('${blocked.studentId}')" class="success" style="padding: 5px 10px; font-size: 12px;">âœ… Ø¥Ù„ØºØ§Ø¡</button>
                        </td>
                    </tr>
                `;
            });

            html += '</tbody></table>';
            listDiv.innerHTML = html;
        }

        function unblockStudentById(studentId) {
            document.getElementById('blockStudentId').value = studentId;
            unblockStudent();
        }

        // Print All Functions
        function printAllStudents() {
            try {
                const includeBlocked = document.getElementById('includeBlocked').checked;
                const sortByDepartment = document.getElementById('sortByDepartment').checked;
                const sortBySemester = document.getElementById('sortBySemester').checked;
                const departmentFilter = document.getElementById('departmentFilter').value;

                let studentsToPrint = [...students];

                // Filter by department
                if (departmentFilter) {
                    studentsToPrint = studentsToPrint.filter(s => s.department === departmentFilter);
                }

                // Filter blocked students
                if (!includeBlocked) {
                    const blockedStudents = JSON.parse(localStorage.getItem('blockedStudents') || '[]');
                    const blockedIds = blockedStudents.map(b => b.studentId);
                    studentsToPrint = studentsToPrint.filter(s => !blockedIds.includes(s.id));
                }

                // Sort students
                if (sortByDepartment) {
                    studentsToPrint.sort((a, b) => {
                        const deptA = a.department || '';
                        const deptB = b.department || '';
                        return deptA.localeCompare(deptB);
                    });
                }
                if (sortBySemester) {
                    studentsToPrint.sort((a, b) => {
                        const semA = a.semester || '';
                        const semB = b.semester || '';
                        return semA.localeCompare(semB);
                    });
                }

                if (studentsToPrint.length === 0) {
                    alert('Ù„Ø§ ÙŠÙˆØ¬Ø¯ Ø·Ù„Ø§Ø¨ Ù„Ù„Ø·Ø¨Ø§Ø¹Ø©');
                    return;
                }

                // Generate print content - each student on separate page
                let printContent = `
                    <div style="direction: rtl; font-family: Arial, sans-serif; padding: 10px;">
                `;

                studentsToPrint.forEach((student, index) => {
                    // Check if student exists and has required properties
                    if (!student || !student.id || !student.subjects) {
                        console.warn('Skipping invalid student:', student);
                        return;
                    }

                    const blockedStudents = JSON.parse(localStorage.getItem('blockedStudents') || '[]');
                    const isBlocked = blockedStudents.some(b => b.studentId === student.id);

                    // Calculate GPA
                    let totalUnits = 0;
                    let totalClassWork = 0;
                    let totalFinal = 0;
                    let totalGrade = 0;
                    let totalWeightedGrade = 0;
                    let passedSubjects = 0;
                    let failedSubjects = 0;

                    if (Array.isArray(student.subjects)) {
                        student.subjects.forEach(subject => {
                            if (subject && typeof subject.total === 'number' && typeof subject.units === 'number') {
                                totalUnits += subject.units;
                                totalClassWork += subject.classWork || 0;
                                totalFinal += subject.finalExam || 0;
                                totalGrade += subject.total;
                                totalWeightedGrade += (subject.total * subject.units);

                                // Check pass/fail status
                                if (subject.total >= 50 && (subject.finalExam || 0) >= 30) {
                                    passedSubjects++;
                                } else {
                                    failedSubjects++;
                                }
                            }
                        });
                    }

                    const semesterGPA = totalUnits > 0 ? (totalWeightedGrade / totalUnits).toFixed(2) : 0;
                    const evaluation = getEvaluation(parseFloat(semesterGPA));
                    const semesterStatus = calculateSemesterStatus(student);
                    const isSemesterPassed = semesterStatus.passed;

                    // Start new page for each student (except first)
                    if (index > 0) {
                        printContent += `<div style="page-break-before: always;"></div>`;
                    }

                    printContent += `
                        <div style="display: flex; flex-direction: column;">
                            <!-- Header -->
                            <div style="text-align: center; margin-bottom: 15px; border-bottom: 2px solid #007bff; padding-bottom: 10px;">
                                <h1 style="margin: 0; font-size: 18px; color: #007bff; font-weight: bold;">Ø§Ù„Ù…Ø¹Ù‡Ø¯ Ø§Ù„Ø¹Ø§Ù„ÙŠ Ù„Ù„Ø¹Ù„ÙˆÙ… ÙˆØ§Ù„ØªÙ‚Ù†ÙŠØ© Ø§Ù„Ø¬ÙØ±Ø© Ø¨Ø³ÙˆÙƒÙ†Ø©</h1>
                                <h2 style="margin: 3px 0 0 0; font-size: 16px; color: #495057;">Ù†ØªÙŠØ¬Ø© Ø§Ù„Ø·Ø§Ù„Ø¨</h2>
                                <p style="margin: 3px 0 0 0; font-size: 12px; color: #6c757d;">Ø§Ù„ØªØ§Ø±ÙŠØ®: ${new Date().toLocaleDateString('ar-SA')}</p>
                            </div>
                            
                            <!-- Student Info -->
                            <div style="background: linear-gradient(135deg, #f8f9fa 0%, #e9ecef 100%); padding: 20px; margin-bottom: 20px; border-radius: 10px; border: 2px solid #dee2e6; box-shadow: 0 4px 6px rgba(0,0,0,0.1);">
                                <div style="text-align: center; margin-bottom: 15px;">
                                    <h3 style="margin: 0; color: #007bff; font-size: 18px; font-weight: bold;">${student.name || ''} ${isBlocked ? 'ğŸš«' : ''}</h3>
                                </div>
                                <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 12px; margin-bottom: 15px;">
                                    <div style="background: white; padding: 10px; border-radius: 5px; border: 1px solid #dee2e6;">
                                        <p style="margin: 0; font-size: 11px; color: #6c757d; font-weight: bold;">Ø§Ù„Ø±Ù‚Ù… Ø§Ù„Ø¯Ø±Ø§Ø³ÙŠ</p>
                                        <p style="margin: 5px 0 0 0; font-size: 13px; color: #495057; font-weight: bold;">${student.id || ''}</p>
                                    </div>
                                    <div style="background: white; padding: 10px; border-radius: 5px; border: 1px solid #dee2e6;">
                                        <p style="margin: 0; font-size: 11px; color: #6c757d; font-weight: bold;">Ø§Ù„Ù‚Ø³Ù…</p>
                                        <p style="margin: 5px 0 0 0; font-size: 13px; color: #495057; font-weight: bold;">${student.department || ''}</p>
                                    </div>
                                </div>
                                <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 12px; margin-bottom: 15px;">
                                    <div style="background: white; padding: 10px; border-radius: 5px; border: 1px solid #dee2e6;">
                                        <p style="margin: 0; font-size: 11px; color: #6c757d; font-weight: bold;">Ø§Ù„ÙØµÙ„</p>
                                        <p style="margin: 5px 0 0 0; font-size: 13px; color: #495057; font-weight: bold;">${student.semester || ''}</p>
                                    </div>
                                    <div style="background: white; padding: 10px; border-radius: 5px; border: 1px solid #dee2e6;">
                                        <p style="margin: 0; font-size: 11px; color: #6c757d; font-weight: bold;">Ø§Ù„Ù…Ø¹Ø¯Ù„ Ø§Ù„ÙØµÙ„ÙŠ</p>
                                        <p style="margin: 5px 0 0 0; font-size: 13px; color: #007bff; font-weight: bold;">${semesterGPA}</p>
                                    </div>
                                </div>
                                <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 12px;">
                                    <div style="background: white; padding: 10px; border-radius: 5px; border: 1px solid #dee2e6;">
                                        <p style="margin: 0; font-size: 11px; color: #6c757d; font-weight: bold;">Ø§Ù„Ù…ÙˆØ§Ø¯ Ø§Ù„Ù†Ø§Ø¬Ø­Ø©</p>
                                        <p style="margin: 5px 0 0 0; font-size: 13px; color: #28a745; font-weight: bold;">${passedSubjects}</p>
                                    </div>
                                    <div style="background: white; padding: 10px; border-radius: 5px; border: 1px solid #dee2e6;">
                                        <p style="margin: 0; font-size: 11px; color: #6c757d; font-weight: bold;">Ø§Ù„Ù…ÙˆØ§Ø¯ Ø§Ù„Ø±Ø§Ø³Ø¨Ø©</p>
                                        <p style="margin: 5px 0 0 0; font-size: 13px; color: #dc3545; font-weight: bold;">${failedSubjects}</span></p>
                                    </div>
                                </div>
                                ${isBlocked ? '<div style="background: #f8d7da; color: #721c24; padding: 10px; border-radius: 5px; margin-top: 10px; text-align: center; font-weight: bold;">ğŸš« Ù†ØªÙŠØ¬Ø© Ù…Ø­Ø¬ÙˆØ¨Ø©</div>' : ''}
                            </div>
                            
                            <!-- Subjects Table -->
                            <div style="flex: 1; background: white; border-radius: 10px; border: 2px solid #dee2e6; box-shadow: 0 4px 6px rgba(0,0,0,0.1); overflow: hidden;">
                                <div style="background: linear-gradient(135deg, #007bff 0%, #0056b3 100%); color: white; padding: 12px; text-align: center;">
                                    <h4 style="margin: 0; font-size: 14px; font-weight: bold;">ğŸ“š ØªÙØ§ØµÙŠÙ„ Ø§Ù„Ù…ÙˆØ§Ø¯</h4>
                                </div>
                                <table style="width: 100%; border-collapse: collapse; font-size: 10px;">
                                    <thead>
                                        <tr style="background: #f8f9fa;">
                                            <th style="padding: 8px 5px; border: 1px solid #ddd; font-weight: bold; color: #495057;">Ù…</th>
                                            <th style="padding: 8px 5px; border: 1px solid #ddd; font-weight: bold; color: #495057;">Ø§Ø³Ù… Ø§Ù„Ù…Ø§Ø¯Ø©</th>
                                            <th style="padding: 8px 5px; border: 1px solid #ddd; font-weight: bold; color: #495057;">ÙˆØ­Ø¯Ø§Øª</th>
                                            <th style="padding: 8px 5px; border: 1px solid #ddd; font-weight: bold; color: #495057;">Ø£Ø¹Ù…Ø§Ù„ Ø§Ù„ÙØµÙ„</th>
                                            <th style="padding: 8px 5px; border: 1px solid #ddd; font-weight: bold; color: #495057;">Ø§Ù„Ø§Ø®ØªØ¨Ø§Ø± Ø§Ù„Ù†Ù‡Ø§Ø¦ÙŠ</th>
                                            <th style="padding: 8px 5px; border: 1px solid #ddd; font-weight: bold; color: #495057;">Ø§Ù„Ù…Ø¬Ù…ÙˆØ¹</th>
                                            <th style="padding: 8px 5px; border: 1px solid #ddd; font-weight: bold; color: #495057;">Ø§Ù„ØªÙ‚Ø¯ÙŠØ±</th>
                                            <th style="padding: 8px 5px; border: 1px solid #ddd; font-weight: bold; color: #495057;">Ø§Ù„Ø­Ø§Ù„Ø©</th>
                                        </tr>
                                    </thead>
                                    <tbody>
                    `;

                    if (Array.isArray(student.subjects)) {
                        student.subjects.forEach((subject, subjectIndex) => {
                            if (!subject) return;

                            const isFailed = subject.name && subject.name.includes('(Ù…Ø·Ø§Ù„Ø¨)') || (subject.total < 50) || ((subject.finalExam || 0) < 30);
                            const statusClass = isFailed ? 'status-fail' : 'status-pass';
                            const statusText = isFailed ? 'Ø±Ø§Ø³Ø¨' : 'Ù†Ø§Ø¬Ø­';
                            const statusIcon = isFailed ? 'âŒ' : 'âœ…';

                            printContent += `
                                        <tr style="${isFailed ? 'background: #fff5f5;' : 'background: #f8f9fa;'}">
                                            <td style="padding: 8px 5px; border: 1px solid #ddd; text-align: center; font-weight: bold;">${subjectIndex + 1}</td>
                                            <td style="padding: 8px 5px; border: 1px solid #ddd; font-weight: ${isFailed ? 'bold' : 'normal'}; color: ${isFailed ? '#dc3545' : '#495057'};">${subject.name || ''}</td>
                                            <td style="padding: 8px 5px; border: 1px solid #ddd; text-align: center;">${subject.units || 0}</td>
                                            <td style="padding: 8px 5px; border: 1px solid #ddd; text-align: center;">${subject.classWork || 0}</td>
                                            <td style="padding: 8px 5px; border: 1px solid #ddd; text-align: center;">${subject.finalExam || 0}</td>
                                            <td style="padding: 8px 5px; border: 1px solid #ddd; text-align: center; font-weight: bold; color: ${isFailed ? '#dc3545' : '#495057'};">${subject.total || 0}</td>
                                            <td style="padding: 8px 5px; border: 1px solid #ddd; text-align: center; font-weight: bold;">${subject.evaluation || ''}</td>
                                            <td style="padding: 8px 5px; border: 1px solid #ddd; text-align: center; font-weight: bold;">${statusIcon} ${statusText}</td>
                                        </tr>
                            `;
                        });
                    }

                    printContent += `
                                        <tr style="background: linear-gradient(135deg, #e9ecef 0%, #dee2e6 100%); font-weight: bold;">
                                            <td colspan="2" style="padding: 10px 5px; border: 1px solid #ddd; text-align: center; font-size: 12px;">Ø§Ù„Ù…Ø¬Ù…ÙˆØ¹</td>
                                            <td style="padding: 10px 5px; border: 1px solid #ddd; text-align: center; font-size: 12px; font-weight: bold;">${totalUnits}</td>
                                            <td style="padding: 10px 5px; border: 1px solid #ddd; text-align: center; font-size: 12px;">-</td>
                                            <td style="padding: 10px 5px; border: 1px solid #ddd; text-align: center; font-size: 12px;">-</td>
                                            <td style="padding: 10px 5px; border: 1px solid #ddd; text-align: center; font-size: 12px;">-</td>
                                            <td style="padding: 10px 5px; border: 1px solid #ddd; text-align: center; font-size: 12px;">-</td>
                                            <td style="padding: 10px 5px; border: 1px solid #ddd; text-align: center; font-size: 12px;">-</td>
                                        </tr>
                                        <tr style="background: linear-gradient(135deg, #007bff 0%, #0056b3 100%); color: white;">
                                            <td colspan="8" style="padding: 12px 5px; border: 1px solid #ddd; text-align: center;">
                                                <p style="font-size: 14px; font-weight: bold; margin: 0;">Ø§Ø¹ØªÙ…Ø§Ø¯ Ù…ÙƒØªØ¨ Ø§Ù„ØªØ³Ø¬ÙŠÙ„</p>
                                                <div style="margin-top: 6px;">
                                                    <div style="border-bottom: 3px solid white; width: 120px; margin: 0 auto;"></div>
                                                </div>
                                            </td>
                                        </tr>
                                    </tbody>
                                </table>
                            </div>
                        </div>
                    `;
                });

                printContent += `
                    </div>
                `;

                // Print in new window
                const printWindow = window.open('', '_blank');
                printWindow.document.write(`
                    <!DOCTYPE html>
                    <html lang="ar" dir="rtl">
                    <head>
                        <meta charset="UTF-8">
                        <title>ÙƒØ´Ù Ù†ØªØ§Ø¦Ø¬ Ø§Ù„Ø·Ù„Ø§Ø¨</title>
                    </head>
                    <body>
                        ${printContent}
                    </body>
                    </html>
                `);
                printWindow.document.close();
                printWindow.print();
                printWindow.close();

            } catch (error) {
                console.error('Error in printAllStudents:', error);
                alert('Ø­Ø¯Ø« Ø®Ø·Ø£ ÙÙŠ Ø§Ù„Ø·Ø¨Ø§Ø¹Ø©: ' + error.message);
            }
        }

        function previewPrintAll() {
            try {
                const previewDiv = document.getElementById('printPreview');
                const includeBlocked = document.getElementById('includeBlocked').checked;
                const departmentFilter = document.getElementById('departmentFilter').value;

                let studentsToPrint = [...students];

                // Apply filters
                if (departmentFilter) {
                    studentsToPrint = studentsToPrint.filter(s => s.department === departmentFilter);
                }

                if (!includeBlocked) {
                    const blockedStudents = JSON.parse(localStorage.getItem('blockedStudents') || '[]');
                    const blockedIds = blockedStudents.map(b => b.studentId);
                    studentsToPrint = studentsToPrint.filter(s => !blockedIds.includes(s.id));
                }

                previewDiv.innerHTML = `
                    <div style="background: #f8f9fa; padding: 15px; border-radius: 5px; margin-top: 10px; border: 1px solid #dee2e6;">
                        <h4 style="margin: 0 0 10px 0; color: #495057;">ğŸ‘ï¸ Ù…Ø¹Ø§ÙŠÙ†Ø© Ø§Ù„Ø·Ø¨Ø§Ø¹Ø©</h4>
                        <p style="margin: 5px 0;"><strong>Ø¹Ø¯Ø¯ Ø§Ù„Ø·Ù„Ø§Ø¨:</strong> ${studentsToPrint.length}</p>
                        <p style="margin: 5px 0;"><strong>ØªØ¶Ù…ÙŠÙ† Ø§Ù„Ù…Ø­Ø¬ÙˆØ¨ÙŠÙ†:</strong> ${includeBlocked ? 'Ù†Ø¹Ù…' : 'Ù„Ø§'}</p>
                        <p style="margin: 5px 0;"><strong>ÙÙ„ØªØ± Ø§Ù„Ù‚Ø³Ù…:</strong> ${departmentFilter || 'Ø¬Ù…ÙŠØ¹ Ø§Ù„Ø£Ù‚Ø³Ø§Ù…'}</p>
                        <button onclick="printAllStudents()" class="primary" style="margin-top: 10px; padding: 8px 16px;">ğŸ–¨ï¸ Ø·Ø¨Ø§Ø¹Ø© Ø§Ù„Ø¢Ù†</button>
                    </div>
                `;
            } catch (error) {
                console.error('Error in previewPrintAll:', error);
                alert('Ø­Ø¯Ø« Ø®Ø·Ø£ ÙÙŠ Ø§Ù„Ù…Ø¹Ø§ÙŠÙ†Ø©: ' + error.message);
            }
        }

        function exportToPDF() {
            try {
                const includeBlocked = document.getElementById('includeBlocked').checked;
                const sortByDepartment = document.getElementById('sortByDepartment').checked;
                const sortBySemester = document.getElementById('sortBySemester').checked;
                const departmentFilter = document.getElementById('departmentFilter').value;

                let studentsToPrint = [...students];

                // Apply same filters as print
                if (departmentFilter) {
                    studentsToPrint = studentsToPrint.filter(s => s.department === departmentFilter);
                }

                if (!includeBlocked) {
                    const blockedStudents = JSON.parse(localStorage.getItem('blockedStudents') || '[]');
                    const blockedIds = blockedStudents.map(b => b.studentId);
                    studentsToPrint = studentsToPrint.filter(s => !blockedIds.includes(s.id));
                }

                if (sortByDepartment) {
                    studentsToPrint.sort((a, b) => {
                        const deptA = a.department || '';
                        const deptB = b.department || '';
                        return deptA.localeCompare(deptB);
                    });
                }
                if (sortBySemester) {
                    studentsToPrint.sort((a, b) => {
                        const semA = a.semester || '';
                        const semB = b.semester || '';
                        return semA.localeCompare(semB);
                    });
                }

                if (studentsToPrint.length === 0) {
                    alert('Ù„Ø§ ÙŠÙˆØ¬Ø¯ Ø·Ù„Ø§Ø¨ Ù„Ù„ØªØµØ¯ÙŠØ±');
                    return;
                }

                // Generate PDF content using window.print() as fallback
                let pdfContent = `
                    <div style="direction: rtl; font-family: Arial, sans-serif; padding: 10px;">
                        <div style="text-align: center; margin-bottom: 20px; border-bottom: 2px solid #007bff; padding-bottom: 15px;">
                            <h1 style="margin: 0; font-size: 18px; color: #007bff; font-weight: bold;">Ø§Ù„Ù…Ø¹Ù‡Ø¯ Ø§Ù„Ø¹Ø§Ù„ÙŠ Ù„Ù„Ø¹Ù„ÙˆÙ… ÙˆØ§Ù„ØªÙ‚Ù†ÙŠØ© Ø§Ù„Ø¬ÙØ±Ø© Ø¨Ø³ÙˆÙƒÙ†Ø©</h1>
                            <h2 style="margin: 5px 0 0 0; font-size: 16px; color: #495057;">ÙƒØ´Ù Ù†ØªØ§Ø¦Ø¬ Ø¬Ù…ÙŠØ¹ Ø§Ù„Ø·Ù„Ø§Ø¨ (PDF)</h2>
                            <p style="margin: 5px 0 0 0; font-size: 12px; color: #6c757d;">Ø§Ù„ØªØ§Ø±ÙŠØ®: ${new Date().toLocaleDateString('ar-SA')}</p>
                        </div>
                        
                        <table style="width: 100%; border-collapse: collapse; font-size: 10px;">
                            <thead>
                                <tr style="background: #f8f9fa; border-bottom: 2px solid #dee2e6;">
                                    <th style="padding: 8px; border: 1px solid #ddd;">Ù…</th>
                                    <th style="padding: 8px; border: 1px solid #ddd;">Ø§Ù„Ø±Ù‚Ù… Ø§Ù„Ø¯Ø±Ø§Ø³ÙŠ</th>
                                    <th style="padding: 8px; border: 1px solid #ddd;">Ø§Ø³Ù… Ø§Ù„Ø·Ø§Ù„Ø¨</th>
                                    <th style="padding: 8px; border: 1px solid #ddd;">Ø§Ù„Ù‚Ø³Ù…</th>
                                    <th style="padding: 8px; border: 1px solid #ddd;">Ø§Ù„ÙØµÙ„</th>
                                    <th style="padding: 8px; border: 1px solid #ddd;">Ø§Ù„Ù…Ø¹Ø¯Ù„</th>
                                    <th style="padding: 8px; border: 1px solid #ddd;">Ø§Ù„ØªÙ‚Ø¯ÙŠØ±</th>
                                    <th style="padding: 8px; border: 1px solid #ddd;">Ø§Ù„Ø­Ø§Ù„Ø©</th>
                                </tr>
                            </thead>
                            <tbody>
                `;

                studentsToPrint.forEach((student, index) => {
                    if (!student || !student.id || !student.subjects) {
                        console.warn('Skipping invalid student:', student);
                        return;
                    }

                    const blockedStudents = JSON.parse(localStorage.getItem('blockedStudents') || '[]');
                    const isBlocked = blockedStudents.some(b => b.studentId === student.id);

                    // Calculate GPA
                    let totalWeightedGrade = 0;
                    let totalUnits = 0;

                    if (Array.isArray(student.subjects)) {
                        student.subjects.forEach(subject => {
                            if (subject && typeof subject.total === 'number' && typeof subject.units === 'number') {
                                totalWeightedGrade += (subject.total * subject.units);
                                totalUnits += subject.units;
                            }
                        });
                    }

                    const semesterGPA = totalUnits > 0 ? (totalWeightedGrade / totalUnits).toFixed(2) : 0;
                    const evaluation = getEvaluation(parseFloat(semesterGPA));

                    pdfContent += `
                        <tr style="border-bottom: 1px solid #ddd;">
                            <td style="padding: 8px; border: 1px solid #ddd;">${index + 1}</td>
                            <td style="padding: 8px; border: 1px solid #ddd;">${student.id || ''}</td>
                            <td style="padding: 8px; border: 1px solid #ddd;">${student.name || ''}</td>
                            <td style="padding: 8px; border: 1px solid #ddd;">${student.department || ''}</td>
                            <td style="padding: 8px; border: 1px solid #ddd;">${student.semester || ''}</td>
                            <td style="padding: 8px; border: 1px solid #ddd;">${semesterGPA}</td>
                            <td style="padding: 8px; border: 1px solid #ddd;">${evaluation || ''}</td>
                            <td style="padding: 8px; border: 1px solid #ddd;">${isBlocked ? 'ğŸš« Ù…Ø­Ø¬ÙˆØ¨' : 'âœ… Ø·Ø¨ÙŠØ¹ÙŠ'}</td>
                        </tr>
                    `;
                });

                pdfContent += `
                            </tbody>
                        </table>
                        
                        <div style="margin-top: 20px; text-align: center; border-top: 2px solid #dee2e6; padding-top: 15px;">
                            <p style="font-size: 12px; font-weight: bold; color: #495057;">Ø§Ø¹ØªÙ…Ø§Ø¯ Ù…ÙƒØªØ¨ Ø§Ù„ØªØ³Ø¬ÙŠÙ„</p>
                            <div style="margin-top: 10px;">
                                <div style="border-bottom: 2px solid #000; width: 100px; margin: 0 auto 5px;"></div>
                            </div>
                        </div>
                    </div>
                `;

                // Open in new window for PDF printing
                const pdfWindow = window.open('', '_blank');
                pdfWindow.document.write(`
                    <!DOCTYPE html>
                    <html lang="ar" dir="rtl">
                    <head>
                        <meta charset="UTF-8">
                        <title>ÙƒØ´Ù Ù†ØªØ§Ø¦Ø¬ Ø§Ù„Ø·Ù„Ø§Ø¨ - PDF</title>
                        <style>
                            @media print {
                                body { -webkit-print-color-adjust: exact; }
                            }
                        </style>
                    </head>
                    <body>
                        ${pdfContent}
                        <div style="text-align: center; margin-top: 20px;">
                            <button onclick="window.print()" style="padding: 10px 20px; font-size: 14px;">ğŸ–¨ï¸ Ø·Ø¨Ø§Ø¹Ø© PDF</button>
                        </div>
                    </body>
                    </html>
                `);
                pdfWindow.document.close();

            } catch (error) {
                console.error('Error in exportToPDF:', error);
                alert('Ø­Ø¯Ø« Ø®Ø·Ø£ ÙÙŠ Ø§Ù„ØªØµØ¯ÙŠØ±: ' + error.message);
            }
        }

        // Print student result
        function printStudentResult() {
            const printContent = document.getElementById('studentResultDisplay').innerHTML;
            const originalContent = document.body.innerHTML;

            document.body.innerHTML = `
                <div style="direction: rtl; font-family: Arial, sans-serif; padding: 8px; height: 100vh; display: flex; flex-direction: column;">
                    <!-- Header with logo and semester -->
                    <div style="text-align: center; margin-bottom: 10px; border-bottom: 2px solid #007bff; padding-bottom: 8px;">
                        <div style="margin-bottom: 5px;">
                            <img src="LOGO.png" alt="Ø´Ø¹Ø§Ø± Ø§Ù„Ù…Ø¹Ù‡Ø¯" style="max-width: 60px; height: auto;">
                        </div>
                        <h1 style="margin: 0; font-size: 16px; color: #007bff; font-weight: bold;">Ø§Ù„Ù…Ø¹Ù‡Ø¯ Ø§Ù„Ø¹Ø§Ù„ÙŠ Ù„Ù„Ø¹Ù„ÙˆÙ… ÙˆØ§Ù„ØªÙ‚Ù†ÙŠØ© Ø§Ù„Ø¬ÙØ±Ø© Ø¨Ø³ÙˆÙƒÙ†Ø©</h1>
                        <p style="margin: 2px 0; font-size: 12px; color: #666;">${getCurrentAcademicSemester()}</p>
                        <h2 style="margin: 2px 0 0 0; font-size: 14px; color: #495057;">Ù†ØªÙŠØ¬Ø© Ø§Ù„Ø·Ø§Ù„Ø¨</h2>
                    </div>
                    
                    <!-- Student Result Content - FIT to page -->
                    <div style="flex: 1; overflow: hidden; display: flex; flex-direction: column;">
                        ${printContent.replace(/font-size: 18px/g, 'font-size: 11px').replace(/font-size: 24px/g, 'font-size: 14px').replace(/font-size: 20px/g, 'font-size: 12px').replace(/padding: 25px/g, 'padding: 5px').replace(/padding: 15px/g, 'padding: 5px').replace(/margin: 20px 0/g, 'margin: 3px 0').replace(/margin: 10px 0/g, 'margin: 3px 0').replace(/ğŸ–¨ï¸ Ø·Ø¨Ø§Ø¹Ø© Ø§Ù„Ù†ØªÙŠØ¬Ø©/g, '').replace(/<button[^>]*>ğŸ–¨ï¸ Ø·Ø¨Ø§Ø¹Ø© Ø§Ù„Ù†ØªÙŠØ¬Ø©<\/button>/g, '')}
                    </div>
                </div>
            `;

            window.print();
            document.body.innerHTML = originalContent;

            // Reload the page to restore functionality
            location.reload();
        }

        // Excel Functions - Updated for new system compatibility
        function exportToExcel() {
            // Get latest students data
            const students = JSON.parse(localStorage.getItem('students')) || [];

            if (students.length === 0) {
                showStatus('Ù„Ø§ ÙŠÙˆØ¬Ø¯ Ø·Ù„Ø§Ø¨ Ù„ØªØµØ¯ÙŠØ±Ù‡Ù…', 'error');
                return;
            }

            // Create workbook
            const wb = XLSX.utils.book_new();

            // Create comprehensive worksheet data
            const wsData = [
                ['Ø§Ù„Ø±Ù‚Ù… Ø§Ù„Ø¯Ø±Ø§Ø³ÙŠ', 'Ø§Ø³Ù… Ø§Ù„Ø·Ø§Ù„Ø¨', 'Ø§Ù„Ù‚Ø³Ù…', 'Ø§Ù„ÙØµÙ„', 'Ø§Ù„Ù…Ø§Ø¯Ø©', 'Ø§Ù„ÙˆØ­Ø¯Ø§Øª', 'Ø£Ø¹Ù…Ø§Ù„ Ø§Ù„ÙØµÙ„', 'Ø§Ù„Ø§Ø®ØªØ¨Ø§Ø± Ø§Ù„Ù†Ù‡Ø§Ø¦ÙŠ', 'Ø§Ù„Ù…Ø¬Ù…ÙˆØ¹', 'Ø§Ù„ØªÙ‚Ø¯ÙŠØ±', 'GPA', 'Ø§Ù„Ø­Ø§Ù„Ø©', 'ØªØ§Ø±ÙŠØ® Ø§Ù„Ø¥Ø¶Ø§ÙØ©']
            ];

            students.forEach(student => {
                if (!student.subjects || student.subjects.length === 0) return;

                // Calculate GPA and status for this student
                const gpa = calculateStudentGPA(student);
                const status = getStudentStatus(student);

                student.subjects.forEach(subject => {
                    wsData.push([
                        student.id || '',
                        student.name || '',
                        student.department || '',
                        student.semester || '',
                        subject.name || '',
                        subject.units || '',
                        subject.classWork || '',
                        subject.finalExam || '',
                        subject.total || '',
                        subject.evaluation || '',
                        gpa,
                        status,
                        student.addedDate || new Date().toLocaleString('ar-SA')
                    ]);
                });
            });

            // Create worksheet
            const ws = XLSX.utils.aoa_to_sheet(wsData);

            // Set column widths for better display
            ws['!cols'] = [
                { width: 15 }, // Ø§Ù„Ø±Ù‚Ù… Ø§Ù„Ø¯Ø±Ø§Ø³ÙŠ
                { width: 20 }, // Ø§Ø³Ù… Ø§Ù„Ø·Ø§Ù„Ø¨
                { width: 15 }, // Ø§Ù„Ù‚Ø³Ù…
                { width: 10 }, // Ø§Ù„ÙØµÙ„
                { width: 20 }, // Ø§Ù„Ù…Ø§Ø¯Ø©
                { width: 10 }, // Ø§Ù„ÙˆØ­Ø¯Ø§Øª
                { width: 12 }, // Ø£Ø¹Ù…Ø§Ù„ Ø§Ù„ÙØµÙ„
                { width: 15 }, // Ø§Ù„Ø§Ø®ØªØ¨Ø§Ø± Ø§Ù„Ù†Ù‡Ø§Ø¦ÙŠ
                { width: 10 }, // Ø§Ù„Ù…Ø¬Ù…ÙˆØ¹
                { width: 10 }, // Ø§Ù„ØªÙ‚Ø¯ÙŠØ±
                { width: 10 }, // GPA
                { width: 10 }, // Ø§Ù„Ø­Ø§Ù„Ø©
                { width: 20 }  // ØªØ§Ø±ÙŠØ® Ø§Ù„Ø¥Ø¶Ø§ÙØ©
            ];

            // Add worksheet to workbook
            XLSX.utils.book_append_sheet(wb, ws, 'Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ø·Ù„Ø§Ø¨');

            // Save file with timestamp
            const fileName = `students_export_${new Date().toISOString().split('T')[0]}.xlsx`;
            XLSX.writeFile(wb, fileName);

            showStatus(`ØªÙ… ØªØµØ¯ÙŠØ± Ø¨ÙŠØ§Ù†Ø§Øª ${students.length} Ø·Ø§Ù„Ø¨ Ø¥Ù„Ù‰ Excel Ø¨Ù†Ø¬Ø§Ø­`, 'success');
        }

        function getStudentStatus(student) {
            if (!student.subjects || student.subjects.length === 0) return 'ØºÙŠØ± Ù…Ø­Ø¯Ø¯';

            const failedSubjects = student.subjects.filter(s => s.total < 50).length;
            const gpa = parseFloat(calculateStudentGPA(student));

            return failedSubjects <= 2 && gpa >= 50 ? 'Ù…Ù†Ù‚ÙˆÙ„' : 'Ø±Ø§Ø³Ø¨';
        }

        function downloadTemplate() {
            // Create comprehensive template workbook
            const wb = XLSX.utils.book_new();

            // Create enhanced template data with all fields
            const templateData = [
                ['Ø§Ù„Ø±Ù‚Ù… Ø§Ù„Ø¯Ø±Ø§Ø³ÙŠ', 'Ø§Ø³Ù… Ø§Ù„Ø·Ø§Ù„Ø¨', 'Ø§Ù„Ù‚Ø³Ù…', 'Ø§Ù„ÙØµÙ„', 'Ø§Ù„Ù…Ø§Ø¯Ø©', 'Ø§Ù„ÙˆØ­Ø¯Ø§Øª', 'Ø£Ø¹Ù…Ø§Ù„ Ø§Ù„ÙØµÙ„', 'Ø§Ù„Ø§Ø®ØªØ¨Ø§Ø± Ø§Ù„Ù†Ù‡Ø§Ø¦ÙŠ', 'Ø§Ù„Ù…Ø¬Ù…ÙˆØ¹', 'Ø§Ù„ØªÙ‚Ø¯ÙŠØ±', 'GPA', 'Ø§Ù„Ø­Ø§Ù„Ø©', 'ØªØ§Ø±ÙŠØ® Ø§Ù„Ø¥Ø¶Ø§ÙØ©'],
                ['SE242001', 'Ø£Ø­Ù…Ø¯ Ù…Ø­Ù…Ø¯ Ø¹Ù„ÙŠ', 'Ø§Ù„Ù…Ø³Ø§Ø­Ø©', '1', 'Ø±ÙŠØ§Ø¶ÙŠØ§Øª Ù‡Ù†Ø¯Ø³ÙŠØ©', '3', '20', '30', '', '', '', '', ''],
                ['SE242001', 'Ø£Ø­Ù…Ø¯ Ù…Ø­Ù…Ø¯ Ø¹Ù„ÙŠ', 'Ø§Ù„Ù…Ø³Ø§Ø­Ø©', '1', 'ÙÙŠØ²ÙŠØ§Ø¡ Ù‡Ù†Ø¯Ø³ÙŠØ©', '3', '18', '32', '', '', '', '', ''],
                ['CO242002', 'Ù…Ø­Ù…Ø¯ Ø®Ø§Ù„Ø¯ Ø£Ø­Ù…Ø¯', 'Ø§Ù„Ø­Ø§Ø³ÙˆØ¨', '2', 'Ø¨Ø±Ù…Ø¬Ø© 1', '4', '22', '38', '', '', '', '', ''],
                ['CS242003', 'ÙØ§Ø·Ù…Ø© Ø³Ø§Ù„Ù… Ù…Ø­Ù…Ø¯', 'Ù‡Ù†Ø¯Ø³Ø© Ø§Ù„Ø¨Ø±Ù…Ø¬ÙŠØ§Øª', '1', 'Ù…Ø¨Ø§Ø¯Ø¦ Ø§Ù„Ø¨Ø±Ù…Ø¬Ø©', '3', '15', '25', '', '', '', '', '']
            ];

            // Create worksheet
            const ws = XLSX.utils.aoa_to_sheet(templateData);

            // Set column widths
            ws['!cols'] = [
                { width: 15 }, // Ø§Ù„Ø±Ù‚Ù… Ø§Ù„Ø¯Ø±Ø§Ø³ÙŠ
                { width: 20 }, // Ø§Ø³Ù… Ø§Ù„Ø·Ø§Ù„Ø¨
                { width: 15 }, // Ø§Ù„Ù‚Ø³Ù…
                { width: 10 }, // Ø§Ù„ÙØµÙ„
                { width: 20 }, // Ø§Ù„Ù…Ø§Ø¯Ø©
                { width: 10 }, // Ø§Ù„ÙˆØ­Ø¯Ø§Øª
                { width: 12 }, // Ø£Ø¹Ù…Ø§Ù„ Ø§Ù„ÙØµÙ„
                { width: 15 }, // Ø§Ù„Ø§Ø®ØªØ¨Ø§Ø± Ø§Ù„Ù†Ù‡Ø§Ø¦ÙŠ
                { width: 10 }, // Ø§Ù„Ù…Ø¬Ù…ÙˆØ¹
                { width: 10 }, // Ø§Ù„ØªÙ‚Ø¯ÙŠØ±
                { width: 10 }, // GPA
                { width: 10 }, // Ø§Ù„Ø­Ø§Ù„Ø©
                { width: 20 }  // ØªØ§Ø±ÙŠØ® Ø§Ù„Ø¥Ø¶Ø§ÙØ©
            ];

            // Add worksheet to workbook
            XLSX.utils.book_append_sheet(wb, ws, 'Ù‚Ø§Ù„Ø¨ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª');

            // Save file
            XLSX.writeFile(wb, 'students_comprehensive_template.xlsx');

            showStatus('ØªÙ… ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ù‚Ø§Ù„Ø¨ Ø§Ù„Ø´Ø§Ù…Ù„ Ø¨Ù†Ø¬Ø§Ø­', 'success');
        }

        function importFromExcel() {
            const fileInput = document.getElementById('excelFileInput');
            const file = fileInput.files[0];

            if (!file) {
                showStatus('Ø§Ù„Ø±Ø¬Ø§Ø¡ Ø§Ø®ØªÙŠØ§Ø± Ù…Ù„Ù Excel Ø£ÙˆÙ„Ø§Ù‹', 'error');
                return;
            }

            const reader = new FileReader();
            reader.onload = function (e) {
                try {
                    const data = new Uint8Array(e.target.result);
                    const workbook = XLSX.read(data, { type: 'array' });

                    // Get first worksheet
                    const sheetName = workbook.SheetNames[0];
                    const worksheet = workbook.Sheets[sheetName];

                    // Convert to JSON
                    const jsonData = XLSX.utils.sheet_to_json(worksheet, { header: 1 });

                    if (jsonData.length < 2) {
                        showStatus('Ù…Ù„Ù Excel ÙØ§Ø±Øº Ø£Ùˆ Ù„Ø§ ÙŠØ­ØªÙˆÙŠ Ø¹Ù„Ù‰ Ø¨ÙŠØ§Ù†Ø§Øª', 'error');
                        return;
                    }

                    // Process imported data with enhanced validation
                    let importedCount = 0;
                    let skippedCount = 0;
                    let errorCount = 0;
                    const errors = [];

                    // Get current students from localStorage
                    const currentStudents = JSON.parse(localStorage.getItem('students')) || [];

                    // Skip header row and process data
                    for (let i = 1; i < jsonData.length; i++) {
                        const row = jsonData[i];

                        if (row.length < 9) {
                            errorCount++;
                            errors.push(`ØµÙ ${i + 1}: Ø¨ÙŠØ§Ù†Ø§Øª Ù†Ø§Ù‚ØµØ©`);
                            continue;
                        }

                        const studentId = String(row[0] || '').trim();
                        const studentName = String(row[1] || '').trim();
                        const department = String(row[2] || '').trim();
                        const semester = String(row[3] || '').trim();
                        const subjectName = String(row[4] || '').trim();
                        const units = parseInt(row[5]) || 0;
                        const classWork = String(row[6] || '').trim();
                        const finalExam = String(row[7] || '').trim();
                        const total = String(row[8] || '').trim();
                        const evaluation = String(row[9] || '').trim();
                        const gpa = String(row[10] || '').trim();
                        const status = String(row[11] || '').trim();
                        const addedDate = String(row[12] || '').trim();

                        // Validate required fields
                        if (!studentId || !studentName || !department || !subjectName || units <= 0) {
                            errorCount++;
                            errors.push(`ØµÙ ${i + 1}: Ø¨ÙŠØ§Ù†Ø§Øª Ø£Ø³Ø§Ø³ÙŠØ© Ù…ÙÙ‚ÙˆØ¯Ø© (Ø§Ù„Ø±Ù‚Ù… Ø§Ù„Ø¯Ø±Ø§Ø³ÙŠØŒ Ø§Ù„Ø§Ø³Ù…ØŒ Ø§Ù„Ù‚Ø³Ù…ØŒ Ø§Ù„Ù…Ø§Ø¯Ø©ØŒ Ø§Ù„ÙˆØ­Ø¯Ø§Øª)`);
                            continue;
                        }

                        // Validate student ID format
                        if (!/^[A-Z]{2}\d{6}$/.test(studentId)) {
                            errorCount++;
                            errors.push(`ØµÙ ${i + 1}: Ø§Ù„Ø±Ù‚Ù… Ø§Ù„Ø¯Ø±Ø§Ø³ÙŠ ØºÙŠØ± ØµØ­ÙŠØ­ (ÙŠØ¬Ø¨ Ø£Ù† ÙŠÙƒÙˆÙ† Ù…Ø«Ù„: SE242001)`);
                            continue;
                        }

                        // Validate units range
                        if (units < 1 || units > 6) {
                            errorCount++;
                            errors.push(`ØµÙ ${i + 1}: Ø¹Ø¯Ø¯ Ø§Ù„ÙˆØ­Ø¯Ø§Øª ÙŠØ¬Ø¨ Ø£Ù† ÙŠÙƒÙˆÙ† Ø¨ÙŠÙ† 1 Ùˆ 6`);
                            continue;
                        }

                        try {
                            // Check if student exists
                            let student = currentStudents.find(s => s.id === studentId);

                            if (!student) {
                                // Create new student
                                student = {
                                    id: studentId,
                                    name: studentName,
                                    department: department,
                                    semester: semester || '1',
                                    subjects: [],
                                    addedDate: addedDate || new Date().toLocaleString('ar-SA')
                                };
                                currentStudents.push(student);
                            }

                            // Check if subject exists for this student
                            const existingSubject = student.subjects.find(s => s.name === subjectName);

                            if (!existingSubject) {
                                // Calculate total if not provided
                                let calculatedTotal = total;
                                if (!total || total === '') {
                                    const cw = parseFloat(classWork) || 0;
                                    const fe = parseFloat(finalExam) || 0;
                                    calculatedTotal = (cw + fe).toString();
                                }

                                // Calculate evaluation if not provided
                                let calculatedEvaluation = evaluation;
                                if (!evaluation || evaluation === '') {
                                    calculatedEvaluation = getEvaluation(parseFloat(calculatedTotal));
                                }

                                student.subjects.push({
                                    name: subjectName,
                                    units: units,
                                    classWork: classWork,
                                    finalExam: finalExam,
                                    total: calculatedTotal,
                                    evaluation: calculatedEvaluation
                                });
                                importedCount++;
                            } else {
                                skippedCount++;
                            }
                        } catch (error) {
                            errorCount++;
                            errors.push(`ØµÙ ${i + 1}: Ø®Ø·Ø£ ÙÙŠ Ù…Ø¹Ø§Ù„Ø¬Ø© Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª - ${error.message}`);
                        }
                    }

                    // Save to localStorage
                    localStorage.setItem('students', JSON.stringify(currentStudents));

                    // Sync to Firebase
                    syncToFirebase();

                    // Refresh global students variable
                    window.refreshStudents();

                    // Show detailed results
                    const resultsDiv = document.getElementById('importResults');
                    let resultsHTML = `
                        <div class="status-message success">
                            <h3>ğŸ“Š Ù†ØªØ§Ø¦Ø¬ Ø§Ù„Ø§Ø³ØªÙŠØ±Ø§Ø¯:</h3>
                            <p>âœ… ØªÙ… Ø§Ø³ØªÙŠØ±Ø§Ø¯ ${importedCount} Ù…ÙˆØ§Ø¯ Ø¨Ù†Ø¬Ø§Ø­</p>
                            <p>âš ï¸ ØªÙ… ØªØ®Ø·ÙŠ ${skippedCount} Ù…ÙˆØ§Ø¯ Ù…ÙƒØ±Ø±Ø©</p>
                            <p>âŒ Ø­Ø¯Ø« ${errorCount} Ø®Ø·Ø£</p>
                        </div>
                    `;

                    if (errors.length > 0) {
                        resultsHTML += `
                            <div class="status-message error" style="margin-top: 10px;">
                                <h4>ğŸ” ØªÙØ§ØµÙŠÙ„ Ø§Ù„Ø£Ø®Ø·Ø§Ø¡:</h4>
                                <ul style="max-height: 200px; overflow-y: auto; text-align: right;">
                                    ${errors.slice(0, 10).map(error => `<li>${error}</li>`).join('')}
                                    ${errors.length > 10 ? `<li>... Ùˆ ${errors.length - 10} Ø£Ø®Ø·Ø§Ø¡ Ø£Ø®Ø±Ù‰</li>` : ''}
                                </ul>
                            </div>
                        `;
                    }

                    resultsDiv.innerHTML = resultsHTML;

                    showStatus(`Ø§ÙƒØªÙ…Ù„ Ø§Ù„Ø§Ø³ØªÙŠØ±Ø§Ø¯: ${importedCount} Ù…ÙˆØ§Ø¯ØŒ ${skippedCount} Ù…ÙƒØ±Ø±Ø©ØŒ ${errorCount} Ø£Ø®Ø·Ø§Ø¡`,
                        errorCount > 0 ? 'warning' : 'success');

                } catch (error) {
                    showStatus('Ø®Ø·Ø£ ÙÙŠ Ù‚Ø±Ø§Ø¡Ø© Ù…Ù„Ù Excel: ' + error.message, 'error');
                }
            };

            reader.readAsArrayBuffer(file);
        }

        function exportStatisticsToExcel() {
            // Get latest students data
            const students = JSON.parse(localStorage.getItem('students')) || [];

            if (students.length === 0) {
                showStatus('Ù„Ø§ ÙŠÙˆØ¬Ø¯ Ø·Ù„Ø§Ø¨ Ù„ØªØµØ¯ÙŠØ± Ø¥Ø­ØµØ§Ø¦ÙŠØ§ØªÙ‡Ù…', 'error');
                return;
            }

            // Create workbook
            const wb = XLSX.utils.book_new();

            // Calculate statistics by department
            const departmentStats = {};
            let totalPassed = 0;
            let totalFailed = 0;
            let totalStudents = students.length;

            students.forEach(student => {
                const dept = student.department || 'ØºÙŠØ± Ù…Ø­Ø¯Ø¯';
                if (!departmentStats[dept]) {
                    departmentStats[dept] = {
                        total: 0,
                        passed: 0,
                        failed: 0,
                        avgGPA: 0,
                        totalGPA: 0,
                        subjects: 0,
                        passedSubjects: 0,
                        failedSubjects: 0
                    };
                }

                departmentStats[dept].total++;

                // Calculate student GPA
                const studentGPA = parseFloat(calculateStudentGPA(student));
                departmentStats[dept].totalGPA += studentGPA;

                // Check if student passed (new logic with "Ù…Ø·Ø§Ù„Ø¨" rule)
                const semesterStatus = calculateSemesterStatus(student);
                const isPassed = semesterStatus.passed;

                if (isPassed) {
                    departmentStats[dept].passed++;
                    totalPassed++;
                } else {
                    departmentStats[dept].failed++;
                    totalFailed++;
                }

                // Count subjects
                if (student.subjects) {
                    departmentStats[dept].subjects += student.subjects.length;
                    departmentStats[dept].passedSubjects += student.subjects.filter(s => s.total >= 50).length;
                    departmentStats[dept].failedSubjects += student.subjects.filter(s => s.total < 50).length;
                }
            });

            // Calculate averages
            Object.keys(departmentStats).forEach(dept => {
                if (departmentStats[dept].total > 0) {
                    departmentStats[dept].avgGPA = (departmentStats[dept].totalGPA / departmentStats[dept].total).toFixed(2);
                    departmentStats[dept].passRate = ((departmentStats[dept].passed / departmentStats[dept].total) * 100).toFixed(1) + '%';
                    departmentStats[dept].subjectPassRate = departmentStats[dept].subjects > 0 ?
                        ((departmentStats[dept].passedSubjects / departmentStats[dept].subjects) * 100).toFixed(1) + '%' : '0%';
                }
            });

            // Create statistics worksheet data
            const statsData = [
                ['Ø§Ù„Ù‚Ø³Ù…', 'Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø§Ù„Ø·Ù„Ø§Ø¨', 'Ø§Ù„Ù†Ø§Ø¬Ø­ÙˆÙ†', 'Ø§Ù„Ø±Ø§Ø³Ø¨ÙˆÙ†', 'Ù†Ø³Ø¨Ø© Ø§Ù„Ù†Ø¬Ø§Ø­', 'Ù…Ø¹Ø¯Ù„ GPA', 'Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø§Ù„Ù…ÙˆØ§Ø¯', 'Ø§Ù„Ù…ÙˆØ§Ø¯ Ø§Ù„Ù†Ø§Ø¬Ø­Ø©', 'Ø§Ù„Ù…ÙˆØ§Ø¯ Ø§Ù„Ø±Ø§Ø³Ø¨Ø©', 'Ù†Ø³Ø¨Ø© Ù†Ø¬Ø§Ø­ Ø§Ù„Ù…ÙˆØ§Ø¯']
            ];

            Object.keys(departmentStats).forEach(dept => {
                const stats = departmentStats[dept];
                statsData.push([
                    dept,
                    stats.total,
                    stats.passed,
                    stats.failed,
                    stats.passRate,
                    stats.avgGPA,
                    stats.subjects,
                    stats.passedSubjects,
                    stats.failedSubjects,
                    stats.subjectPassRate
                ]);
            });

            // Add totals row
            const overallAvgGPA = students.length > 0 ?
                (Object.values(departmentStats).reduce((sum, dept) => sum + dept.totalGPA, 0) / students.length).toFixed(2) : 0;
            const totalSubjects = Object.values(departmentStats).reduce((sum, dept) => sum + dept.subjects, 0);
            const totalPassedSubjects = Object.values(departmentStats).reduce((sum, dept) => sum + dept.passedSubjects, 0);
            const overallPassRate = totalStudents > 0 ? ((totalPassed / totalStudents) * 100).toFixed(1) + '%' : '0%';
            const overallSubjectPassRate = totalSubjects > 0 ? ((totalPassedSubjects / totalSubjects) * 100).toFixed(1) + '%' : '0%';

            statsData.push([
                'Ø§Ù„Ø¥Ø¬Ù…Ø§Ù„ÙŠ',
                totalStudents,
                totalPassed,
                totalFailed,
                overallPassRate,
                overallAvgGPA,
                totalSubjects,
                totalPassedSubjects,
                totalSubjects - totalPassedSubjects,
                overallSubjectPassRate
            ]);

            // Create worksheet
            const ws = XLSX.utils.aoa_to_sheet(statsData);

            // Set column widths
            ws['!cols'] = [
                { width: 20 }, // Ø§Ù„Ù‚Ø³Ù…
                { width: 15 }, // Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø§Ù„Ø·Ù„Ø§Ø¨
                { width: 12 }, // Ø§Ù„Ù†Ø§Ø¬Ø­ÙˆÙ†
                { width: 12 }, // Ø§Ù„Ø±Ø§Ø³Ø¨ÙˆÙ†
                { width: 15 }, // Ù†Ø³Ø¨Ø© Ø§Ù„Ù†Ø¬Ø§Ø­
                { width: 12 }, // Ù…Ø¹Ø¯Ù„ GPA
                { width: 15 }, // Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø§Ù„Ù…ÙˆØ§Ø¯
                { width: 15 }, // Ø§Ù„Ù…ÙˆØ§Ø¯ Ø§Ù„Ù†Ø§Ø¬Ø­Ø©
                { width: 15 }, // Ø§Ù„Ù…ÙˆØ§Ø¯ Ø§Ù„Ø±Ø§Ø³Ø¨Ø©
                { width: 18 }  // Ù†Ø³Ø¨Ø© Ù†Ø¬Ø§Ø­ Ø§Ù„Ù…ÙˆØ§Ø¯
            ];

            // Add worksheet to workbook
            XLSX.utils.book_append_sheet(wb, ws, 'Ø¥Ø­ØµØ§Ø¦ÙŠØ§Øª Ø§Ù„Ø£Ù‚Ø³Ø§Ù…');

            // Create detailed students worksheet
            const detailedData = [
                ['Ø§Ù„Ø±Ù‚Ù… Ø§Ù„Ø¯Ø±Ø§Ø³ÙŠ', 'Ø§Ø³Ù… Ø§Ù„Ø·Ø§Ù„Ø¨', 'Ø§Ù„Ù‚Ø³Ù…', 'Ø§Ù„ÙØµÙ„', 'GPA', 'Ø§Ù„Ø­Ø§Ù„Ø©', 'Ø¹Ø¯Ø¯ Ø§Ù„Ù…ÙˆØ§Ø¯', 'Ø§Ù„Ù…ÙˆØ§Ø¯ Ø§Ù„Ù†Ø§Ø¬Ø­Ø©', 'Ø§Ù„Ù…ÙˆØ§Ø¯ Ø§Ù„Ø±Ø§Ø³Ø¨Ø©', 'ØªØ§Ø±ÙŠØ® Ø§Ù„Ø¥Ø¶Ø§ÙØ©']
            ];

            students.forEach(student => {
                const gpa = calculateStudentGPA(student);
                const status = getStudentStatus(student);
                const passedSubjects = student.subjects ? student.subjects.filter(s => s.total >= 50).length : 0;
                const failedSubjects = student.subjects ? student.subjects.filter(s => s.total < 50).length : 0;

                detailedData.push([
                    student.id || '',
                    student.name || '',
                    student.department || '',
                    student.semester || '',
                    gpa,
                    status,
                    student.subjects ? student.subjects.length : 0,
                    passedSubjects,
                    failedSubjects,
                    student.addedDate || ''
                ]);
            });

            const ws2 = XLSX.utils.aoa_to_sheet(detailedData);
            ws2['!cols'] = [
                { width: 15 }, { width: 20 }, { width: 15 }, { width: 10 }, { width: 10 },
                { width: 10 }, { width: 12 }, { width: 15 }, { width: 15 }, { width: 20 }
            ];

            XLSX.utils.book_append_sheet(wb, ws2, 'ØªÙØ§ØµÙŠÙ„ Ø§Ù„Ø·Ù„Ø§Ø¨');

            // Save file
            const fileName = `students_statistics_${new Date().toISOString().split('T')[0]}.xlsx`;
            XLSX.writeFile(wb, fileName);

            showStatus(`ØªÙ… ØªØµØ¯ÙŠØ± Ø¥Ø­ØµØ§Ø¦ÙŠØ§Øª ${totalStudents} Ø·Ø§Ù„Ø¨ Ø¥Ù„Ù‰ Excel Ø¨Ù†Ø¬Ø§Ø­`, 'success');
        }

        // Show status message
        function showStatus(message, type = 'success') {
            // Remove existing status message if any
            const existingStatus = document.querySelector('.status-message');
            if (existingStatus) {
                existingStatus.remove();
            }

            // Create new status message
            const statusDiv = document.createElement('div');
            statusDiv.className = `status-message ${type}`;
            statusDiv.textContent = message;

            // Add to page
            document.body.appendChild(statusDiv);

            // Show message
            setTimeout(() => {
                statusDiv.classList.add('show');
            }, 100);

            // Hide message after 3 seconds
            setTimeout(() => {
                statusDiv.classList.remove('show');
                setTimeout(() => {
                    if (statusDiv.parentNode) {
                        statusDiv.parentNode.removeChild(statusDiv);
                    }
                }, 300);
            }, 3000);
        }

        // Show institute statistics with charts
        function showInstituteStatistics() {
            const students = JSON.parse(localStorage.getItem('students')) || [];

            if (students.length === 0) {
                showStatus('Ù„Ø§ ÙŠÙˆØ¬Ø¯ Ø·Ù„Ø§Ø¨ Ù„Ø¹Ø±Ø¶ Ø§Ù„Ø¥Ø­ØµØ§Ø¦ÙŠØ§Øª', 'error');
                return;
            }

            // Calculate statistics by department
            const departmentStats = {};
            let totalPassed = 0;
            let totalFailed = 0;
            let totalStudents = students.length;

            students.forEach(student => {
                const dept = student.department || 'ØºÙŠØ± Ù…Ø­Ø¯Ø¯';
                if (!departmentStats[dept]) {
                    departmentStats[dept] = {
                        total: 0,
                        passed: 0,
                        failed: 0,
                        avgGPA: 0,
                        totalGPA: 0
                    };
                }

                departmentStats[dept].total++;

                // Calculate student GPA
                const studentGPA = parseFloat(calculateStudentGPA(student));
                departmentStats[dept].totalGPA += studentGPA;

                // Check if student passed (new logic with "Ù…Ø·Ø§Ù„Ø¨" rule)
                const semesterStatus = calculateSemesterStatus(student);
                const isPassed = semesterStatus.passed;

                if (isPassed) {
                    departmentStats[dept].passed++;
                    totalPassed++;
                } else {
                    departmentStats[dept].failed++;
                    totalFailed++;
                }
            });

            // Calculate average GPA for each department
            Object.keys(departmentStats).forEach(dept => {
                if (departmentStats[dept].total > 0) {
                    departmentStats[dept].avgGPA = (departmentStats[dept].totalGPA / departmentStats[dept].total).toFixed(2);
                }
            });

            // Create modal
            const modal = document.createElement('div');
            modal.className = 'modal-overlay';
            modal.style.cssText = `
                position: fixed;
                top: 0;
                left: 0;
                width: 100%;
                height: 100%;
                background: rgba(0,0,0,0.5);
                display: flex;
                justify-content: center;
                align-items: center;
                z-index: 10000;
                direction: rtl;
            `;

            // Generate charts HTML
            let chartsHTML = '';

            // Overall statistics
            const passRate = ((totalPassed / totalStudents) * 100).toFixed(1);
            const failRate = ((totalFailed / totalStudents) * 100).toFixed(1);

            chartsHTML += `
                <div style="background: white; padding: 20px; border-radius: 10px; margin-bottom: 20px; box-shadow: 0 2px 10px rgba(0,0,0,0.1);">
                    <h3 style="color: #2c3e50; margin-bottom: 15px; text-align: center;">ğŸ“Š Ø¥Ø­ØµØ§Ø¦ÙŠØ§Øª Ø§Ù„Ù…Ø¹Ù‡Ø¯ Ø§Ù„Ø¥Ø¬Ù…Ø§Ù„ÙŠØ©</h3>
                    <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(150px, 1fr)); gap: 15px; margin-bottom: 20px;">
                        <div style="text-align: center; padding: 15px; background: #f8f9fa; border-radius: 8px;">
                            <div style="font-size: 24px; font-weight: bold; color: #007bff;">${totalStudents}</div>
                            <div style="color: #666; font-size: 14px;">Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø§Ù„Ø·Ù„Ø§Ø¨</div>
                        </div>
                        <div style="text-align: center; padding: 15px; background: #d4edda; border-radius: 8px;">
                            <div style="font-size: 24px; font-weight: bold; color: #28a745;">${totalPassed}</div>
                            <div style="color: #666; font-size: 14px;">Ù†Ø§Ø¬Ø­ÙˆÙ† (${passRate}%)</div>
                        </div>
                        <div style="text-align: center; padding: 15px; background: #f8d7da; border-radius: 8px;">
                            <div style="font-size: 24px; font-weight: bold; color: #dc3545;">${totalFailed}</div>
                            <div style="color: #666; font-size: 14px;">Ø±Ø§Ø³Ø¨ÙˆÙ† (${failRate}%)</div>
                        </div>
                    </div>
                    
                    <!-- Improved pie chart using SVG path -->
                    <div style="display: flex; justify-content: center; align-items: center; margin: 20px 0;">
                        <div style="position: relative; width: 200px; height: 200px;">
                            <svg width="200" height="200" viewBox="0 0 200 200">
                                <!-- Background circle -->
                                <circle cx="100" cy="100" r="80" fill="none" stroke="#e9ecef" stroke-width="2"/>
                                
                                <!-- Pass segment -->
                                <path d="M 100 100 L 100 20 A 80 80 0 ${passRate > 50 ? 1 : 0} 1 ${100 + (80 * Math.sin((passRate * 3.14159) / 100))} ${100 - (80 * Math.cos((passRate * 3.14159) / 100))} Z" 
                                      fill="#28a745" 
                                      stroke="white" 
                                      stroke-width="2"/>
                                
                                <!-- Fail segment -->
                                <path d="M 100 100 L ${100 + (80 * Math.sin((passRate * 3.14159) / 100))} ${100 - (80 * Math.cos((passRate * 3.14159) / 100))} A 80 80 0 ${passRate <= 50 ? 1 : 0} 1 100 20 Z" 
                                      fill="#dc3545" 
                                      stroke="white" 
                                      stroke-width="2"/>
                            </svg>
                            
                            <!-- Center text -->
                            <div style="position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%); text-align: center;">
                                <div style="font-size: 18px; font-weight: bold; color: #2c3e50;">${passRate}%</div>
                                <div style="font-size: 12px; color: #666;">Ù†Ø³Ø¨Ø© Ø§Ù„Ù†Ø¬Ø§Ø­</div>
                            </div>
                        </div>
                        
                        <!-- Legend -->
                        <div style="margin-right: 30px; text-align: right;">
                            <div style="display: flex; align-items: center; margin-bottom: 8px;">
                                <div style="width: 20px; height: 20px; background: #28a745; border-radius: 3px; margin-left: 8px;"></div>
                                <span style="font-size: 14px; color: #333;">Ù†Ø§Ø¬Ø­ÙˆÙ† (${totalPassed})</span>
                            </div>
                            <div style="display: flex; align-items: center;">
                                <div style="width: 20px; height: 20px; background: #dc3545; border-radius: 3px; margin-left: 8px;"></div>
                                <span style="font-size: 14px; color: #333;">Ø±Ø§Ø³Ø¨ÙˆÙ† (${totalFailed})</span>
                            </div>
                        </div>
                    </div>
                </div>
            `;

            // Department statistics
            chartsHTML += `
                <div style="background: white; padding: 20px; border-radius: 10px; margin-bottom: 20px; box-shadow: 0 2px 10px rgba(0,0,0,0.1);">
                    <h3 style="color: #2c3e50; margin-bottom: 15px; text-align: center;">ğŸ“ˆ Ø¥Ø­ØµØ§Ø¦ÙŠØ§Øª Ø­Ø³Ø¨ Ø§Ù„Ø£Ù‚Ø³Ø§Ù…</h3>
                    <div style="overflow-x: auto;">
                        <table style="width: 100%; border-collapse: collapse; margin: 10px 0;">
                            <thead>
                                <tr style="background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white;">
                                    <th style="padding: 12px; border: none; text-align: center;">Ø§Ù„Ù‚Ø³Ù…</th>
                                    <th style="padding: 12px; border: none; text-align: center;">Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø§Ù„Ø·Ù„Ø§Ø¨</th>
                                    <th style="padding: 12px; border: none; text-align: center;">Ù†Ø§Ø¬Ø­ÙˆÙ†</th>
                                    <th style="padding: 12px; border: none; text-align: center;">Ø±Ø§Ø³Ø¨ÙˆÙ†</th>
                                    <th style="padding: 12px; border: none; text-align: center;">Ù†Ø³Ø¨Ø© Ø§Ù„Ù†Ø¬Ø§Ø­</th>
                                    <th style="padding: 12px; border: none; text-align: center;">Ù…Ø¹Ø¯Ù„ GPA</th>
                                    <th style="padding: 12px; border: none; text-align: center;">Ø±Ø³Ù… Ø¨ÙŠØ§Ù†ÙŠ</th>
                                </tr>
                            </thead>
                            <tbody>
            `;

            Object.keys(departmentStats).forEach(dept => {
                const stats = departmentStats[dept];
                const deptPassRate = ((stats.passed / stats.total) * 100).toFixed(1);
                const barWidth = (stats.passed / stats.total) * 100;

                chartsHTML += `
                    <tr style="border-bottom: 1px solid #ddd;">
                        <td style="padding: 10px; border: none; text-align: center; font-weight: bold;">${dept}</td>
                        <td style="padding: 10px; border: none; text-align: center;">${stats.total}</td>
                        <td style="padding: 10px; border: none; text-align: center; color: #28a745; font-weight: bold;">${stats.passed}</td>
                        <td style="padding: 10px; border: none; text-align: center; color: #dc3545; font-weight: bold;">${stats.failed}</td>
                        <td style="padding: 10px; border: none; text-align: center; font-weight: bold;">${deptPassRate}%</td>
                        <td style="padding: 10px; border: none; text-align: center; font-weight: bold;">${stats.avgGPA}</td>
                        <td style="padding: 10px; border: none; text-align: center;">
                            <div style="width: 100px; height: 20px; background: #e9ecef; border-radius: 10px; overflow: hidden;">
                                <div style="width: ${barWidth}%; height: 100%; background: linear-gradient(90deg, #28a745, #20c997); transition: width 0.3s ease;"></div>
                            </div>
                        </td>
                    </tr>
                `;
            });

            chartsHTML += `
                            </tbody>
                        </table>
                    </div>
                </div>
            `;

            modal.innerHTML = `
                <div style="background: white; padding: 30px; border-radius: 15px; max-width: 900px; max-height: 90vh; overflow-y: auto; box-shadow: 0 10px 30px rgba(0,0,0,0.3);">
                    <div style="text-align: center; margin-bottom: 20px;">
                        <img src="LOGO.png" alt="Ø´Ø¹Ø§Ø± Ø§Ù„Ù…Ø¹Ù‡Ø¯" style="max-width: 80px; height: auto; margin-bottom: 10px;">
                        <h2 style="color: #2c3e50; margin: 0;">ğŸ“Š Ø¥Ø­ØµØ§Ø¦ÙŠØ§Øª Ø§Ù„Ù…Ø¹Ù‡Ø¯ Ø§Ù„Ø´Ø§Ù…Ù„Ø©</h2>
                        <p style="color: #666; margin: 5px 0;">${getCurrentAcademicSemester()}</p>
                    </div>
                    
                    ${chartsHTML}
                    
                    <div style="text-align: center; margin-top: 20px;">
                        <button onclick="console.log('Button clicked, function available:', typeof printInstituteStatistics); try { printInstituteStatistics(); } catch(e) { console.error('Print error:', e); alert('Ø®Ø·Ø£ ÙÙŠ Ø§Ù„Ø·Ø¨Ø§Ø¹Ø©: ' + e.message); }" 
                                style="background: linear-gradient(135deg, #007bff 0%, #0056b3 100%); color: white; border: none; padding: 12px 24px; border-radius: 8px; cursor: pointer; font-weight: bold; font-size: 16px; margin-left: 10px;">
                            ğŸ–¨ï¸ Ø·Ø¨Ø§Ø¹Ø© Ø§Ù„Ø¥Ø­ØµØ§Ø¦ÙŠØ§Øª
                        </button>
                        <button onclick="this.parentElement.parentElement.parentElement.remove()" 
                                style="background: linear-gradient(135deg, #dc2626 0%, #b91c1c 100%); color: white; border: none; padding: 12px 24px; border-radius: 8px; cursor: pointer; font-weight: bold; font-size: 16px;">
                            Ø¥ØºÙ„Ø§Ù‚
                        </button>
                    </div>
                </div>
            `;

            document.body.appendChild(modal);
        }

        // Print institute statistics
        function printInstituteStatistics() {
            const students = JSON.parse(localStorage.getItem('students')) || [];

            if (students.length === 0) {
                showStatus('Ù„Ø§ ÙŠÙˆØ¬Ø¯ Ø·Ù„Ø§Ø¨ Ù„Ø·Ø¨Ø§Ø¹Ø© Ø¥Ø­ØµØ§Ø¦ÙŠØ§ØªÙ‡Ù…', 'error');
                return;
            }

            // Calculate statistics by department
            const departmentStats = {};
            let totalPassed = 0;
            let totalFailed = 0;
            let totalStudents = students.length;

            students.forEach(student => {
                const dept = student.department || 'ØºÙŠØ± Ù…Ø­Ø¯Ø¯';
                if (!departmentStats[dept]) {
                    departmentStats[dept] = {
                        total: 0,
                        passed: 0,
                        failed: 0,
                        avgGPA: 0,
                        totalGPA: 0
                    };
                }

                departmentStats[dept].total++;

                // Calculate student GPA
                const studentGPA = parseFloat(calculateStudentGPA(student));
                departmentStats[dept].totalGPA += studentGPA;

                // Check if student passed (new logic with "Ù…Ø·Ø§Ù„Ø¨" rule)
                const semesterStatus = calculateSemesterStatus(student);
                const isPassed = semesterStatus.passed;

                if (isPassed) {
                    departmentStats[dept].passed++;
                    totalPassed++;
                } else {
                    departmentStats[dept].failed++;
                    totalFailed++;
                }
            });

            // Calculate average GPA for each department
            Object.keys(departmentStats).forEach(dept => {
                if (departmentStats[dept].total > 0) {
                    departmentStats[dept].avgGPA = (departmentStats[dept].totalGPA / departmentStats[dept].total).toFixed(2);
                }
            });

            const passRate = ((totalPassed / totalStudents) * 100).toFixed(1);
            const failRate = ((totalFailed / totalStudents) * 100).toFixed(1);

            // Generate print content
            const printContent = `
                <div style="direction: rtl; font-family: Arial, sans-serif; padding: 20px; height: 100vh; display: flex; flex-direction: column;">
                    <!-- Header -->
                    <div style="text-align: center; margin-bottom: 20px; border-bottom: 2px solid #007bff; padding-bottom: 15px;">
                        <div style="margin-bottom: 10px;">
                            <img src="LOGO.png" alt="Ø´Ø¹Ø§Ø± Ø§Ù„Ù…Ø¹Ù‡Ø¯" style="max-width: 80px; height: auto;">
                        </div>
                        <h1 style="margin: 0; font-size: 20px; color: #007bff; font-weight: bold;">Ø§Ù„Ù…Ø¹Ù‡Ø¯ Ø§Ù„Ø¹Ø§Ù„ÙŠ Ù„Ù„Ø¹Ù„ÙˆÙ… ÙˆØ§Ù„ØªÙ‚Ù†ÙŠØ© Ø§Ù„Ø¬ÙØ±Ø© Ø¨Ø³ÙˆÙƒÙ†Ø©</h1>
                        <p style="margin: 5px 0; font-size: 14px; color: #666;">${getCurrentAcademicSemester()}</p>
                        <h2 style="margin: 10px 0 0 0; font-size: 18px; color: #2c3e50;">Ø¥Ø­ØµØ§Ø¦ÙŠØ§Øª Ø§Ù„Ù…Ø¹Ù‡Ø¯ Ø§Ù„Ø´Ø§Ù…Ù„Ø©</h2>
                    </div>
                    
                    <!-- Overall Statistics -->
                    <div style="background: #f8f9fa; padding: 15px; border-radius: 8px; margin-bottom: 20px;">
                        <h3 style="color: #2c3e50; margin-bottom: 15px; text-align: center;">ğŸ“Š Ø§Ù„Ø¥Ø­ØµØ§Ø¦ÙŠØ§Øª Ø§Ù„Ø¥Ø¬Ù…Ø§Ù„ÙŠØ©</h3>
                        <div style="display: grid; grid-template-columns: repeat(3, 1fr); gap: 15px; margin-bottom: 20px;">
                            <div style="text-align: center; padding: 10px; background: white; border-radius: 5px; border: 1px solid #ddd;">
                                <div style="font-size: 18px; font-weight: bold; color: #007bff;">${totalStudents}</div>
                                <div style="color: #666; font-size: 12px;">Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø§Ù„Ø·Ù„Ø§Ø¨</div>
                            </div>
                            <div style="text-align: center; padding: 10px; background: #d4edda; border-radius: 5px; border: 1px solid #c3e6cb;">
                                <div style="font-size: 18px; font-weight: bold; color: #28a745;">${totalPassed}</div>
                                <div style="color: #666; font-size: 12px;">Ù†Ø§Ø¬Ø­ÙˆÙ† (${passRate}%)</div>
                            </div>
                            <div style="text-align: center; padding: 10px; background: #f8d7da; border-radius: 5px; border: 1px solid #f5c6cb;">
                                <div style="font-size: 18px; font-weight: bold; color: #dc3545;">${totalFailed}</div>
                                <div style="color: #666; font-size: 12px;">Ø±Ø§Ø³Ø¨ÙˆÙ† (${failRate}%)</div>
                            </div>
                        </div>
                    </div>
                    
                    <!-- Department Statistics -->
                    <div style="background: #f8f9fa; padding: 15px; border-radius: 8px; flex: 1;">
                        <h3 style="color: #2c3e50; margin-bottom: 15px; text-align: center;">ğŸ“ˆ Ø¥Ø­ØµØ§Ø¦ÙŠØ§Øª Ø­Ø³Ø¨ Ø§Ù„Ø£Ù‚Ø³Ø§Ù…</h3>
                        <table style="width: 100%; border-collapse: collapse; margin: 10px 0; font-size: 12px;">
                            <thead>
                                <tr style="background: #007bff; color: white;">
                                    <th style="padding: 8px; border: 1px solid #ddd; text-align: center;">Ø§Ù„Ù‚Ø³Ù…</th>
                                    <th style="padding: 8px; border: 1px solid #ddd; text-align: center;">Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø§Ù„Ø·Ù„Ø§Ø¨</th>
                                    <th style="padding: 8px; border: 1px solid #ddd; text-align: center;">Ù†Ø§Ø¬Ø­ÙˆÙ†</th>
                                    <th style="padding: 8px; border: 1px solid #ddd; text-align: center;">Ø±Ø§Ø³Ø¨ÙˆÙ†</th>
                                    <th style="padding: 8px; border: 1px solid #ddd; text-align: center;">Ù†Ø³Ø¨Ø© Ø§Ù„Ù†Ø¬Ø§Ø­</th>
                                    <th style="padding: 8px; border: 1px solid #ddd; text-align: center;">Ù…Ø¹Ø¯Ù„ GPA</th>
                                </tr>
                            </thead>
                            <tbody>
            `;

            Object.keys(departmentStats).forEach(dept => {
                const stats = departmentStats[dept];
                const deptPassRate = ((stats.passed / stats.total) * 100).toFixed(1);

                printContent += `
                    <tr style="border-bottom: 1px solid #ddd;">
                        <td style="padding: 8px; border: 1px solid #ddd; text-align: center; font-weight: bold;">${dept}</td>
                        <td style="padding: 8px; border: 1px solid #ddd; text-align: center;">${stats.total}</td>
                        <td style="padding: 8px; border: 1px solid #ddd; text-align: center; color: #28a745; font-weight: bold;">${stats.passed}</td>
                        <td style="padding: 8px; border: 1px solid #ddd; text-align: center; color: #dc3545; font-weight: bold;">${stats.failed}</td>
                        <td style="padding: 8px; border: 1px solid #ddd; text-align: center; font-weight: bold;">${deptPassRate}%</td>
                        <td style="padding: 8px; border: 1px solid #ddd; text-align: center; font-weight: bold;">${stats.avgGPA}</td>
                    </tr>
                `;
            });

            printContent += `
                            </tbody>
                        </table>
                    </div>
                    
                    <!-- Footer -->
                    <div style="text-align: center; margin-top: 20px; padding-top: 15px; border-top: 1px solid #ddd;">
                        <p style="margin: 0; font-size: 12px; color: #666;">ØªÙ… Ø§Ù„Ø·Ø¨Ø§Ø¹Ø© ÙÙŠ ${new Date().toLocaleString('ar-EG')}</p>
                    </div>
                </div>
            `;

            // Print the content
            const originalContent = document.body.innerHTML;
            document.body.innerHTML = printContent;
            window.print();
            document.body.innerHTML = originalContent;

            // Reload the page to restore functionality
            location.reload();
        }

        // Department Management Functions
        function addNewDepartment() {
            const nameInput = document.getElementById('newDepartmentName');
            const codeInput = document.getElementById('newDepartmentCode');

            const name = nameInput.value.trim();
            const code = codeInput.value.trim().toUpperCase();

            if (!name || !code) {
                showStatus('ÙŠØ±Ø¬Ù‰ Ø¥Ø¯Ø®Ø§Ù„ Ø§Ø³Ù… Ø§Ù„Ù‚Ø³Ù… ÙˆØ§Ù„Ø±Ù…Ø²', 'error');
                return;
            }

            if (code.length < 2 || code.length > 5) {
                showStatus('Ø±Ù…Ø² Ø§Ù„Ù‚Ø³Ù… ÙŠØ¬Ø¨ Ø£Ù† ÙŠÙƒÙˆÙ† Ø¨ÙŠÙ† 2 Ùˆ 5 Ø£Ø­Ø±Ù', 'error');
                return;
            }

            // Get existing departments
            let departments = JSON.parse(localStorage.getItem('departments')) || [];

            // Check if department code already exists
            if (departments.find(dept => dept.code === code)) {
                showStatus('Ø±Ù…Ø² Ø§Ù„Ù‚Ø³Ù… Ù‡Ø°Ø§ Ù…ÙˆØ¬ÙˆØ¯ Ø¨Ø§Ù„ÙØ¹Ù„', 'error');
                return;
            }

            // Check if department name already exists
            if (departments.find(dept => dept.name === name)) {
                showStatus('Ø§Ø³Ù… Ø§Ù„Ù‚Ø³Ù… Ù‡Ø°Ø§ Ù…ÙˆØ¬ÙˆØ¯ Ø¨Ø§Ù„ÙØ¹Ù„', 'error');
                return;
            }

            // Add new department
            const newDepartment = {
                id: Date.now().toString(),
                name: name,
                code: code,
                createdAt: new Date().toISOString()
            };

            departments.push(newDepartment);
            localStorage.setItem('departments', JSON.stringify(departments));

            // Clear inputs
            nameInput.value = '';
            codeInput.value = '';

            // Refresh departments list
            displayDepartments();

            showStatus(`ØªÙ… Ø¥Ø¶Ø§ÙØ© Ø§Ù„Ù‚Ø³Ù… "${name}" Ø¨Ù†Ø¬Ø§Ø­`, 'success');
        }

        function displayDepartments() {
            const departments = JSON.parse(localStorage.getItem('departments')) || [];
            const container = document.getElementById('departmentsContainer');

            if (departments.length === 0) {
                container.innerHTML = '<p style="color: #666; text-align: center;">Ù„Ø§ ØªÙˆØ¬Ø¯ Ø£Ù‚Ø³Ø§Ù… Ù…Ø¶Ø§ÙØ© Ø¨Ø¹Ø¯</p>';
                return;
            }

            let html = '<div style="display: grid; gap: 10px;">';

            departments.forEach(dept => {
                html += `
                    <div style="background: white; padding: 12px; border-radius: 8px; border: 1px solid #ddd; display: flex; justify-content: space-between; align-items: center;">
                        <div>
                            <strong style="color: #2c3e50;">${dept.name}</strong>
                            <span style="background: #007bff; color: white; padding: 4px 8px; border-radius: 4px; font-size: 12px; margin-right: 8px;">${dept.code}</span>
                        </div>
                        <button onclick="deleteDepartment('${dept.id}')" style="background: #dc3545; color: white; border: none; padding: 6px 12px; border-radius: 4px; cursor: pointer; font-size: 12px;">
                            ğŸ—‘ï¸ Ø­Ø°Ù
                        </button>
                    </div>
                `;
            });

            html += '</div>';
            container.innerHTML = html;
        }

        function deleteDepartment(deptId) {
            if (!confirm('Ù‡Ù„ Ø£Ù†Øª Ù…ØªØ£ÙƒØ¯ Ù…Ù† Ø­Ø°Ù Ù‡Ø°Ø§ Ø§Ù„Ù‚Ø³Ù…ØŸ')) {
                return;
            }

            let departments = JSON.parse(localStorage.getItem('departments')) || [];
            departments = departments.filter(dept => dept.id !== deptId);
            localStorage.setItem('departments', JSON.stringify(departments));

            displayDepartments();
            showStatus('ØªÙ… Ø­Ø°Ù Ø§Ù„Ù‚Ø³Ù… Ø¨Ù†Ø¬Ø§Ø­', 'success');
        }

        function getDepartmentName(code) {
            const departments = JSON.parse(localStorage.getItem('departments')) || [];
            const dept = departments.find(d => d.code === code);
            return dept ? dept.name : code;
        }

        // Initialize
        document.addEventListener('DOMContentLoaded', function () {
            // Auto-focus on username field
            document.getElementById('username').focus();

            // Load settings
            loadSettings();

            // Load custom subjects
            loadCustomSubjects();

            // Load departments
            displayDepartments();

            // Update department select with custom departments
            updateDepartmentSelect();

            // Load initial subjects if department is selected
            const department = document.getElementById('department').value;
            if (department) {
                loadDepartmentSubjectsForGrid();
            }

            // Add event listener for student ID input
            document.getElementById('studentId').addEventListener('input', function () {
                if (this.value.length >= 7) {
                    autoLoadSubjectsFromId();
                }
            });
        });
    </script>

    <!-- Global Print Statistics Function -->
    <script>
        function printInstituteStatistics() {
            const students = JSON.parse(localStorage.getItem('students')) || [];

            if (students.length === 0) {
                alert('Ù„Ø§ ÙŠÙˆØ¬Ø¯ Ø·Ù„Ø§Ø¨ Ù„Ø·Ø¨Ø§Ø¹Ø© Ø¥Ø­ØµØ§Ø¦ÙŠØ§ØªÙ‡Ù…');
                return;
            }

            // Calculate statistics by department
            const departmentStats = {};
            let totalPassed = 0;
            let totalFailed = 0;
            let totalStudents = students.length;

            students.forEach(student => {
                const dept = student.department || 'ØºÙŠØ± Ù…Ø­Ø¯Ø¯';
                if (!departmentStats[dept]) {
                    departmentStats[dept] = {
                        total: 0,
                        passed: 0,
                        failed: 0,
                        avgGPA: 0,
                        totalGPA: 0
                    };
                }

                departmentStats[dept].total++;

                // Calculate student GPA
                let totalUnits = 0;
                let totalWeightedGrade = 0;

                if (student.subjects) {
                    student.subjects.forEach(subject => {
                        if (subject && typeof subject.total === 'number' && typeof subject.units === 'number') {
                            totalUnits += subject.units;
                            totalWeightedGrade += (subject.total * subject.units);
                        }
                    });
                }

                const studentGPA = totalUnits > 0 ? (totalWeightedGrade / totalUnits).toFixed(2) : 0;
                departmentStats[dept].totalGPA += parseFloat(studentGPA);

                // Check if student passed (new logic with "Ù…Ø·Ø§Ù„Ø¨" rule)
                const semesterStatus = calculateSemesterStatus(student);
                const isPassed = semesterStatus.passed;

                if (isPassed) {
                    departmentStats[dept].passed++;
                    totalPassed++;
                } else {
                    departmentStats[dept].failed++;
                    totalFailed++;
                }
            });

            // Calculate average GPA for each department
            Object.keys(departmentStats).forEach(dept => {
                if (departmentStats[dept].total > 0) {
                    departmentStats[dept].avgGPA = (departmentStats[dept].totalGPA / departmentStats[dept].total).toFixed(2);
                }
            });

            const passRate = ((totalPassed / totalStudents) * 100).toFixed(1);
            const failRate = ((totalFailed / totalStudents) * 100).toFixed(1);

            // Get current academic semester
            const currentSemester = localStorage.getItem('currentAcademicSemester') || 'Ø§Ù„ÙØµÙ„ Ø§Ù„Ø¯Ø±Ø§Ø³ÙŠ Ø§Ù„Ø­Ø§Ù„ÙŠ';

            // Generate print content
            let printContent = `
                <div style="direction: rtl; font-family: Arial, sans-serif; padding: 20px; height: 100vh; display: flex; flex-direction: column;">
                    <!-- Header -->
                    <div style="text-align: center; margin-bottom: 20px; border-bottom: 2px solid #007bff; padding-bottom: 15px;">
                        <div style="margin-bottom: 10px;">
                            <img src="LOGO.png" alt="Ø´Ø¹Ø§Ø± Ø§Ù„Ù…Ø¹Ù‡Ø¯" style="max-width: 80px; height: auto;">
                        </div>
                        <h1 style="margin: 0; font-size: 20px; color: #007bff; font-weight: bold;">Ø§Ù„Ù…Ø¹Ù‡Ø¯ Ø§Ù„Ø¹Ø§Ù„ÙŠ Ù„Ù„Ø¹Ù„ÙˆÙ… ÙˆØ§Ù„ØªÙ‚Ù†ÙŠØ© Ø§Ù„Ø¬ÙØ±Ø© Ø¨Ø³ÙˆÙƒÙ†Ø©</h1>
                        <p style="margin: 5px 0; font-size: 14px; color: #666;">${currentSemester}</p>
                        <h2 style="margin: 10px 0 0 0; font-size: 18px; color: #2c3e50;">Ø¥Ø­ØµØ§Ø¦ÙŠØ§Øª Ø§Ù„Ù…Ø¹Ù‡Ø¯ Ø§Ù„Ø´Ø§Ù…Ù„Ø©</h2>
                    </div>
                    
                    <!-- Overall Statistics -->
                    <div style="background: #f8f9fa; padding: 15px; border-radius: 8px; margin-bottom: 20px;">
                        <h3 style="color: #2c3e50; margin-bottom: 15px; text-align: center;">ğŸ“Š Ø§Ù„Ø¥Ø­ØµØ§Ø¦ÙŠØ§Øª Ø§Ù„Ø¥Ø¬Ù…Ø§Ù„ÙŠØ©</h3>
                        <div style="display: grid; grid-template-columns: repeat(3, 1fr); gap: 15px; margin-bottom: 20px;">
                            <div style="text-align: center; padding: 10px; background: white; border-radius: 5px; border: 1px solid #ddd;">
                                <div style="font-size: 18px; font-weight: bold; color: #007bff;">${totalStudents}</div>
                                <div style="color: #666; font-size: 12px;">Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø§Ù„Ø·Ù„Ø§Ø¨</div>
                            </div>
                            <div style="text-align: center; padding: 10px; background: #d4edda; border-radius: 5px; border: 1px solid #c3e6cb;">
                                <div style="font-size: 18px; font-weight: bold; color: #28a745;">${totalPassed}</div>
                                <div style="color: #666; font-size: 12px;">Ù†Ø§Ø¬Ø­ÙˆÙ† (${passRate}%)</div>
                            </div>
                            <div style="text-align: center; padding: 10px; background: #f8d7da; border-radius: 5px; border: 1px solid #f5c6cb;">
                                <div style="font-size: 18px; font-weight: bold; color: #dc3545;">${totalFailed}</div>
                                <div style="color: #666; font-size: 12px;">Ø±Ø§Ø³Ø¨ÙˆÙ† (${failRate}%)</div>
                            </div>
                        </div>
                    </div>
                    
                    <!-- Department Statistics -->
                    <div style="background: #f8f9fa; padding: 15px; border-radius: 8px; flex: 1;">
                        <h3 style="color: #2c3e50; margin-bottom: 15px; text-align: center;">ğŸ“ˆ Ø¥Ø­ØµØ§Ø¦ÙŠØ§Øª Ø­Ø³Ø¨ Ø§Ù„Ø£Ù‚Ø³Ø§Ù…</h3>
                        <table style="width: 100%; border-collapse: collapse; margin: 10px 0; font-size: 12px;">
                            <thead>
                                <tr style="background: #007bff; color: white;">
                                    <th style="padding: 8px; border: 1px solid #ddd; text-align: center;">Ø§Ù„Ù‚Ø³Ù…</th>
                                    <th style="padding: 8px; border: 1px solid #ddd; text-align: center;">Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø§Ù„Ø·Ù„Ø§Ø¨</th>
                                    <th style="padding: 8px; border: 1px solid #ddd; text-align: center;">Ù†Ø§Ø¬Ø­ÙˆÙ†</th>
                                    <th style="padding: 8px; border: 1px solid #ddd; text-align: center;">Ø±Ø§Ø³Ø¨ÙˆÙ†</th>
                                    <th style="padding: 8px; border: 1px solid #ddd; text-align: center;">Ù†Ø³Ø¨Ø© Ø§Ù„Ù†Ø¬Ø§Ø­</th>
                                    <th style="padding: 8px; border: 1px solid #ddd; text-align: center;">Ù…Ø¹Ø¯Ù„ GPA</th>
                                </tr>
                            </thead>
                            <tbody>
            `;

            Object.keys(departmentStats).forEach(dept => {
                const stats = departmentStats[dept];
                const deptPassRate = ((stats.passed / stats.total) * 100).toFixed(1);

                printContent += `
                    <tr style="border-bottom: 1px solid #ddd;">
                        <td style="padding: 8px; border: 1px solid #ddd; text-align: center; font-weight: bold;">${dept}</td>
                        <td style="padding: 8px; border: 1px solid #ddd; text-align: center;">${stats.total}</td>
                        <td style="padding: 8px; border: 1px solid #ddd; text-align: center; color: #28a745; font-weight: bold;">${stats.passed}</td>
                        <td style="padding: 8px; border: 1px solid #ddd; text-align: center; color: #dc3545; font-weight: bold;">${stats.failed}</td>
                        <td style="padding: 8px; border: 1px solid #ddd; text-align: center; font-weight: bold;">${deptPassRate}%</td>
                        <td style="padding: 8px; border: 1px solid #ddd; text-align: center; font-weight: bold;">${stats.avgGPA}</td>
                    </tr>
                `;
            });

            printContent += `
                            </tbody>
                        </table>
                    </div>
                    
                    <!-- Footer -->
                    <div style="text-align: center; margin-top: 20px; padding-top: 15px; border-top: 1px solid #ddd;">
                        <p style="margin: 0; font-size: 12px; color: #666;">ØªÙ… Ø§Ù„Ø·Ø¨Ø§Ø¹Ø© ÙÙŠ ${new Date().toLocaleString('ar-EG')}</p>
                    </div>
                </div>
            `;

            // Print the content
            const originalContent = document.body.innerHTML;
            document.body.innerHTML = printContent;
            window.print();
            document.body.innerHTML = originalContent;

            // Reload the page to restore functionality
            location.reload();
        }

        // Make function globally available with multiple methods
        window.printInstituteStatistics = printInstituteStatistics;
        globalThis.printInstituteStatistics = printInstituteStatistics;

        // Debug: Log that function is available globally
        console.log('printInstituteStatistics function is now available globally');

        // Initialize on page load
        window.onload = function () {
            // Initializing - Hide everything by default via CSS logic in <style>
            // but just in case, ensure no flicker here
            const loginScr = document.getElementById('loginScreen');
            const mainApp = document.getElementById('mainApp');
            const studentView = document.getElementById('studentView');

            users = JSON.parse(localStorage.getItem('users')) || [];

            // Create default admin user
            if (users.length === 0) {
                const defaultAdmin = {
                    id: 'admin_default',
                    name: 'Ø§Ù„Ù…Ø¯ÙŠØ±',
                    email: 'admin@institute.edu',
                    password: btoa('admin123'),
                    role: 'admin',
                    status: 'active',
                    permissions: { admin: true, edit_students: true, delete_students: true, export_excel: true, import_excel: true, manage_departments: true, manage_users: true, view_statistics: true },
                    createdDate: new Date().toLocaleString('ar-SA'),
                    lastLogin: null,
                    createdBy: 'System'
                };
                users.push(defaultAdmin);
                localStorage.setItem('users', JSON.stringify(users));

                // Show hint for default login
                const hintEl = document.getElementById('defaultLoginHint');
                if (hintEl) {
                    hintEl.style.display = 'block';
                    // Auto-fill for convenience
                    document.getElementById('username').value = 'admin@institute.edu';
                    document.getElementById('password').value = 'admin123';
                }
            }

            // Load clinical data
            loadAllStudents();
            updateStatistics();
            displayDepartments();
            loadRequiredSubjectRule();

            // Session check
            const savedUser = sessionStorage.getItem('currentUser');
            if (savedUser) {
                currentUser = JSON.parse(savedUser);

                if (currentUser.type === 'student') {
                    showStudentView(currentUser.studentData);
                    loginScr.style.display = 'none';
                    return; // Done
                } else if (currentUser.id) {
                    const activeUser = users.find(u => u.id === currentUser.id && u.status === 'active');
                    if (activeUser) {
                        mainApp.style.display = 'block';
                        loginScr.style.display = 'none';
                        applyUserPermissions(activeUser);
                        return; // Done
                    }
                }
            }

            // For transition: Check if old localStorage exists and clear it to force new login
            if (localStorage.getItem('currentUser')) {
                localStorage.removeItem('currentUser');
            }

            // If we reach here, show login
            loginScr.style.display = 'flex';
        };

        // Export Students as JSON
        async function exportStudentsJSON() {
            try {
                if (typeof downloadDataAsJSON === 'function') {
                    const success = await downloadDataAsJSON();
                    if (success) {
                        showStatus('âœ… ØªÙ… ØªØµØ¯ÙŠØ± Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ø¨Ù†Ø¬Ø§Ø­! ÙŠÙ…ÙƒÙ†Ùƒ Ø§Ù„Ø¢Ù† Ù†Ù‚Ù„ Ø§Ù„Ù…Ù„Ù Ù„Ø£ÙŠ Ø¬Ù‡Ø§Ø² Ø¢Ø®Ø±', 'success');
                    }
                } else {
                    // Fallback to manual export
                    const students = JSON.parse(localStorage.getItem('students')) || [];
                    const exportData = {
                        version: '1.0',
                        exportDate: new Date().toISOString(),
                        data: {
                            students: students,
                            blockedStudents: JSON.parse(localStorage.getItem('blockedStudents') || '[]'),
                            departments: JSON.parse(localStorage.getItem('departments') || '[]'),
                            customSubjects: JSON.parse(localStorage.getItem('customSubjects') || '{}')
                        }
                    };

                    const jsonString = JSON.stringify(exportData, null, 2);
                    const blob = new Blob([jsonString], { type: 'application/json' });
                    const url = URL.createObjectURL(blob);

                    const a = document.createElement('a');
                    a.href = url;
                    a.download = `histjs-backup-${new Date().toISOString().split('T')[0]}.json`;
                    document.body.appendChild(a);
                    a.click();
                    document.body.removeChild(a);
                    URL.revokeObjectURL(url);

                    showStatus('âœ… ØªÙ… ØªØµØ¯ÙŠØ± Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ø¨Ù†Ø¬Ø§Ø­!', 'success');
                }
            } catch (error) {
                console.error('âŒ Error exporting data:', error);
                showStatus('âŒ Ø­Ø¯Ø« Ø®Ø·Ø£ Ø£Ø«Ù†Ø§Ø¡ ØªØµØ¯ÙŠØ± Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª', 'error');
            }
        }

        // Import Students from JSON
        async function importStudentsJSON() {
            try {
                const input = document.createElement('input');
                input.type = 'file';
                input.accept = '.json';

                input.onchange = async (e) => {
                    try {
                        const file = e.target.files[0];
                        if (!file) return;

                        const reader = new FileReader();
                        reader.onload = async (event) => {
                            try {
                                const jsonData = JSON.parse(event.target.result);

                                // Import using helper if available
                                if (typeof importData === 'function') {
                                    await importData(jsonData);
                                } else {
                                    // Manual import
                                    if (jsonData.data && jsonData.data.students) {
                                        localStorage.setItem('students', JSON.stringify(jsonData.data.students));

                                        if (jsonData.data.blockedStudents) {
                                            localStorage.setItem('blockedStudents', JSON.stringify(jsonData.data.blockedStudents));
                                        }
                                        if (jsonData.data.departments) {
                                            localStorage.setItem('departments', JSON.stringify(jsonData.data.departments));
                                        }
                                        if (jsonData.data.customSubjects) {
                                            localStorage.setItem('customSubjects', JSON.stringify(jsonData.data.customSubjects));
                                        }
                                    }
                                }

                                // Sync to Firebase
                                syncToFirebase();

                                // Reload everything
                                location.reload();

                                showStatus('âœ… ØªÙ… Ø§Ø³ØªÙŠØ±Ø§Ø¯ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ø¨Ù†Ø¬Ø§Ø­!', 'success');
                            } catch (error) {
                                console.error('âŒ Error parsing JSON:', error);
                                showStatus('âŒ Ø®Ø·Ø£ ÙÙŠ ØªÙ†Ø³ÙŠÙ‚ Ø§Ù„Ù…Ù„Ù. ÙŠØ±Ø¬Ù‰ Ø§Ø®ØªÙŠØ§Ø± Ù…Ù„Ù JSON ØµØ­ÙŠØ­', 'error');
                            }
                        };
                        reader.readAsText(file);
                    } catch (error) {
                        console.error('âŒ Error reading file:', error);
                        showStatus('âŒ Ø­Ø¯Ø« Ø®Ø·Ø£ Ø£Ø«Ù†Ø§Ø¡ Ù‚Ø±Ø§Ø¡Ø© Ø§Ù„Ù…Ù„Ù', 'error');
                    }
                };

                input.click();
            } catch (error) {
                console.error('âŒ Error importing data:', error);
                showStatus('âŒ Ø­Ø¯Ø« Ø®Ø·Ø£ Ø£Ø«Ù†Ø§Ø¡ Ø§Ø³ØªÙŠØ±Ø§Ø¯ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª', 'error');
            }
        }

        // Generate and download students-data.js for web deployment
        function downloadStudentsDataJS() {
            try {
                // Get all data
                const students = JSON.parse(localStorage.getItem('students')) || [];

                if (students.length === 0) {
                    showStatus('âŒ Ù„Ø§ ÙŠÙˆØ¬Ø¯ Ø·Ù„Ø§Ø¨ Ù„ØªØµØ¯ÙŠØ±Ù‡Ù…. Ø£Ø¶Ù Ø·Ù„Ø§Ø¨Ø§Ù‹ Ø£ÙˆÙ„Ø§Ù‹.', 'error');
                    return;
                }

                const currentDate = new Date().toLocaleDateString('ar-EG');

                // Create JS content
                const jsContent = `// Student Data File - Auto-generated
// Last updated: ${currentDate}
// Total students: ${students.length}

const studentsData = ${JSON.stringify(students, null, 2)};

// Export for compatibility
if (typeof module !== 'undefined' && module.exports) {
    module.exports = studentsData;
}
`;

                // Create blob and download
                const blob = new Blob([jsContent], { type: 'text/javascript' });
                const url = URL.createObjectURL(blob);
                const a = document.createElement('a');
                a.href = url;
                a.download = 'students-data.js';
                document.body.appendChild(a);
                a.click();
                document.body.removeChild(a);
                URL.revokeObjectURL(url);

                showStatus('âœ… ØªÙ… ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ù…Ù„Ù! Ù‚Ù… Ø§Ù„Ø¢Ù† Ø¨Ø§Ø³ØªØ¨Ø¯Ø§Ù„ Ø§Ù„Ù…Ù„Ù Ø§Ù„Ù‚Ø¯ÙŠÙ… ÙÙŠ Ù…Ø¬Ù„Ø¯ Ø§Ù„Ù…Ø´Ø±ÙˆØ¹ Ø¨Ù‡Ø°Ø§ Ø§Ù„Ù…Ù„Ù.', 'success');
            } catch (error) {
                console.error('âŒ Error generating JS file:', error);
                showStatus('âŒ Ø­Ø¯Ø« Ø®Ø·Ø£ Ø£Ø«Ù†Ø§Ø¡ Ø¥Ù†Ø´Ø§Ø¡ Ø§Ù„Ù…Ù„Ù', 'error');
            }
        }
    </script>
</body>

</html>